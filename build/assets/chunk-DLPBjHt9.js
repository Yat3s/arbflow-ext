var Ye=Object.defineProperty;var qe=(t,e,s)=>e in t?Ye(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var se=(t,e,s)=>qe(t,typeof e!="symbol"?e+"":e,s);import{j as n,r as d,c as Xe,R as Je}from"./chunk-CYil5rA3.js";import{A as Qe,S as je,D as Ce,a as Le,b as Oe,E as fe,M as Ze,c as et,d as Ne}from"./chunk-CgcjkoXT.js";const te="https://mainnet.zklighter.elliot.ai",tt="wss://mainnet.zklighter.elliot.ai/stream",oe={ORDER_TYPE_LIMIT:0,ORDER_TYPE_MARKET:1,ORDER_TIME_IN_FORCE_IMMEDIATE_OR_CANCEL:0,ORDER_TIME_IN_FORCE_GOOD_TILL_TIME:1,NIL_TRIGGER_PRICE:0,DEFAULT_28_DAY_ORDER_EXPIRY:-1,DEFAULT_IOC_EXPIRY:0},st={ETH:{id:0,sizeDecimals:4,priceDecimals:2},BTC:{id:1,sizeDecimals:5,priceDecimals:1},SOL:{id:2,sizeDecimals:3,priceDecimals:3},DOGE:{id:3,sizeDecimals:0,priceDecimals:6},"1000PEPE":{id:4,sizeDecimals:0,priceDecimals:6},WIF:{id:5,sizeDecimals:1,priceDecimals:5},WLD:{id:6,sizeDecimals:1,priceDecimals:5},XRP:{id:7,sizeDecimals:0,priceDecimals:6},LINK:{id:8,sizeDecimals:1,priceDecimals:5},AVAX:{id:9,sizeDecimals:2,priceDecimals:4},NEAR:{id:10,sizeDecimals:1,priceDecimals:5},DOT:{id:11,sizeDecimals:1,priceDecimals:5},TON:{id:12,sizeDecimals:1,priceDecimals:5},TAO:{id:13,sizeDecimals:3,priceDecimals:3},POL:{id:14,sizeDecimals:0,priceDecimals:6},TRUMP:{id:15,sizeDecimals:2,priceDecimals:4},SUI:{id:16,sizeDecimals:1,priceDecimals:5},"1000SHIB":{id:17,sizeDecimals:0,priceDecimals:6},"1000BONK":{id:18,sizeDecimals:0,priceDecimals:6},"1000FLOKI":{id:19,sizeDecimals:0,priceDecimals:6},BERA:{id:20,sizeDecimals:1,priceDecimals:5},FARTCOIN:{id:21,sizeDecimals:1,priceDecimals:5},AI16Z:{id:22,sizeDecimals:1,priceDecimals:5},POPCAT:{id:23,sizeDecimals:1,priceDecimals:5},HYPE:{id:24,sizeDecimals:2,priceDecimals:4},BNB:{id:25,sizeDecimals:2,priceDecimals:4},JUP:{id:26,sizeDecimals:1,priceDecimals:5},AAVE:{id:27,sizeDecimals:3,priceDecimals:3},MKR:{id:28,sizeDecimals:4,priceDecimals:2},ENA:{id:29,sizeDecimals:1,priceDecimals:5},UNI:{id:30,sizeDecimals:2,priceDecimals:4},APT:{id:31,sizeDecimals:2,priceDecimals:4},SEI:{id:32,sizeDecimals:1,priceDecimals:5},KAITO:{id:33,sizeDecimals:1,priceDecimals:5},IP:{id:34,sizeDecimals:2,priceDecimals:4},LTC:{id:35,sizeDecimals:3,priceDecimals:3},CRV:{id:36,sizeDecimals:1,priceDecimals:5},PENDLE:{id:37,sizeDecimals:2,priceDecimals:4},ONDO:{id:38,sizeDecimals:1,priceDecimals:5},ADA:{id:39,sizeDecimals:1,priceDecimals:5},S:{id:40,sizeDecimals:1,priceDecimals:5},VIRTUAL:{id:41,sizeDecimals:1,priceDecimals:5},SPX:{id:42,sizeDecimals:1,priceDecimals:5},TRX:{id:43,sizeDecimals:1,priceDecimals:5},ARB:{id:50,sizeDecimals:1,priceDecimals:5},OP:{id:55,sizeDecimals:1,priceDecimals:5},BCH:{id:58,sizeDecimals:3,priceDecimals:3},HBAR:{id:59,sizeDecimals:1,priceDecimals:5},TIA:{id:67,sizeDecimals:1,priceDecimals:5},XMR:{id:77,sizeDecimals:3,priceDecimals:3},PYTH:{id:78,sizeDecimals:1,priceDecimals:5},ZEC:{id:90,sizeDecimals:3,priceDecimals:3},XAU:{id:92,sizeDecimals:4,priceDecimals:2},XAG:{id:93,sizeDecimals:2,priceDecimals:4},ICP:{id:102,sizeDecimals:2,priceDecimals:4},FIL:{id:103,sizeDecimals:1,priceDecimals:5},STRK:{id:104,sizeDecimals:1,priceDecimals:5},NVDA:{id:110,sizeDecimals:3,priceDecimals:3},TSLA:{id:112,sizeDecimals:4,priceDecimals:2},AAPL:{id:113,sizeDecimals:3,priceDecimals:3},AMZN:{id:114,sizeDecimals:3,priceDecimals:3},MSFT:{id:115,sizeDecimals:4,priceDecimals:2},GOOGL:{id:116,sizeDecimals:4,priceDecimals:2},META:{id:117,sizeDecimals:4,priceDecimals:2}};let Pe=!1,ge=null;function nt(){return new Promise((t,e)=>{if(typeof window.Go<"u"){t();return}const s=document.createElement("script");s.src=chrome.runtime.getURL("wasm_exec.js"),s.onload=()=>t(),s.onerror=()=>e(new Error("Failed to load wasm_exec.js")),document.head.appendChild(s)})}async function Ue(){if(!Pe)return ge||(ge=(async()=>{if(await nt(),typeof window.Go>"u")throw new Error("wasm_exec.js loaded but Go is not defined");const t=new window.Go,e=chrome.runtime.getURL("lighter-signer.wasm"),a=await(await fetch(e)).arrayBuffer(),r=await WebAssembly.instantiate(a,t.importObject);t.run(r.instance),await new Promise(i=>setTimeout(i,200));const o=["CreateClient","SignCreateOrder","SignCancelOrder","SignCancelAllOrders","GenerateAPIKey","CreateAuthToken"].filter(i=>typeof window[i]=="function");if(console.log("[LighterAPI] Available WASM functions:",o),o.length===0)throw new Error("No WASM functions registered after initialization");Pe=!0,console.log("[LighterAPI] WASM signer initialized (global)")})(),ge)}class rt{constructor(){se(this,"clientCreated",!1);se(this,"config",null)}async initialize(){await Ue()}async createClient(e){await this.initialize();const{url:s,privateKey:a,accountIndex:r,apiKeyIndex:o}=e,i=s.includes("mainnet")?304:300;if(typeof window.CreateClient!="function")throw new Error("WASM CreateClient function not available");console.log("[LighterAPI] Creating client with:",{url:s,chainId:i,apiKeyIndex:o,accountIndex:r});const u=window.CreateClient(s,a,i,o,r);if(console.log("[LighterAPI] CreateClient result:",JSON.stringify(u),typeof u),u){if(typeof u=="object"){const w=u.err||u.error||u.Error||u.message;if(w)throw new Error(`Failed to create client: ${w}`)}else if(typeof u=="string"&&u!=="")throw new Error(`Failed to create client: ${u}`)}this.clientCreated=!0,this.config=e,console.log("[LighterAPI] Client created for account:",r)}signCreateOrder(e){if(!this.clientCreated)throw new Error("Client not created. Call createClient first.");if(typeof window.SignCreateOrder!="function")throw new Error("WASM SignCreateOrder function not available");const{marketIndex:s,clientOrderIndex:a,baseAmount:r,price:o,isAsk:i,orderType:u,timeInForce:w,reduceOnly:j=!1,triggerPrice:T=0,orderExpiry:A=-1,nonce:$,apiKeyIndex:N,accountIndex:E}=e,P=[s,a,r,o,i?1:0,u,w,j?1:0,T,A,$,N,E];console.log("[LighterAPI] SignCreateOrder args:",P.map((v,O)=>`${O}: ${v} (${typeof v})`));const h=window.SignCreateOrder(...P);if(console.log("[LighterAPI] SignCreateOrder raw result:",JSON.stringify(h)),h.err||h.error)throw new Error(h.err||h.error);return{txType:h.txType??14,txInfo:h.txInfo??"",txHash:h.txHash??""}}signCancelOrder(e){if(!this.clientCreated)throw new Error("Client not created. Call createClient first.");if(typeof window.SignCancelOrder!="function")throw new Error("WASM SignCancelOrder function not available");const{marketIndex:s,orderIndex:a,nonce:r,apiKeyIndex:o,accountIndex:i}=e,u=window.SignCancelOrder(s,a,r,o,i);if(u.err)throw new Error(u.err);return{txType:u.txType,txInfo:u.txInfo,txHash:u.txHash}}createAuthToken(e,s,a){if(typeof window.CreateAuthToken!="function")throw new Error("WASM CreateAuthToken function not available");const r=window.CreateAuthToken(e,s,a);if(r.err)throw new Error(r.err);return r.str||""}}class ot{constructor(){se(this,"signer",new rt);se(this,"config",null);se(this,"accountIndex",null);se(this,"marketsCache",null);se(this,"cachedNonce",null);se(this,"lastNonceTime",0)}async initialize(e){return this.config=e,e.accountIndex===null||e.accountIndex===void 0?this.accountIndex=await this.getAccountIndexByL1Address(e.l1Address):this.accountIndex=e.accountIndex,await this.signer.initialize(),await this.signer.createClient({url:te,privateKey:e.apiPrivateKey,accountIndex:this.accountIndex,apiKeyIndex:e.apiKeyIndex}),this.accountIndex}async getAccountIndexByL1Address(e){const a=await(await fetch(`${te}/api/v1/accountsByL1Address?l1_address=${e}`)).json();if(a.code!==200)throw new Error(`API error: ${a.message||"Unknown error"}`);const r=a.sub_accounts||a.accounts||[];if(r.length===0)throw new Error(`No account found for wallet: ${e}`);const o=r.find(i=>i.account_type===0)||r[0];return o.index||o.account_index}async getMarkets(){if(this.marketsCache)return this.marketsCache;const s=await(await fetch(`${te}/api/v1/orderBooks`)).json();this.marketsCache={};for(const a of s.order_books||[])this.marketsCache[a.symbol]={id:a.market_id,sizeDecimals:a.supported_size_decimals,priceDecimals:a.supported_price_decimals,minBaseAmount:a.min_base_amount};return this.marketsCache}async getOrderbook(e){const a=(await this.getMarkets())[e.toUpperCase()];if(!a)throw new Error(`Unknown symbol: ${e}`);return(await fetch(`${te}/api/v1/orderBookOrders?market_id=${a.id}&limit=10`)).json()}async getNextNonce(e=!1){var o;const s=Date.now();if(!e&&this.cachedNonce!==null&&s-this.lastNonceTime<3e4)return this.cachedNonce;const r=await(await fetch(`${te}/api/v1/nextNonce?account_index=${this.accountIndex}&api_key_index=${(o=this.config)==null?void 0:o.apiKeyIndex}`)).json();return this.cachedNonce=r.nonce,this.lastNonceTime=s,r.nonce}incrementNonce(){this.cachedNonce!==null&&this.cachedNonce++}async getAccountInfo(){var a;const s=await(await fetch(`${te}/api/v1/account?by=index&value=${this.accountIndex}`)).json();return((a=s.accounts)==null?void 0:a[0])||s}async sendTransaction(e,s){console.log("[LighterAPI] Sending tx:",{txType:e,txInfoLength:s==null?void 0:s.length});const r=await(await fetch(`${te}/api/v1/sendTx`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`tx_type=${e}&tx_info=${encodeURIComponent(s)}`})).json();return console.log("[LighterAPI] SendTx response:",JSON.stringify(r)),r}async waitForTransaction(e,s=1e4,a=200){var o;const r=Date.now();for(;Date.now()-r<s;){try{const u=await(await fetch(`${te}/api/v1/tx?by=hash&value=${e}`)).json();if(u.code===200&&((o=u.txs)==null?void 0:o.length)>0){const w=u.txs[0];if(w.status>=2)return w}}catch(i){console.log("[LighterAPI] Poll error:",i.message)}await new Promise(i=>setTimeout(i,a))}throw new Error("Transaction timeout")}async createMarketOrder(e,s,a,r={}){var v,O,F,R;const o=performance.now(),{fast:i=!0}=r,u=st[e.toUpperCase()];if(!u)throw new Error(`Unknown symbol: ${e}`);const w=s.toLowerCase()==="sell",j=Math.floor(a*Math.pow(10,u.sizeDecimals));let T,A,$;if(i)A=await this.getNextNonce(),$=performance.now(),console.log(`[LighterAPI] getNonce: ${($-o).toFixed(0)}ms`),T=w?1:Math.pow(10,u.priceDecimals+7),console.log(`[LighterAPI] Fast ${s} order: ${a} ${e}`);else{const[b,M]=await Promise.all([this.getOrderbook(e),this.getNextNonce()]);A=M,$=performance.now(),console.log(`[LighterAPI] getOrderbook + getNonce: ${($-o).toFixed(0)}ms`);const G=b,U=w?(O=(v=G.bids)==null?void 0:v[0])==null?void 0:O.price:(R=(F=G.asks)==null?void 0:F[0])==null?void 0:R.price;if(!U)throw new Error(`No ${w?"bids":"asks"} in orderbook`);const K=parseFloat(U);T=Math.floor(K*(w?.995:1.005)*Math.pow(10,u.priceDecimals)),console.log(`[LighterAPI] Creating ${s} order: ${a} ${e} @ ~$${K}`)}const N=this.signer.signCreateOrder({marketIndex:u.id,clientOrderIndex:Date.now(),baseAmount:j,price:T,isAsk:w,orderType:oe.ORDER_TYPE_MARKET,timeInForce:oe.ORDER_TIME_IN_FORCE_IMMEDIATE_OR_CANCEL,reduceOnly:!1,triggerPrice:oe.NIL_TRIGGER_PRICE,orderExpiry:oe.DEFAULT_IOC_EXPIRY,nonce:A,apiKeyIndex:this.config.apiKeyIndex,accountIndex:this.accountIndex}),E=performance.now();console.log(`[LighterAPI] signOrder: ${(E-$).toFixed(0)}ms`);const P=await this.sendTransaction(N.txType,N.txInfo),h=performance.now();if(console.log(`[LighterAPI] sendTransaction: ${(h-E).toFixed(0)}ms`),console.log(`[LighterAPI] Total: ${(h-o).toFixed(0)}ms`),P.code!==200)throw new Error(P.message||"Transaction failed");return this.incrementNonce(),{success:!0,txHash:P.tx_hash||"submitted",status:"submitted",blockHeight:null}}async createLimitOrder(e,s,a,r){const i=(await this.getMarkets())[e.toUpperCase()];if(!i)throw new Error(`Unknown symbol: ${e}`);const u=s.toLowerCase()==="sell",w=Math.floor(r*Math.pow(10,i.priceDecimals)),j=Math.floor(a*Math.pow(10,i.sizeDecimals)),T=await this.getNextNonce();console.log(`[LighterAPI] Creating limit ${s} order: ${a} ${e} @ $${r}`);const A=this.signer.signCreateOrder({marketIndex:i.id,clientOrderIndex:Date.now(),baseAmount:j,price:w,isAsk:u,orderType:oe.ORDER_TYPE_LIMIT,timeInForce:oe.ORDER_TIME_IN_FORCE_GOOD_TILL_TIME,reduceOnly:!1,triggerPrice:oe.NIL_TRIGGER_PRICE,orderExpiry:oe.DEFAULT_28_DAY_ORDER_EXPIRY,nonce:T,apiKeyIndex:this.config.apiKeyIndex,accountIndex:this.accountIndex}),$=await this.sendTransaction(A.txType,A.txInfo);if($.code!==200)throw new Error($.message||"Transaction failed");const N=await this.waitForTransaction($.tx_hash);return{success:!0,txHash:$.tx_hash,status:N.status,blockHeight:N.block_height}}}async function ze(t,e="main"){const a=await(await fetch(`${te}/api/v1/accountsByL1Address?l1_address=${t}`)).json();if(a.code!==200)throw new Error(a.message||"API error");const r=a.sub_accounts||a.accounts||[];if(r.length===0)throw new Error("No accounts found for wallet");if(console.log("[Lighter] Account list:"),r.forEach((i,u)=>{const w=i.account_type===0?"Main":"Sub",j=i.index??i.account_index;console.log(`  ${u+1}. ${w} - Account Index: ${j}`)}),e==="sub"){const i=r.find(u=>u.account_type!==0);if(!i)throw new Error("No sub-account found");return i.index??i.account_index}const o=r.find(i=>i.account_type===0)||r[0];return o.index??o.account_index}async function at(t,e,s){if(await Ue(),typeof window.CreateClient!="function")throw new Error("WASM CreateClient not available");const r=window.CreateClient(te,t,304,e,s);if(r&&typeof r=="object"&&(r.err||r.error))throw new Error(r.err||r.error||"Failed to create client");if(typeof window.CreateAuthToken!="function")throw new Error("WASM CreateAuthToken not available");const o=Math.floor(Date.now()/1e3)+3600,i=window.CreateAuthToken(o,e,s);if(i.err)throw new Error(i.err);const u=i.authToken||i.str;if(!u)throw new Error("CreateAuthToken returned empty token");return u}function it({exchange:t,symbolStates:e,onOpen:s,onFocus:a,onRefresh:r}){const o=!!t.currentUrl,i=e.reduce((u,w)=>u+w.positions.filter(j=>j.exchangeId===t.id&&j.position!==0).length,0);return n.jsxs("div",{className:`rounded-lg border p-3 ${o?"border-border bg-card":"border-muted bg-muted/30"}`,children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("span",{className:"rounded px-1.5 py-0.5 text-xs font-medium text-white",style:{backgroundColor:t.color},children:t.id}),n.jsx("span",{className:"font-medium",children:t.name}),t.currentSymbol&&n.jsx("span",{className:"text-xs text-muted-foreground",children:t.currentSymbol}),i>0&&n.jsxs("span",{className:"text-xs text-primary",children:[i," ä»“"]})]}),n.jsxs("div",{className:"flex items-center gap-1",children:[o&&n.jsxs(n.Fragment,{children:[n.jsx("button",{onClick:a,className:"rounded p-1 text-muted-foreground hover:bg-accent hover:text-foreground",title:"Focus",children:"âŽ‹"}),n.jsx("button",{onClick:r,className:"rounded p-1 text-muted-foreground hover:bg-accent hover:text-foreground",title:"Refresh",children:"â†»"})]}),n.jsx("span",{className:`h-2 w-2 rounded-full ${t.wsConnected?"bg-green-500":"bg-muted-foreground"}`,title:`WebSocket: ${t.wsConnected?"Connected":"Disconnected"}`})]})]}),n.jsxs("div",{className:"mt-2 space-y-1",children:[o?n.jsx("div",{className:"truncate text-xs text-muted-foreground",title:t.currentUrl,children:t.currentUrl}):n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-sm text-muted-foreground",children:"Page not open"}),n.jsx("button",{onClick:s,className:"rounded bg-primary px-3 py-1 text-xs text-primary-foreground hover:bg-primary/90",children:"Open"})]}),t.accountInfo&&n.jsxs("div",{className:"flex items-center gap-2 font-mono text-xs text-muted-foreground",children:[t.accountInfo.walletAddress&&n.jsxs("span",{className:"truncate",title:t.accountInfo.walletAddress,children:[t.accountInfo.walletAddress.slice(0,6),"...",t.accountInfo.walletAddress.slice(-4)]}),t.accountInfo.portfolioValue!=null&&n.jsxs("span",{className:"text-green-500",children:["$",t.accountInfo.portfolioValue.toFixed(2),t.accountInfo.leverage!=null&&n.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",t.accountInfo.leverage.toFixed(2),"x)"]})]})]})]})]})}function ct({open:t,onClose:e,watchedSymbols:s,onSaveSymbols:a,lighterConfig:r,onSaveLighterConfig:o}){const[i,u]=d.useState(new Set),[w,j]=d.useState(""),[T,A]=d.useState(""),[$,N]=d.useState(""),[E,P]=d.useState(4),[h,v]=d.useState("main"),[O,F]=d.useState(!1),[R,b]=d.useState(null),[M,G]=d.useState(!1);d.useEffect(()=>{t&&(u(new Set(s)),A(r.l1Address),N(r.apiPrivateKey),P(r.apiKeyIndex),v(r.accountType),j(""),b(null))},[t,s,r]);const U=Qe.filter(_=>_.toLowerCase().includes(w.toLowerCase())),K=_=>{const l=new Set(i);l.has(_)?l.delete(_):l.add(_),u(l)},H=async()=>{if(a(Array.from(i)),(T!==r.l1Address||$!==r.apiPrivateKey||E!==r.apiKeyIndex||h!==r.accountType)&&T&&$){G(!0),b({message:"Fetching account info...",isError:!1});const l=await o({l1Address:T,apiPrivateKey:$,apiKeyIndex:E,accountType:h});G(!1),l.success?b({message:`âœ“ Saved, ${h==="main"?"Main Account":"Sub Account"}: ${l.accountIndex}`,isError:!1}):b({message:`âœ— Failed: ${l.error}`,isError:!0})}else e()};return t?n.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",onClick:e,children:n.jsxs("div",{className:"max-h-[90vh] w-[90vw] max-w-md overflow-hidden rounded-lg bg-background shadow-xl",onClick:_=>_.stopPropagation(),children:[n.jsxs("div",{className:"flex items-center justify-between border-b px-4 py-3",children:[n.jsx("h2",{className:"font-semibold",children:"Settings"}),n.jsx("button",{onClick:e,className:"text-muted-foreground hover:text-foreground",children:"âœ•"})]}),n.jsxs("div",{className:"max-h-[60vh] overflow-y-auto p-4",children:[n.jsxs("div",{className:"mb-4",children:[n.jsxs("h3",{className:"mb-2 font-medium",children:["Watched Symbols (",i.size,")"]}),n.jsx("input",{type:"text",placeholder:"Search...",value:w,onChange:_=>j(_.target.value),className:"mb-2 w-full rounded border bg-background px-3 py-2 text-sm"}),n.jsx("div",{className:"grid max-h-40 grid-cols-4 gap-1 overflow-y-auto",children:U.map(_=>n.jsx("button",{onClick:()=>K(_),className:`rounded px-2 py-1 text-xs ${i.has(_)?"bg-primary text-primary-foreground":"bg-muted hover:bg-muted/80"}`,children:_},_))})]}),n.jsxs("div",{className:"border-t pt-4",children:[n.jsx("h3",{className:"mb-2 font-medium",children:"Lighter API Config"}),n.jsxs("div",{className:"space-y-3",children:[n.jsxs("div",{children:[n.jsx("label",{className:"mb-1 block text-xs text-muted-foreground",children:"Wallet Address"}),n.jsx("input",{type:"text",value:T,onChange:_=>A(_.target.value),placeholder:"0x...",className:"w-full rounded border bg-background px-3 py-2 text-sm"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"mb-1 block text-xs text-muted-foreground",children:"API Private Key"}),n.jsxs("div",{className:"flex gap-2",children:[n.jsx("input",{type:O?"text":"password",value:$,onChange:_=>N(_.target.value),placeholder:"Private key...",className:"flex-1 rounded border bg-background px-3 py-2 text-sm"}),n.jsx("button",{onClick:()=>F(!O),className:"rounded border px-2 text-sm",children:O?"ðŸ™ˆ":"ðŸ‘"})]})]}),n.jsxs("div",{className:"flex gap-2",children:[n.jsxs("div",{className:"flex-1",children:[n.jsx("label",{className:"mb-1 block text-xs text-muted-foreground",children:"API Key Index"}),n.jsx("input",{type:"number",value:E,onChange:_=>P(parseInt(_.target.value)||4),className:"w-full rounded border bg-background px-3 py-2 text-sm"})]}),n.jsxs("div",{className:"flex-1",children:[n.jsx("label",{className:"mb-1 block text-xs text-muted-foreground",children:"Account Type"}),n.jsxs("select",{value:h,onChange:_=>v(_.target.value),className:"w-full rounded border bg-background px-3 py-2 text-sm",children:[n.jsx("option",{value:"main",children:"Main"}),n.jsx("option",{value:"sub",children:"Sub"})]})]})]}),r.accountIndex!==null&&n.jsxs("div",{className:"text-xs text-muted-foreground",children:["Account Index: ",r.accountIndex]}),R&&n.jsx("div",{className:`text-xs ${R.isError?"text-red-500":"text-green-500"}`,children:R.message})]})]})]}),n.jsxs("div",{className:"flex justify-end gap-2 border-t px-4 py-3",children:[n.jsx("button",{onClick:e,className:"rounded border px-4 py-2 text-sm hover:bg-muted",children:"Cancel"}),n.jsx("button",{onClick:H,disabled:M,className:"rounded bg-primary px-4 py-2 text-sm text-primary-foreground hover:bg-primary/90 disabled:opacity-50",children:M?"Saving...":"Save"})]})]})}):null}const lt=5e3;function he(t){if(!t)return{skew:!1,timeStr:"--:--:--"};const e=new Date(t),s=String(e.getHours()).padStart(2,"0"),a=String(e.getMinutes()).padStart(2,"0"),r=String(e.getSeconds()).padStart(2,"0"),o=`${s}:${a}:${r}`;return{skew:Math.abs(Date.now()-t)>lt,timeStr:o}}function Fe(t,e){if(!t||t===0)return"--";const s=e??t;return Math.abs(s)>=1e3?t.toFixed(2):Math.abs(s)>=10?t.toFixed(3):Math.abs(s)>=1?t.toFixed(4):t.toFixed(6)}function We(t,e){const s=t*100;return`${e!=null&&e.showSign&&s>=0?"+":""}${s.toFixed(1)}bp`}function Re({label:t,spread:e,refPrice:s,platform1LastUpdated:a,platform2LastUpdated:r,onExecute:o,monitorUnit:i,monitorThreshold:u,isMonitoring:w,isAnyMonitoring:j,canStartMonitor:T,onMonitorUnitToggle:A,onMonitorThresholdChange:$,onMonitorToggle:N,rebalanceInfo:E,entrySpread:P}){const[h,v]=d.useState(!1),O=e/s*100,F=e>=0?"+":"",R=e>0;return n.jsxs("div",{className:"flex flex-col gap-2 rounded px-3 py-2 bg-muted-foreground/10 text-xs ",children:[n.jsxs("div",{className:"flex items-center gap-2 justify-between",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("span",{className:"font-semibold shrink-0 font-mono text-muted-foreground text-lg",children:t}),n.jsxs("span",{className:"text-2xl font-semibold shrink-0 whitespace-nowrap text-white",children:[F,Fe(e,s),n.jsxs("span",{className:"text-xs font-mono font-normal",children:["(",We(O,{showSign:!0}),P!=null&&(()=>{const b=P+e,M=b>=0?"+":"";return n.jsxs("span",{className:(b>=0,""),children:[", æ‰§è¡Œ",M,b.toFixed(3),"u"]})})(),")"]})]})]}),(()=>{const b=he(a),M=he(r);return!b.skew&&!M.skew?null:n.jsxs("span",{className:"shrink-0 text-muted-foreground text-xs",children:[b.skew?`âš ï¸${b.timeStr}`:"",b.skew&&M.skew?"/":"",M.skew?`âš ï¸${M.timeStr}`:""]})})()]}),n.jsxs("div",{className:"flex items-center justify-between gap-2",children:[n.jsxs("div",{className:"flex items-center gap-1",children:["å½“ä»·å·®",n.jsx("button",{onClick:A,disabled:w,className:`rounded bg-muted px-1.5 py-0.5 font-mono ${w?"cursor-not-allowed opacity-50":"hover:bg-muted/80"}`,children:i==="bps"?"bp":"U"}),n.jsx("span",{className:"font-mono",children:">"}),n.jsx("input",{type:"text",value:u,onChange:b=>$(b.target.value),disabled:w,className:`w-12 rounded border border-border bg-background px-1 py-0.5 text-center ${w?"cursor-not-allowed opacity-50":""}`,placeholder:i==="bps"?"bp":"U"}),n.jsx("button",{onClick:N,disabled:!w&&!T,className:`rounded px-1.5 py-0.5 ${w?"cursor-pointer bg-yellow-500 text-black":T?"cursor-pointer bg-muted text-muted-foreground hover:bg-muted/80":"cursor-not-allowed bg-muted/50 text-muted-foreground/50"}`,children:w?"åœæ­¢":"å¼€å¯ç›‘æŽ§äº¤æ˜“"})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[E&&n.jsxs("div",{className:"relative",children:[n.jsxs("button",{onClick:()=>v(!0),className:"cursor-pointer shrink-0 rounded bg-yellow-500/20 px-1.5 py-0.5 text-yellow-500 hover:bg-yellow-500/30",children:[E.action,E.platformId,"è¡¥é½(",E.size.toFixed(4),")"]}),h&&n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>v(!1)}),n.jsxs("div",{className:"absolute bottom-full right-0 z-50 mb-2 rounded-lg border border-border bg-background p-3 shadow-lg",children:[n.jsxs("p",{className:"mb-2 whitespace-nowrap text-sm",children:["ç¡®è®¤åœ¨ ",E.platformId," ",E.action==="+"?"ä¹°å…¥":"å–å‡º"," ",E.size.toFixed(4),"?"]}),n.jsxs("div",{className:"flex justify-end gap-2",children:[n.jsx("button",{onClick:()=>v(!1),className:"cursor-pointer rounded bg-muted px-2 py-1 text-muted-foreground hover:bg-muted/80",children:"å–æ¶ˆ"}),n.jsx("button",{onClick:()=>{E.onRebalance(),v(!1)},className:"cursor-pointer rounded bg-yellow-500 px-2 py-1 text-black hover:bg-yellow-400",children:"ç¡®è®¤è¡¥é½"})]})]})]})]}),n.jsx("button",{onClick:o,className:"cursor-pointer shrink-0 text-muted-foreground hover:text-white",children:"ç«‹å³æ‰§è¡Œ1æ¬¡"})]})]})]})}function dt({message:t,isSuccess:e,duration:s=3e3}){const[a,r]=d.useState(!1);return d.useEffect(()=>{if(t){r(!0);const o=setTimeout(()=>{r(!1)},s);return()=>clearTimeout(o)}},[t,s]),!a||!t?null:n.jsx("div",{className:`fixed bottom-4 left-1/2 -translate-x-1/2 rounded-lg px-4 py-2 text-sm shadow-lg transition-all ${e?"bg-green-600 text-white":"bg-red-600 text-white"}`,children:t})}const ut="/assets/ding-C-5Q8E1-.mp3",mt="/assets/warn-NHXt42wg.wav";function be(t,e){var o;if(!t||t.length===0)return null;if(e<=0)return((o=t[0])==null?void 0:o.price)??null;let s=e,a=0,r=0;for(const i of t){const u=Math.min(s,i.quantity);if(a+=u*i.price,r+=u,s-=u,s<=0)break}return r===0?null:a/r}function pt(t,e,s){var A,$,N,E;if(t.length<2)return null;const a=t[0],r=t[1],o=be(((A=a==null?void 0:a.orderBook)==null?void 0:A.asks)||[],s),i=be((($=a==null?void 0:a.orderBook)==null?void 0:$.bids)||[],s),u=be(((N=r==null?void 0:r.orderBook)==null?void 0:N.asks)||[],s),w=be(((E=r==null?void 0:r.orderBook)==null?void 0:E.bids)||[],s);if(!o||!i||!u||!w)return null;const j=e.find(P=>P.id===a.exchangeId),T=e.find(P=>P.id===r.exchangeId);return{platform1Id:a.exchangeId,platform2Id:r.exchangeId,platform1Name:(j==null?void 0:j.name)||a.exchangeId,platform2Name:(T==null?void 0:T.name)||r.exchangeId,platform1Color:(j==null?void 0:j.color)||"#6366f1",platform2Color:(T==null?void 0:T.color)||"#f59e0b",spread1to2:w-o,spread2to1:i-u,platform1Ask:o,platform2Ask:u,platform1Bid:i,platform2Bid:w,platform1LastUpdated:a.lastUpdated,platform2LastUpdated:r.lastUpdated}}const Ge="arbflow_symbol_";function ft(t){try{const e=localStorage.getItem(`${Ge}${t}`);return e?JSON.parse(e):null}catch{return null}}function ht(t,e){try{localStorage.setItem(`${Ge}${t}`,JSON.stringify(e))}catch{}}function xt({priceDiff:t,tradeSize:e,setTradeSize:s,positionMin:a,setPositionMin:r,positionMax:o,setPositionMax:i,tradeInterval:u,setTradeInterval:w,monitor2to1:j,setMonitor2to1:T,monitor1to2:A,setMonitor1to2:$,tradeLogs:N,setTradeLogs:E,onExecute:P,positionByExchange:h,onRebalance:v,entrySpread:O,shortExchangeId:F}){const R=c=>c.trim()!==""&&!isNaN(Number(c)),b=R(e)&&R(a)&&R(o),M=b&&R(j.threshold),G=b&&R(A.threshold),U=j.isMonitoring||A.isMonitoring,K=h[t.platform1Id]||0,H=h[t.platform2Id]||0,_=K+H,l=Math.abs(_)>1e-4,p=parseFloat(a)||0,I=parseFloat(o)||0,m=c=>Math.round(c*1e4)/1e4,g=c=>{if(!l)return;const C=m(Math.abs(_)),S=_<0?"+":"-",f=_<0?"long":"short";if(c===t.platform1Id){const x=f==="long"?C:-C,L=K+x;if(L<p||L>I)return}return{platformId:c,size:C,action:S,onRebalance:()=>v(c,C,f)}};return n.jsxs("div",{className:"mt-6 space-y-3",children:[n.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[n.jsx("span",{className:"flex-1 h-px bg-muted-foreground/40"}),"è‡ªåŠ¨äº¤æ˜“è®¾ç½®",n.jsx("span",{className:"flex-1 h-px bg-muted-foreground/40"})]}),n.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[n.jsx("label",{className:"text-xs text-muted-foreground",children:"Step size:"}),n.jsxs("div",{className:"relative",children:[n.jsx("input",{type:"number",value:e,onChange:c=>s(c.target.value),disabled:U,step:"0.01",min:"0",className:`w-10 border-b border-muted-foreground/40 bg-transparent px-1 py-0.5 text-xs outline-none focus:border-muted-foreground [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none ${U?"cursor-not-allowed opacity-50":""}`}),e&&parseFloat(e)>0&&n.jsxs("span",{className:"absolute -top-4 left-0 whitespace-nowrap rounded bg-muted px-1 py-0.5 text-[10px] text-muted-foreground",children:["â‰ˆ",(parseFloat(e)*t.platform1Ask).toFixed(2),"u"]})]}),n.jsxs("span",{className:"text-xs text-muted-foreground",children:[t.platform1Id," Max"]}),n.jsxs("div",{className:"relative",children:[n.jsx("input",{type:"number",value:a,onChange:c=>r(c.target.value),disabled:U,step:"0.01",className:`w-20 border-b border-muted-foreground/40 bg-transparent px-1 py-0.5 text-xs outline-none focus:border-muted-foreground [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none ${U?"cursor-not-allowed opacity-50":""}`,placeholder:"æœ€å°"}),a&&parseFloat(a)!==0&&n.jsxs("span",{className:"absolute -top-4 left-0 whitespace-nowrap rounded bg-muted px-1 py-0.5 text-[10px] text-muted-foreground",children:["â‰ˆ",(Math.abs(parseFloat(a))*t.platform1Ask).toFixed(2),"u"]})]}),n.jsx("span",{className:"text-xs text-muted-foreground",children:"~"}),n.jsxs("div",{className:"relative",children:[n.jsx("input",{type:"number",value:o,onChange:c=>i(c.target.value),disabled:U,step:"0.01",className:`w-20 border-b border-muted-foreground/40 bg-transparent px-1 py-0.5 text-xs outline-none focus:border-muted-foreground [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none ${U?"cursor-not-allowed opacity-50":""}`,placeholder:"æœ€å¤§"}),o&&parseFloat(o)!==0&&n.jsxs("span",{className:"absolute -top-4 left-0 whitespace-nowrap rounded bg-muted px-1 py-0.5 text-[10px] text-muted-foreground",children:["â‰ˆ",(Math.abs(parseFloat(o))*t.platform1Ask).toFixed(2),"u"]})]}),n.jsx("span",{className:"text-xs text-muted-foreground",children:"é—´éš”"}),n.jsx("input",{type:"number",value:u,onChange:c=>w(c.target.value),disabled:U,step:"100",min:"0",className:`w-10 border-b border-muted-foreground/40 bg-transparent px-1 py-0.5 text-xs outline-none focus:border-muted-foreground [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none ${U?"cursor-not-allowed opacity-50":""}`,placeholder:"ms"}),n.jsx("span",{className:"text-xs text-muted-foreground",children:"ms"})]}),n.jsx(Re,{label:`-${t.platform1Id}+${t.platform2Id}`,spread:t.spread2to1,refPrice:t.platform2Ask,platform1LastUpdated:t.platform1LastUpdated,platform2LastUpdated:t.platform2LastUpdated,onExecute:()=>P("2to1"),monitorUnit:j.unit,monitorThreshold:j.threshold,isMonitoring:j.isMonitoring,isAnyMonitoring:U,canStartMonitor:M,onMonitorUnitToggle:()=>T(c=>({...c,unit:c.unit==="bps"?"usdt":"bps"})),onMonitorThresholdChange:c=>T(C=>({...C,threshold:c})),onMonitorToggle:()=>T(c=>({...c,isMonitoring:!c.isMonitoring})),rebalanceInfo:g(t.platform2Id),entrySpread:F===t.platform2Id?O:void 0}),n.jsx(Re,{label:`-${t.platform2Id}+${t.platform1Id}`,spread:t.spread1to2,refPrice:t.platform1Ask,platform1LastUpdated:t.platform1LastUpdated,platform2LastUpdated:t.platform2LastUpdated,onExecute:()=>P("1to2"),monitorUnit:A.unit,monitorThreshold:A.threshold,isMonitoring:A.isMonitoring,isAnyMonitoring:U,canStartMonitor:G,onMonitorUnitToggle:()=>$(c=>({...c,unit:c.unit==="bps"?"usdt":"bps"})),onMonitorThresholdChange:c=>$(C=>({...C,threshold:c})),onMonitorToggle:()=>$(c=>({...c,isMonitoring:!c.isMonitoring})),rebalanceInfo:g(t.platform1Id),entrySpread:F===t.platform1Id?O:void 0}),N.length>0&&n.jsxs("div",{className:"mt-2 max-h-32 overflow-y-auto rounded border border-border bg-muted/30 p-2",children:[n.jsxs("div",{className:"mb-1 flex items-center justify-between",children:[n.jsx("span",{className:"text-xs font-medium text-muted-foreground",children:"äº¤æ˜“æ—¥å¿—"}),n.jsx("button",{onClick:()=>E([]),className:"text-xs text-muted-foreground hover:text-foreground",children:"æ¸…ç©º"})]}),n.jsx("div",{className:"space-y-0.5",children:N.map(c=>{const C=c.timestamp,S=`${String(C.getHours()).padStart(2,"0")}:${String(C.getMinutes()).padStart(2,"0")}:${String(C.getSeconds()).padStart(2,"0")}.${String(C.getMilliseconds()).padStart(3,"0")}`;return n.jsxs("div",{className:"text-xs text-muted-foreground",children:[n.jsxs("span",{className:"text-foreground/60",children:["[",S,"]"]})," ",c.message]},c.id)})})]})]})}function gt({pos:t,exchange:e}){var i;const s=(e==null?void 0:e.color)||"#6366f1",a=t.funding||0;t.unrealizedPnl+a;const r=a>=0?"+":"-",o=t.lastUpdated&&Date.now()-t.lastUpdated>6e4;return n.jsxs("div",{className:"grid grid-cols-[auto_40px_150px_1fr_60px] items-center gap-2 text-[10px]",children:[n.jsx("span",{className:"w-10 text-center px-1.5 py-0.5 text-black font-bold",style:{backgroundColor:s},children:t.exchangeId}),n.jsx("span",{className:`text-muted-foreground ${o?"opacity-50":""}`,children:`${he(t.lastUpdated).timeStr}`}),n.jsxs("span",{className:"text-right",children:[t.side==="long"?"":"-",t.position,"(",(i=t.positionValue)==null?void 0:i.toFixed(2),"u)"]}),n.jsxs("span",{className:"text-muted-foreground",children:["å…¥ ",Fe(t.avgEntryPrice)," / fnd ",r,Math.abs(a).toFixed(2)]})]})}const bt=()=>new Audio(ut).play().catch(()=>{}),wt=()=>new Audio(mt).play().catch(()=>{}),yt="1000",It=5*60*1e3,Nt=3e3,At=4e3,Me=5*60*1e3;function St({symbol:t,symbolState:e,exchanges:s,onDoTrades:a,globalTradeInterval:r,globalLastTradeTimeRef:o,globalLastRefreshTimeRef:i,consecutiveTriggerCount:u,onRefreshAllExchanges:w,autoRebalanceEnabled:j,soundEnabled:T}){var Ee,ve,Te,_e,De;const A=ft(t),[$,N]=d.useState((A==null?void 0:A.tradeSize)??""),[E,P]=d.useState((A==null?void 0:A.positionMin)??""),[h,v]=d.useState((A==null?void 0:A.positionMax)??""),[O,F]=d.useState((A==null?void 0:A.tradeInterval)??yt),[R,b]=d.useState({unit:((Ee=A==null?void 0:A.monitor2to1)==null?void 0:Ee.unit)??"usdt",threshold:((ve=A==null?void 0:A.monitor2to1)==null?void 0:ve.threshold)??"",isMonitoring:!1}),[M,G]=d.useState({unit:((Te=A==null?void 0:A.monitor1to2)==null?void 0:Te.unit)??"usdt",threshold:((_e=A==null?void 0:A.monitor1to2)==null?void 0:_e.threshold)??"",isMonitoring:!1}),[U,K]=d.useState([]),[H,_]=d.useState(!1),l=d.useRef({"2to1":0,"1to2":0}),p=d.useRef({"2to1":0,"1to2":0}),I=d.useRef(null),m=d.useRef(!1),g=d.useRef(!1),c=d.useRef(0),C=d.useRef(0),S=((De=e==null?void 0:e.positions)==null?void 0:De.filter(D=>D.position!==0))||[],f=(e==null?void 0:e.exchangeMarketStats)||[],x=S.length>0,L=[...f].sort((D,k)=>D.exchangeId.localeCompare(k.exchangeId)),z=parseFloat($)||0,y=pt(L,s,z),q=S.reduce((D,k)=>{const W=k.position||0;return D+(k.side==="long"?W:-W)},0),J=Math.abs(q)>1e-4,ie=S.reduce((D,k)=>{if(!k.exchangeId)return D;const W=k.position||0,B=k.side==="long"?W:-W;return D[k.exchangeId]=(D[k.exchangeId]||0)+B,D},{}),ce=R.isMonitoring||M.isMonitoring,Q=(()=>{if(S.length<2)return null;const D=S.find(X=>X.side==="short"),k=S.find(X=>X.side==="long");if(!D||!k)return null;const W=D.avgEntryPrice-k.avgEntryPrice,B=(D.avgEntryPrice+k.avgEntryPrice)/2,V=W/B*100;return{value:W,percent:V,shortExchangeId:D.exchangeId}})(),ee=D=>{c.current+=1,K(k=>[{id:c.current,timestamp:new Date,message:D},...k.slice(0,49)])},ye=d.useCallback(D=>{const k=Date.now(),W=k-i.current;m.current||W<It||(m.current=!0,i.current=k,ee(`[åˆ·æ–°] ${D}ï¼Œæ­£åœ¨åˆ·æ–°äº¤æ˜“æ‰€è¿žæŽ¥...`),w().then(()=>ee("[åˆ·æ–°] äº¤æ˜“æ‰€è¿žæŽ¥å·²åˆ·æ–°")).catch(B=>ee(`[é”™è¯¯] åˆ·æ–°å¤±è´¥: ${B.message}`)).finally(()=>{m.current=!1}))},[w]),Ae=d.useCallback(D=>y?D.reduce((k,W)=>{const B=W.direction==="long"?1:-1;return W.platform===y.platform1Id?k+B*W.size:k},0):0,[y]),le=d.useCallback((D,k)=>{if(!y||D.length===0)return!1;const W=Date.now(),B=parseInt(O)||500,V=parseFloat(E)||0,X=parseFloat(h)||0,ne=ie[y.platform1Id]||0,re=k==null?void 0:k.direction,ae=(k==null?void 0:k.skipPositionCheck)??!1,de=(k==null?void 0:k.skipCooldown)??!1,ue=(k==null?void 0:k.logPrefix)??"[äº¤æ˜“]",pe=Ae(D);if(!ae&&pe!==0){const Z=ne+pe,me=Z>=V&&Z<=X,Ve=ne>X&&pe<0||ne<V&&pe>0;if(!(me||Ve))return!1}if(!de&&re){const Z=W-l.current[re],me=W-o.current;if(Z<B||me<r)return!1;l.current[re]=W,o.current=W}const xe=D.map(Z=>`${Z.direction==="long"?"+":"-"}${Z.platform}`).join("");return ee(`${ue} æ‰§è¡Œä¸­: ${xe} ${D[0].size} ${t}`),a(D).then(()=>{ee(`${ue} å®Œæˆ: ${xe}`),T&&bt()}).catch(Z=>{var me;ee(`[é”™è¯¯] ${xe} äº¤æ˜“å¤±è´¥: ${Z.message}`),T&&wt(),(me=k==null?void 0:k.onError)==null||me.call(k,Z.message,D)}),!0},[y,O,E,h,ie,r,t,a,T,Ae]),Be=(D,k,W)=>{le([{symbol:t,direction:W,size:k,platform:D}],{skipCooldown:!0,logPrefix:"[è¡¥é½]"})},Se=d.useCallback(()=>{var re;if(!j||!y)return;const D=Date.now();if(D-C.current<Me){ee(`[è‡ªåŠ¨è¡¥é½] è·³è¿‡: å†·å´æ—¶é—´å†… (${Math.ceil((Me-(D-C.current))/1e3)}s)`);return}const W=(((re=e==null?void 0:e.positions)==null?void 0:re.filter(ae=>ae.position!==0))||[]).reduce((ae,de)=>{const ue=de.position||0;return ae+(de.side==="long"?ue:-ue)},0);if(Math.abs(W)<=1e-4){ee("[è‡ªåŠ¨è¡¥é½] è·³è¿‡: ä»“ä½å·²å¹³è¡¡");return}const B=Math.round(Math.abs(W)*1e4)/1e4,V=W<0?"long":"short",X={symbol:t,direction:V,size:B,platform:y.platform1Id};ee(`[è‡ªåŠ¨è¡¥é½] å‡€ä»“ä½ ${W.toFixed(4)}ï¼Œåœ¨ ${y.platform1Id} ${V} ${B}`),le([X],{skipCooldown:!0,logPrefix:"[è‡ªåŠ¨è¡¥é½]"})?C.current=Date.now():ee("[è‡ªåŠ¨è¡¥é½] è·³è¿‡: ä»“ä½é™åˆ¶")},[j,y,t,e,le]),Ke=D=>{const k=parseFloat($)||0;if(k<=0||!y){alert("è¯·è¾“å…¥æœ‰æ•ˆçš„äº¤æ˜“æ•°é‡");return}const{platform1Id:W,platform2Id:B}=y;le(D==="2to1"?[{symbol:t,direction:"short",size:k,platform:W},{symbol:t,direction:"long",size:k,platform:B}]:[{symbol:t,direction:"long",size:k,platform:W},{symbol:t,direction:"short",size:k,platform:B}],{skipCooldown:!0,skipPositionCheck:!0})},ke=d.useCallback(()=>{const D={tradeSize:$,positionMin:E,positionMax:h,tradeInterval:O,monitor2to1:{unit:R.unit,threshold:R.threshold},monitor1to2:{unit:M.unit,threshold:M.threshold}};ht(t,D)},[t,$,E,h,O,R,M]);d.useEffect(()=>{ke()},[ke]),d.useEffect(()=>{if(!y)return;const D=Date.now();if(R.isMonitoring||M.isMonitoring){if(J){I.current===null?I.current=D:D-I.current>=Nt&&!g.current&&(g.current=!0,ye(`ä»“ä½ä¸å¯¹é½ (å‡€ä»“ä½: ${q.toFixed(4)})`),setTimeout(()=>{j&&Se(),g.current=!1,I.current=null},At));return}else I.current=null,g.current=!1;const B=he(y.platform1LastUpdated),V=he(y.platform2LastUpdated);if(B.skew||V.skew){const ne=`${B.skew?y.platform1Id:""}${B.skew&&V.skew?"/":""}${V.skew?y.platform2Id:""}`;ye(`ä»·æ ¼æ•°æ®å»¶è¿Ÿ (${ne})`);return}}const k=parseFloat($)||0,W=(B,V,X,ne,re,ae)=>{if(!V.isMonitoring||k<=0){p.current[B]=0;return}const de=parseFloat(V.threshold)||0;(V.unit==="bps"?X/ne*1e4:X)>de?p.current[B]+=1:p.current[B]=0,p.current[B]>=u&&le([{symbol:t,direction:"short",size:k,platform:re},{symbol:t,direction:"long",size:k,platform:ae}],{direction:B})&&(p.current[B]=0)};W("2to1",R,y.spread2to1,y.platform2Ask,y.platform1Id,y.platform2Id),W("1to2",M,y.spread1to2,y.platform1Ask,y.platform2Id,y.platform1Id)},[y,R,M,$,t,J,q,u,ye,j,le,Se]);const He=()=>{if(!ce||!y)return null;const D=[];return R.isMonitoring&&D.push(`-${y.platform1Id}+${y.platform2Id} > ${R.threshold}${R.unit==="bps"?"bp":"u"}`),M.isMonitoring&&D.push(`-${y.platform2Id}+${y.platform1Id} > ${M.threshold}${M.unit==="bps"?"bp":"u"}`),D.join(" | ")};return n.jsxs("div",{className:`rounded-md border p-3 border-dashed ${x?"border-muted-foreground/70":"border-muted-foreground/30"}`,children:[n.jsxs("div",{onClick:()=>_(!H),className:"flex items-center justify-between cursor-pointer",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[je[t]&&n.jsx("img",{src:je[t],alt:t,className:"w-5 h-5 rounded-full"}),n.jsx("span",{className:"text-xl font-medium",children:t}),J&&n.jsx("span",{className:"text-xs text-yellow-600",title:`å‡€ä»“ä½: ${q.toFixed(4)}`,children:"âš  ä»“ä½æœªå¯¹é½"}),H&&ce&&n.jsxs("span",{className:"text-xs text-yellow-500 bg-yellow-500/10 px-1.5 py-0.5 rounded",children:["[ç›‘æŽ§ä¸­] ",He()]})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[Q&&n.jsxs("span",{className:"text-xs text-muted-foreground",children:["å…¥åœºä»·å·®"," ",n.jsxs("span",{className:Q.value>=0?"text-green-500":"text-red-400",children:[Q.value>=0?"+":"",Q.value.toFixed(3),"u(",We(Q.percent,{showSign:!0}),")"]})]}),n.jsx("button",{onClick:D=>{D.stopPropagation(),_(!H)},className:"text-muted-foreground hover:text-foreground transition-colors",children:H?"â–¶":"â–¼"})]})]}),!H&&n.jsxs(n.Fragment,{children:[x&&n.jsx("div",{className:"mt-2 space-y-1",children:S.sort((D,k)=>(D.exchangeId||"").localeCompare(k.exchangeId||"")).map((D,k)=>n.jsx(gt,{pos:D,exchange:s.find(W=>W.id===D.exchangeId)},k))}),y&&n.jsx(xt,{priceDiff:y,tradeSize:$,setTradeSize:N,positionMin:E,setPositionMin:P,positionMax:h,setPositionMax:v,tradeInterval:O,setTradeInterval:F,monitor2to1:R,setMonitor2to1:b,monitor1to2:M,setMonitor1to2:G,tradeLogs:U,setTradeLogs:K,onExecute:Ke,positionByExchange:ie,onRebalance:Be,entrySpread:Q==null?void 0:Q.value,shortExchangeId:Q==null?void 0:Q.shortExchangeId})]})]})}const Y={WATCHED_SYMBOLS:"arbflow_watched_symbols",EXCHANGE_CONFIGS:"arbflow_exchange_configs",GLOBAL_TRADE_INTERVAL:"arbflow_global_trade_interval",CONSECUTIVE_TRIGGER_COUNT:"arbflow_consecutive_trigger_count",AUTO_REBALANCE_ON_ERROR:"arbflow_auto_rebalance_on_error",SOUND_ENABLED:"arbflow_sound_enabled"},kt=1e3,Et=2;function vt(){const[t,e]=d.useState(Ce),[s,a]=d.useState(Le),[r,o]=d.useState(Oe),[i,u]=d.useState(kt),[w,j]=d.useState(Et),[T,A]=d.useState(!1),[$,N]=d.useState(!0);d.useEffect(()=>{const b=localStorage.getItem(Y.WATCHED_SYMBOLS);if(b)try{e(JSON.parse(b))}catch{e(Ce)}const M=localStorage.getItem(Y.EXCHANGE_CONFIGS);if(M)try{const _=JSON.parse(M);_.lighter&&a({...Le,..._.lighter}),_.omni&&o({...Oe,..._.omni})}catch(_){console.error("[Settings] Failed to load configs:",_)}const G=localStorage.getItem(Y.GLOBAL_TRADE_INTERVAL);if(G){const _=parseInt(G,10);!isNaN(_)&&_>0&&u(_)}const U=localStorage.getItem(Y.CONSECUTIVE_TRIGGER_COUNT);if(U){const _=parseInt(U,10);!isNaN(_)&&_>0&&j(_)}const K=localStorage.getItem(Y.AUTO_REBALANCE_ON_ERROR);K&&A(K==="true");const H=localStorage.getItem(Y.SOUND_ENABLED);H&&N(H==="true")},[]);const E=d.useCallback(b=>{e(b),localStorage.setItem(Y.WATCHED_SYMBOLS,JSON.stringify(b))},[]),P=d.useCallback(b=>{a(M=>{const G={...M,...b},U={lighter:G,omni:r};return localStorage.setItem(Y.EXCHANGE_CONFIGS,JSON.stringify(U)),G})},[r]),h=d.useCallback(b=>{o(M=>{const G={...M,...b},U={lighter:s,omni:G};return localStorage.setItem(Y.EXCHANGE_CONFIGS,JSON.stringify(U)),G})},[s]),v=d.useCallback(b=>{u(b),localStorage.setItem(Y.GLOBAL_TRADE_INTERVAL,String(b))},[]),O=d.useCallback(b=>{j(b),localStorage.setItem(Y.CONSECUTIVE_TRIGGER_COUNT,String(b))},[]),F=d.useCallback(b=>{A(b),localStorage.setItem(Y.AUTO_REBALANCE_ON_ERROR,String(b))},[]),R=d.useCallback(b=>{N(b),localStorage.setItem(Y.SOUND_ENABLED,String(b))},[]);return{watchedSymbols:t,saveWatchedSymbols:E,lighterConfig:s,saveLighterConfig:P,omniConfig:r,saveOmniConfig:h,globalTradeInterval:i,saveGlobalTradeInterval:v,consecutiveTriggerCount:w,saveConsecutiveTriggerCount:O,autoRebalanceEnabled:T,saveAutoRebalanceEnabled:F,soundEnabled:$,saveSoundEnabled:R}}function Tt(t){const e=new DataView(t);let s=0;function a(){const r=e.getUint8(s++);if(r<=127)return r;if(r>=128&&r<=143){const o=r&15,i={};for(let u=0;u<o;u++){const w=a();i[String(w)]=a()}return i}if(r>=144&&r<=159){const o=r&15,i=[];for(let u=0;u<o;u++)i.push(a());return i}if(r>=160&&r<=191){const o=r&31,i=new TextDecoder().decode(new Uint8Array(t,s,o));return s+=o,i}if(r===192)return null;if(r===194)return!1;if(r===195)return!0;if(r===196){const o=e.getUint8(s++),i=new Uint8Array(t,s,o);return s+=o,i}if(r===197){const o=e.getUint16(s);s+=2;const i=new Uint8Array(t,s,o);return s+=o,i}if(r===202){const o=e.getFloat32(s);return s+=4,o}if(r===203){const o=e.getFloat64(s);return s+=8,o}if(r===204)return e.getUint8(s++);if(r===205){const o=e.getUint16(s);return s+=2,o}if(r===206){const o=e.getUint32(s);return s+=4,o}if(r===207){const o=e.getUint32(s),i=e.getUint32(s+4);return s+=8,o*4294967296+i}if(r===208)return e.getInt8(s++);if(r===209){const o=e.getInt16(s);return s+=2,o}if(r===210){const o=e.getInt32(s);return s+=4,o}if(r===211){const o=e.getInt32(s),i=e.getUint32(s+4);return s+=8,o*4294967296+i}if(r===217){const o=e.getUint8(s++),i=new TextDecoder().decode(new Uint8Array(t,s,o));return s+=o,i}if(r===218){const o=e.getUint16(s);s+=2;const i=new TextDecoder().decode(new Uint8Array(t,s,o));return s+=o,i}if(r===219){const o=e.getUint32(s);s+=4;const i=new TextDecoder().decode(new Uint8Array(t,s,o));return s+=o,i}if(r===220){const o=e.getUint16(s);s+=2;const i=[];for(let u=0;u<o;u++)i.push(a());return i}if(r===221){const o=e.getUint32(s);s+=4;const i=[];for(let u=0;u<o;u++)i.push(a());return i}if(r===222){const o=e.getUint16(s);s+=2;const i={};for(let u=0;u<o;u++){const w=a();i[String(w)]=a()}return i}if(r===223){const o=e.getUint32(s);s+=4;const i={};for(let u=0;u<o;u++){const w=a();i[String(w)]=a()}return i}return r>=224?r-256:{_unknown:r,_offset:s-1}}try{return a()}catch(r){return{_error:r.message,_partial:!0}}}function $e(t){return Array.isArray(t)?t.map(e=>{if(Array.isArray(e))return{price:Number(e[0])||0,quantity:Number(e[1])||0};if(e&&typeof e=="object"){const s=e;return{price:Number(s.price??s.p)||0,quantity:Number(s.size??s.quantity??s.q)||0}}return{price:0,quantity:0}}):[]}function _t(t){if(!t)return null;const e=t.match(/[\/:](\d+)$/);return e?parseInt(e[1],10):null}const Dt={parse(t){if(!t||typeof t!="object")return null;if(t.order_book){const e=t.order_book,s=$e(e.bids),a=$e(e.asks);return{type:"orderBook",orderBook:{bids:s,asks:a},channel:t.channel}}if(t.market_stats){const e=t.market_stats;return{type:"marketStats",marketStats:{indexPrice:Number(e.index_price)||0,markPrice:Number(e.mark_price)||0,fundingRate:Number(e.current_funding_rate)||0},channel:t.channel}}return null},extractMarketIdFromChannel:_t},jt={parse(t){if(!t||typeof t!="object")return null;if(t.type==="quote"&&t.data){const e=t.data,s=Number(e.bid)||0,a=Number(e.ask)||0,r=e.instrument;return{type:"orderBook",orderBook:{bids:[{price:s,quantity:1}],asks:[{price:a,quantity:1}]},marketStats:{markPrice:Number(e.mark_price)||0,indexPrice:Number(e.index_price)||0},symbol:t.symbol||(r==null?void 0:r.underlying)}}if(t.bid!==void 0&&t.ask!==void 0){const e=Number(t.bid)||0,s=Number(t.ask)||0,a=t.instrument;return{type:"orderBook",orderBook:{bids:[{price:e,quantity:1e9}],asks:[{price:s,quantity:1e9}]},marketStats:{markPrice:Number(t.mark_price)||0,indexPrice:Number(t.index_price)||0},symbol:a==null?void 0:a.underlying}}return null}};function Ct(t,e){return!e||typeof e!="object"?null:((t==null?void 0:t.toLowerCase())==="omni"?jt:Dt).parse(e)}const Ie=[{id:"LG",name:"Lighter",color:"#6366f1",baseUrl:"https://app.lighter.xyz",enforceOpenTab:!1,tabId:null,currentUrl:null,currentSymbol:null,wsConnected:!1,accountInfo:null},{id:"OM",name:"Omni",color:"#f59e0b",baseUrl:"https://omni.variational.io",enforceOpenTab:!0,tabId:null,currentUrl:null,currentSymbol:null,wsConnected:!1,accountInfo:null}];function Lt(t){try{const s=new URL(t).pathname.split("/").filter(Boolean);if(s.length>0)return s[s.length-1].toUpperCase()}catch{}return null}function we(t,e,s){if(!e||e.length===0)return t||[];if(!t||t.length===0||e.length>10){const o=e.filter(i=>i.quantity>0);return o.sort((i,u)=>s?u.price-i.price:i.price-u.price),o.slice(0,20)}const a=new Map;for(const o of t)a.set(o.price.toString(),o);for(const o of e)o.quantity===0?a.delete(o.price.toString()):a.set(o.price.toString(),o);const r=Array.from(a.values()).filter(o=>o.quantity>0);return r.sort((o,i)=>s?i.price-o.price:o.price-i.price),r.slice(0,20)}const Ot={LG:!0,OM:!1};function Pt(t,e){const[s,a]=d.useState(Ie),[r,o]=d.useState([]),[i,u]=d.useState([]),w=d.useRef(new Map),j=d.useRef(null),T=d.useRef(null),A=d.useCallback(l=>s.find(p=>p.id===l),[s]),$=d.useCallback(l=>{const p=r.find(I=>I.symbol===l);return p||{symbol:l,positions:[],exchangeMarketStats:[]}},[r]),N=d.useCallback((l,p,I)=>{o(m=>{const g=m.findIndex(y=>y.symbol===l),c=g>=0?{...m[g]}:{symbol:l,positions:[],exchangeMarketStats:[]},C=Ot[p]??!0,S=c.exchangeMarketStats.findIndex(y=>y.exchangeId===p);let f;if(C&&S>=0){const y=c.exchangeMarketStats[S].orderBook;f={bids:we(y==null?void 0:y.bids,I.bids,!0),asks:we(y==null?void 0:y.asks,I.asks,!1)}}else C?f={bids:we(void 0,I.bids,!0),asks:we(void 0,I.asks,!1)}:f=I;const x={exchangeId:p,orderBook:f,lastUpdated:Date.now()},L=[...c.exchangeMarketStats];S>=0?L[S]=x:L.push(x);const z={...c,exchangeMarketStats:L};if(g>=0){const y=[...m];return y[g]=z,y}return[...m,z]})},[]),E=d.useCallback((l,p,I,m="ui",g)=>{const c=fe.find(C=>C.abbreviation===l);c!=null&&c.positionUpdater&&c.positionUpdater.source!==m||o(C=>{let S=[...C];I&&(S=S.map(x=>({...x,positions:x.positions.filter(L=>L.exchangeId!==l)}))),g&&g.length>0&&(S=S.map(x=>g.includes(x.symbol)?{...x,positions:x.positions.filter(L=>L.exchangeId!==l)}:x));const f=Date.now();for(const x of p){const L=S.findIndex(z=>z.symbol===x.symbol);if(L>=0){const z={...S[L]},y=z.positions.findIndex(J=>J.exchangeId===l),q={...x,exchangeId:l,lastUpdated:f};y>=0?(z.positions=[...z.positions],z.positions[y]=q):z.positions=[...z.positions,q],S[L]=z}else S.push({symbol:x.symbol,positions:[{...x,exchangeId:l,lastUpdated:f}],exchangeMarketStats:[]})}return S})},[]),P=d.useCallback((l,p)=>{const I=[],m=[];for(const g of l){const c=parseFloat(g.position),C=parseFloat(g.avg_entry_price);if(c===0&&C===0){I.push(g.symbol);continue}const S=parseFloat(g.position_value),f=parseFloat(g.unrealized_pnl),x=c!==0?S/c:0,L=c*C,z=L!==0?f/L*100:0;m.push({symbol:g.symbol,position:Math.abs(c),side:g.sign>0?"long":"short",leverage:g.initial_margin_fraction?(100/parseFloat(g.initial_margin_fraction)).toFixed(1)+"x":void 0,avgEntryPrice:C,markPrice:x,positionValue:Math.abs(S),unrealizedPnl:f,unrealizedPnlPercent:z,funding:parseFloat(g.total_funding_paid_out||"0"),liquidationPrice:g.liquidation_price?parseFloat(g.liquidation_price):null})}E("LG",m,p,"websocket",I)},[E]),h=d.useCallback(async l=>{var p;console.log("[Arbflow] Fetching OM account info, tabId:",l);try{const I=await chrome.scripting.executeScript({target:{tabId:l},func:()=>fetch("https://omni.variational.io/api/settlement_pools/existing").then(g=>g.ok?g.json():null).then(g=>(console.log("[Arbflow] OM account info:",g),(g==null?void 0:g.address_other)||null)).catch(()=>null)});console.log("[Arbflow] OM script result:",I);const m=(p=I==null?void 0:I[0])==null?void 0:p.result;m&&a(g=>{var C;const c=g.find(S=>S.id==="OM");return((C=c==null?void 0:c.accountInfo)==null?void 0:C.walletAddress)===m?g:g.map(S=>S.id==="OM"?{...S,accountInfo:{...S.accountInfo,walletAddress:m}}:S)})}catch(I){console.error("[Arbflow] Failed to fetch OM account info:",I)}},[]),v=d.useCallback(async()=>{var I;const l={};for(const m of Ie){const g=await chrome.tabs.query({url:`${m.baseUrl}/*`});if(g.length>0){const c=g[0];l[m.id]={tabId:c.id??null,currentUrl:c.url??null,currentSymbol:c.url?Lt(c.url):null}}else l[m.id]={tabId:null,currentUrl:null,currentSymbol:null}}a(m=>m.map(g=>({...g,...l[g.id]})));const p=(I=l.OM)==null?void 0:I.tabId;p&&h(p)},[h]),O=d.useCallback((l,p,I,m,g)=>{const{orderBookConfig:c}=l,C=l.abbreviation;console.log(`[Arbflow] Connecting ${l.name} WebSocket${m?` for ${m}`:""}`);try{const S=new WebSocket(c.url);C==="LG"&&(S.binaryType="arraybuffer");const f={ws:S,exchangeId:C,symbol:m,symbols:p.map(x=>x.symbol),marketId:g};w.current.set(I,f),S.onopen=()=>{if(console.log(`[Arbflow] ${l.name} WebSocket connected${m?` for ${m}`:""}`),a(x=>x.map(L=>L.id===C?{...L,wsConnected:!0}:L)),c.getSubscribeMessages){const x=c.getSubscribeMessages(c.sendRequestPerSymbol?p[0]:p);for(const L of x)S.send(typeof L=="string"?L:JSON.stringify(L))}c.pingInterval&&(f.pingInterval=setInterval(()=>{S.readyState===WebSocket.OPEN&&S.send(JSON.stringify({type:"ping"}))},c.pingInterval))},S.onmessage=x=>{try{let L;if(C==="LG"?L=Tt(x.data):L=JSON.parse(x.data),L.type==="ping"){S.send(JSON.stringify({type:"pong"}));return}const z=Ct(l.id,L);if((z==null?void 0:z.type)==="orderBook"&&z.orderBook){let y=z.symbol;!y&&g!==void 0&&(y=Ze[g]),y&&N(y,C,z.orderBook)}}catch(L){console.error(`[Arbflow] Failed to parse ${l.name} message:`,L)}},S.onclose=()=>{console.log(`[Arbflow] ${l.name} WebSocket closed${m?` for ${m}`:""}`),f.pingInterval&&clearInterval(f.pingInterval),w.current.delete(I),Array.from(w.current.values()).some(L=>L.exchangeId===C)||a(L=>L.map(z=>z.id===C?{...z,wsConnected:!1}:z))},S.onerror=x=>{console.error(`[Arbflow] ${l.name} WebSocket error${m?` for ${m}`:""}:`,x),f.pingInterval&&clearInterval(f.pingInterval),w.current.delete(I)}}catch(S){console.error(`[Arbflow] Failed to connect ${l.name} WebSocket:`,S)}},[N]),F=d.useCallback(l=>{const p=l.map(I=>et.find(m=>m.symbol===I)).filter(I=>I!==void 0);if(p.length!==0)for(const I of fe){const{orderBookConfig:m,abbreviation:g}=I;if(m.sendRequestPerSymbol)for(const c of p){const C=Ne[c.symbol];if(C===void 0)continue;const S=`${g}-${c.symbol}`,f=w.current.get(S);f&&f.ws.readyState!==WebSocket.CLOSED||O(I,[c],S,c.symbol,C)}else{const c=`${g}-all`,C=w.current.get(c);if(C&&C.ws.readyState!==WebSocket.CLOSED)return;O(I,p,c)}}},[O]),R=d.useCallback(async()=>{console.log("[Arbflow] Fetching exchange account info"),console.log("[Arbflow] Lighter config:",e),e!=null&&e.l1Address&&(console.log("[Arbflow] Lighter l1Address:",e.l1Address),a(l=>{var I;const p=l.find(m=>m.id==="LG");return((I=p==null?void 0:p.accountInfo)==null?void 0:I.walletAddress)===e.l1Address?l:l.map(m=>m.id==="LG"?{...m,accountInfo:{walletAddress:e.l1Address}}:m)})),a(l=>{var I;const p=l.find(m=>m.id==="OM");return console.log("[Arbflow] OM exchange check:",p==null?void 0:p.tabId,p==null?void 0:p.accountInfo),p!=null&&p.tabId&&!((I=p.accountInfo)!=null&&I.walletAddress)&&h(p.tabId),l})},[e==null?void 0:e.l1Address,h]),b=d.useCallback(async()=>{if(!(e!=null&&e.accountIndex)||!(e!=null&&e.apiPrivateKey)){console.log("[Arbflow] Lighter config incomplete, skipping ws connection");return}if(j.current&&j.current.readyState!==WebSocket.CLOSED){console.log("[Arbflow] Lighter ws already connected");return}const l=e.accountIndex,p=e.apiKeyIndex;console.log(`[Arbflow] Connecting Lighter WebSocket for account ${l}`);let I;try{I=await at(e.apiPrivateKey,p,l),console.log("[Arbflow] Auth token created:",I?`${I.slice(0,20)}...`:"EMPTY")}catch(m){console.error("[Arbflow] Failed to create auth token:",m);return}try{const m=new WebSocket(tt);j.current=m,m.onopen=()=>{console.log("[Arbflow] Lighter WebSocket connected");const g=[{type:"subscribe",channel:`account_all_positions/${l}`},{type:"subscribe",channel:`user_stats/${l}`,auth:I}];for(const c of g)m.send(JSON.stringify(c));console.log("[Arbflow] Subscribed to:",g.map(c=>c.channel).join(", ")),T.current=setInterval(()=>{m.readyState===WebSocket.OPEN&&m.send(JSON.stringify({type:"ping"}))},5e3)},m.onmessage=g=>{try{const c=JSON.parse(g.data);if(c.type==="ping"){m.send(JSON.stringify({type:"pong"}));return}const S=`[${new Date().toLocaleTimeString()}] ${c.type||"unknown"}`;if(u(f=>[S,...f].slice(0,50)),c.type==="subscribed/account_all_positions"&&c.positions){const f=[];for(const[,x]of Object.entries(c.positions))f.push(x);P(f,!0)}else if(c.type==="update/account_all_positions"&&c.positions){const f=[];for(const[,x]of Object.entries(c.positions))f.push(x);P(f,!1)}else if((c.type==="subscribed/user_stats"||c.type==="update/user_stats")&&c.stats){const f=parseFloat(c.stats.portfolio_value),x=parseFloat(c.stats.leverage);a(L=>L.map(z=>{var y,q,J;return z.id==="LG"?{...z,accountInfo:{...z.accountInfo,walletAddress:((y=z.accountInfo)==null?void 0:y.walletAddress)||"",portfolioValue:isNaN(f)?(q=z.accountInfo)==null?void 0:q.portfolioValue:f,leverage:isNaN(x)?(J=z.accountInfo)==null?void 0:J.leverage:x}}:z}))}}catch(c){console.error("[Arbflow] Failed to parse Lighter ws message:",c)}},m.onclose=()=>{console.log("[Arbflow] Lighter WebSocket closed"),j.current=null,T.current&&(clearInterval(T.current),T.current=null)},m.onerror=g=>{console.error("[Arbflow] Lighter WebSocket error:",g),j.current=null,T.current&&(clearInterval(T.current),T.current=null)}}catch(m){console.error("[Arbflow] Failed to connect Lighter WebSocket:",m)}},[e==null?void 0:e.accountIndex,e==null?void 0:e.apiPrivateKey,e==null?void 0:e.apiKeyIndex,P]),M=d.useCallback(()=>{T.current&&(clearInterval(T.current),T.current=null),j.current&&(j.current.close(),j.current=null,u([]))},[]);d.useEffect(()=>{const l=p=>{if(p.target==="sidepanel")switch(p.type){case"TAB_UPDATED":case"TAB_CREATED":case"TAB_REMOVED":case"CONTENT_SCRIPT_READY":v();break;case"POSITIONS":E(p.exchange,p.positions,p.isFullUpdate,"ui");break;case"ACCOUNT_INFO":a(I=>I.map(m=>{var g;return m.id===p.exchange?{...m,accountInfo:{...m.accountInfo,walletAddress:((g=m.accountInfo)==null?void 0:g.walletAddress)||"",portfolioValue:p.portfolioValue,leverage:p.leverage}}:m}));break}};return chrome.runtime.onMessage.addListener(l),v(),()=>{chrome.runtime.onMessage.removeListener(l)}},[v,E]),d.useEffect(()=>{t.length>0&&(F(t),b(),R())},[t,F,b,R]),d.useEffect(()=>{e!=null&&e.l1Address&&a(l=>{var I;const p=l.find(m=>m.id==="LG");return((I=p==null?void 0:p.accountInfo)==null?void 0:I.walletAddress)===e.l1Address?l:l.map(m=>m.id==="LG"?{...m,accountInfo:{walletAddress:e.l1Address}}:m)})},[e==null?void 0:e.l1Address]);const G=d.useCallback(async l=>{const p=Ie.find(I=>I.id===l);p&&await chrome.tabs.create({url:p.baseUrl,active:!0})},[]),U=d.useCallback(async l=>{await chrome.tabs.update(l,{active:!0});const p=await chrome.tabs.get(l);await chrome.windows.update(p.windowId,{focused:!0})},[]),K=d.useCallback(async l=>{await chrome.tabs.reload(l)},[]),H=d.useCallback(()=>{w.current.forEach(l=>{l.pingInterval&&clearInterval(l.pingInterval),l.ws.readyState===WebSocket.OPEN&&l.ws.close()}),w.current.clear(),a(l=>l.map(p=>({...p,wsConnected:!1})))},[]),_=d.useCallback(async()=>{for(const l of s)if(l.enforceOpenTab)try{l.tabId?await chrome.tabs.reload(l.tabId):await chrome.tabs.create({url:l.baseUrl,active:!1})}catch(p){console.error(`[Arbflow] Failed to reload ${l.name}:`,p)}await new Promise(l=>setTimeout(l,2e3)),await v(),H(),M(),await new Promise(l=>setTimeout(l,500)),t.length>0&&(F(t),b())},[s,v,t,F,H,b,M]);return{exchanges:s,symbolStates:r,lighterWsMessages:i,getExchangeById:A,getOrCreateSymbolState:$,openExchange:G,focusTab:U,refreshTab:K,refreshAllExchanges:_,scanOpenExchanges:v,connectLighterWs:b,disconnectLighterWs:M}}function Rt({exchanges:t,symbolStates:e,lighterConfig:s,saveLighterConfig:a}){const r=d.useRef(null),o=d.useCallback(N=>t.find(E=>E.id===N),[t]),i=d.useCallback(async()=>{if(!s.l1Address||!s.apiPrivateKey)return!1;try{r.current=new ot;const N=await r.current.initialize({l1Address:s.l1Address,apiPrivateKey:s.apiPrivateKey,apiKeyIndex:s.apiKeyIndex,accountIndex:s.accountIndex});return a({accountIndex:N}),console.log("[LighterAPI] Initialized with account index:",N),!0}catch(N){return console.error("[LighterAPI] Init failed:",N),r.current=null,!1}},[s,a]),u=d.useCallback(async(N,E)=>new Promise(P=>{chrome.tabs.sendMessage(N,{type:"EXECUTE_TRADE_STEP",step:E},h=>{chrome.runtime.lastError?P({success:!1,error:chrome.runtime.lastError.message}):h!=null&&h.success?P({success:!0}):P({success:!1,error:(h==null?void 0:h.error)||"Unknown error"})})}),[]),w=d.useCallback(async(N,E)=>new Promise(P=>{chrome.tabs.sendMessage(N,{type:"GET_TRADE_STATE",platform:E},h=>{chrome.runtime.lastError?P({direction:null,size:""}):P(h||{direction:null,size:""})})}),[]),j=d.useCallback(async(N,E,P,h)=>{var U;const v=o(N);if(!(v!=null&&v.tabId))throw new Error(`${N} page not open`);const O=fe.find(K=>K.abbreviation===N);if(!((U=O==null?void 0:O.tradeSimulator)!=null&&U.getSteps))throw new Error(`${N} tradeSimulator not configured`);const F=v.currentSymbol,R=(F==null?void 0:F.toUpperCase())===E.toUpperCase(),b=await w(v.tabId,N),M=R&&b.direction===P&&b.size===String(h),G=O.tradeSimulator.getSteps(E,P,h,{skipSymbolSelection:R,skipDirectionAndSize:M});return{exchange:v,steps:G}},[o,w]),T=d.useCallback(async(N,E,P,h)=>{const v=P==="long"?"buy":"sell";if(N==="LG"){if(!r.current){if(!s.l1Address||!s.apiPrivateKey||!s.accountIndex)throw new Error("Please configure Lighter API first");if(!await i())throw new Error("Lighter API initialization failed")}return r.current.createMarketOrder(E,v,h)}if(N==="OM"){const O=o(N);if(!(O!=null&&O.tabId))throw new Error(`${N} page not open`);return new Promise((F,R)=>{var G;const b=setTimeout(()=>{R(new Error("API trade timeout"))},3e4),M=U=>{U.target==="sidepanel"&&(U.type==="TRADE_ORDER"?(clearTimeout(b),chrome.runtime.onMessage.removeListener(M),F(U.orderData)):U.type==="TRADE_ERROR"&&(clearTimeout(b),chrome.runtime.onMessage.removeListener(M),R(new Error(U.error))))};chrome.runtime.onMessage.addListener(M),chrome.tabs.sendMessage(O.tabId,{type:"TRADE",exchangeId:N,params:{underlying:E,size:h,side:v,maxSlippage:.005,walletAddress:(G=O.accountInfo)==null?void 0:G.walletAddress}}).catch(U=>{clearTimeout(b),chrome.runtime.onMessage.removeListener(M),R(U)})})}throw new Error(`Unsupported exchange: ${N}`)},[s,i,o]),A=d.useCallback(async(N,E,P,h)=>{const{exchange:v,steps:O}=await j(N,E,P,h);for(let F=0;F<O.length;F++){const R=O[F];console.log(`[Arbflow] ${N} step ${F+1}/${O.length}: ${R.description}`);const b=await u(v.tabId,R);if(!b.success)throw new Error(b.error)}},[j,u]);return{doTrades:d.useCallback(async N=>{if(N.length===0)return;console.log("[Arbflow] Executing trades:",N);const E=N.find(h=>{const v=fe.find(O=>O.abbreviation===h.platform);return(v==null?void 0:v.tradeExecutor)!=="api"});if(E){const h=o(E.platform);h!=null&&h.tabId&&(await chrome.tabs.update(h.tabId,{active:!0}),await new Promise(v=>setTimeout(v,200)))}const P=async h=>{const v=fe.find(F=>F.abbreviation===h.platform),O=(v==null?void 0:v.tradeExecutor)||"simulate";try{return O==="api"?await T(h.platform,h.symbol,h.direction,h.size):await A(h.platform,h.symbol,h.direction,h.size)}catch(F){const R=F instanceof Error?F.message:String(F);throw new Error(`[${h.platform}] ${R}`)}};await Promise.all(N.map(P)),console.log("[Arbflow] Trades completed")},[o,T,A]),initializeLighterApi:i,fetchLighterAccountIndex:ze}}const Mt=500;function $t(){const[t,e]=d.useState(window.innerWidth);return d.useEffect(()=>{const s=()=>e(window.innerWidth);return window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[]),t}function Ut(){return n.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-background/95 backdrop-blur-sm",children:n.jsxs("div",{className:"flex items-center gap-4 text-muted-foreground",children:[n.jsx("div",{className:"flex h-12 w-12 animate-pulse items-center justify-center rounded-full bg-muted",children:n.jsx("svg",{className:"h-6 w-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:n.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),n.jsx("span",{className:"text-lg font-medium",children:"å‘å·¦æ‹–åŠ¨æ‰©å±•è§†å›¾"})]})})}function zt(){const e=$t()<Mt,{watchedSymbols:s,saveWatchedSymbols:a,lighterConfig:r,saveLighterConfig:o,globalTradeInterval:i,saveGlobalTradeInterval:u,consecutiveTriggerCount:w,saveConsecutiveTriggerCount:j,autoRebalanceEnabled:T,saveAutoRebalanceEnabled:A,soundEnabled:$,saveSoundEnabled:N}=vt(),E=d.useRef(0),P=d.useRef(0),{exchanges:h,symbolStates:v,openExchange:O,focusTab:F,refreshTab:R,refreshAllExchanges:b}=Pt(s,r),{doTrades:M}=Rt({exchanges:h,symbolStates:v,lighterConfig:r,saveLighterConfig:o}),[G,U]=d.useState(!1),[K,H]=d.useState(null),[_,l]=d.useState(!1),[p,I]=d.useState(!1),m=d.useCallback((f,x)=>{H({message:f,isSuccess:x})},[]),g=async()=>{l(!0),m("Refreshing exchanges...",!0);try{await b(),m("âœ“ Exchanges refreshed",!0)}catch(f){m(`Refresh failed: ${f.message}`,!1)}finally{l(!1)}},c=async f=>{try{const x=f.length===1?`${f[0].platform} ${f[0].direction}`:f.map(L=>`${L.direction==="long"?"+":"-"}${L.platform}`).join("");m(`Executing ${x}...`,!0),await M(f),m("âœ“ Trade completed",!0)}catch(x){throw m(`Trade failed: ${x.message}`,!1),x}},C=async f=>{try{const x=await ze(f.l1Address||r.l1Address,f.accountType||r.accountType);return o({...f,accountIndex:x}),{success:!0,accountIndex:x}}catch(x){return o(f),{success:!1,error:x.message}}},S=[...s].sort((f,x)=>(Ne[f]??999)-(Ne[x]??999));return n.jsxs("div",{className:"flex min-h-screen flex-col bg-background text-foreground",children:[n.jsxs("header",{className:"flex items-center justify-between px-4 py-3",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("h1",{className:"text-lg font-semibold",children:"Arbflow"}),n.jsx("span",{className:"text-xs text-muted-foreground",children:(()=>{var J,ie;const f=(J=h.find(ce=>ce.id==="LG"))==null?void 0:J.accountInfo,x=(ie=h.find(ce=>ce.id==="OM"))==null?void 0:ie.accountInfo,L=f==null?void 0:f.portfolioValue,z=x==null?void 0:x.portfolioValue;if(f==null||f.leverage,x==null||x.leverage,L==null&&z==null)return null;const y=[];L!=null&&y.push(`LG(${L.toFixed(1)})`),z!=null&&y.push(`OM(${z.toFixed(1)})`);const q=(L??0)+(z??0);return n.jsxs(n.Fragment,{children:[y.join(" + ")," = ",n.jsx("span",{className:"font-semibold",children:q.toFixed(1)})]})})()})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("button",{onClick:g,disabled:_,className:"cursor-pointer rounded  px-3 py-1.5 text-sm hover:bg-muted disabled:opacity-50",children:_?"â†»...":"â†»"}),n.jsx("button",{onClick:()=>U(!0),className:"cursor-pointer rounded  px-3 py-1.5 text-sm hover:bg-muted",children:"âš™"})]})]}),n.jsxs("div",{className:"flex flex-col gap-2 px-4 pb-2",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("span",{className:"text-xs text-muted-foreground",children:"å…¨å±€äº¤æ˜“é—´éš”:"}),n.jsx("input",{type:"number",value:i,onChange:f=>u(Math.max(100,parseInt(f.target.value,10)||1e3)),className:"w-12 border-b border-muted-foreground/40 bg-transparent px-1 py-0.5 text-xs outline-none focus:border-muted-foreground [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none",min:100,step:100}),n.jsx("span",{className:"text-xs text-muted-foreground",children:"ms"}),n.jsx("span",{className:"ml-4 text-xs text-muted-foreground",children:"è¿žç»­è§¦å‘æ¬¡æ•°é˜ˆå€¼:"}),n.jsx("input",{type:"number",value:w,onChange:f=>{const x=parseInt(f.target.value,10);j(isNaN(x)?1:Math.max(1,x))},className:"w-12 border-b border-muted-foreground/40 bg-transparent px-1 py-0.5 text-xs outline-none focus:border-muted-foreground [appearance:textfield] ",min:1,step:1})]}),n.jsxs("div",{className:"flex items-center gap-4",children:[n.jsxs("label",{className:"flex cursor-pointer items-center gap-2",children:[n.jsx("span",{className:"text-xs text-muted-foreground",children:"æç¤ºéŸ³"}),n.jsx("button",{onClick:()=>N(!$),className:`relative h-5 w-9 rounded-full transition-colors ${$?"bg-primary":"bg-muted-foreground/30"}`,children:n.jsx("span",{className:`absolute left-0.5 top-0.5 h-4 w-4 rounded-full bg-white transition-transform ${$?"translate-x-4":"translate-x-0"}`})})]}),n.jsxs("label",{className:"flex cursor-pointer items-center gap-2",children:[n.jsx("span",{className:"text-xs text-muted-foreground",children:"è‡ªåŠ¨è¡¥é½"}),n.jsx("button",{onClick:()=>A(!T),className:`relative h-5 w-9 rounded-full transition-colors ${T?"bg-primary":"bg-muted-foreground/30"}`,children:n.jsx("span",{className:`absolute left-0.5 top-0.5 h-4 w-4 rounded-full bg-white transition-transform ${T?"translate-x-4":"translate-x-0"}`})})]})]})]}),n.jsxs("main",{className:"flex-1 overflow-y-auto p-4",children:[n.jsx("section",{children:S.length===0?n.jsx("div",{className:"rounded-lg border border-dashed p-8 text-center text-muted-foreground",children:"No symbols selected. Click Settings to add symbols."}):n.jsx("div",{className:"space-y-4",children:S.map(f=>n.jsx(St,{symbol:f,symbolState:v.find(x=>x.symbol===f),exchanges:h,onDoTrades:c,globalTradeInterval:i,globalLastTradeTimeRef:E,globalLastRefreshTimeRef:P,consecutiveTriggerCount:w,onRefreshAllExchanges:b,autoRebalanceEnabled:T,soundEnabled:$},f))})}),n.jsxs("section",{className:"mt-6",children:[n.jsx("h2",{className:"mb-3 text-sm font-medium text-muted-foreground",children:"Exchanges"}),n.jsx("div",{className:"space-y-2",children:h.map(f=>n.jsx(it,{exchange:f,symbolStates:v,onOpen:()=>O(f.id),onFocus:()=>f.tabId&&F(f.tabId),onRefresh:()=>f.tabId&&R(f.tabId)},f.id))})]})]}),n.jsx(ct,{open:G,onClose:()=>U(!1),watchedSymbols:s,onSaveSymbols:a,lighterConfig:r,onSaveLighterConfig:C}),n.jsx(dt,{message:(K==null?void 0:K.message)||null,isSuccess:(K==null?void 0:K.isSuccess)??!0}),e&&n.jsx(Ut,{})]})}Xe.createRoot(document.getElementById("app")).render(n.jsx(Je.StrictMode,{children:n.jsx(zt,{})}));
