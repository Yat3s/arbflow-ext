import{E as B}from"./chunk-CgcjkoXT.js";const s=window.location.hostname.includes("lighter.xyz")?"lighter":window.location.hostname.includes("variational.io")?"omni":null;function E(t){return t&&B.find(e=>e.id===t)||null}console.log("[Arbflow] Content script loaded, SITE_TYPE:",s);s||console.log("[Arbflow] Unknown site, content script disabled");function G(t){return new Promise((e,o)=>{const r=document.createElement("script");r.src=chrome.runtime.getURL(t),r.onload=()=>{r.remove(),e()},r.onerror=o,(document.head||document.documentElement).appendChild(r)})}async function X(){console.log("[Arbflow] Injecting interceptor scripts...");try{await G("injected/index.js"),console.log("[Arbflow] âœ… Interceptor scripts loaded")}catch(t){console.log("[Arbflow] âŒ Failed to load interceptor:",t)}}(s==="omni"||s==="lighter")&&X();window.addEventListener("message",t=>{var n,l;if(t.source!==window||!((l=(n=t.data)==null?void 0:n.type)!=null&&l.startsWith("ARBFLOW_")))return;const{type:e,...o}=t.data,r=e.replace("ARBFLOW_","");chrome.runtime.sendMessage({type:r,target:"sidepanel",site:s,...o}).catch(()=>{})});const p=new Map;let b=null;function Y(t){var o;const e=document.querySelector(t);return e?{exists:!0,selector:t,tagName:e.tagName.toLowerCase(),text:(o=e.textContent)==null?void 0:o.trim().slice(0,100),disabled:e.disabled||e.getAttribute("aria-disabled")==="true",visible:e.offsetParent!==null,className:e.className}:{exists:!1,selector:t}}function V(){const t={};for(const[e]of p)t[e]=Y(e);return t}function $(t="update"){const e={type:"ELEMENT_UPDATE",site:s,url:window.location.href,reason:t,elements:V(),timestamp:Date.now()};chrome.runtime.sendMessage(e).catch(()=>{})}function H(){if(!b){if(!document.body){document.addEventListener("DOMContentLoaded",H);return}b=new MutationObserver(t=>{let e=!1;for(const o of t){if(o.type==="childList"||o.type==="attributes")for(const[r]of p){const n=document.querySelector(r);if(n&&(o.target===n||o.target.contains(n)||n.contains(o.target))){e=!0;break}}if(e)break}e&&$("mutation")}),b.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["disabled","aria-disabled","class","style"]})}}function J(){b&&(b.disconnect(),b=null)}chrome.runtime.onMessage.addListener((t,e,o)=>{var r;if(t.type==="WATCH_ELEMENTS"){p.clear();for(const n of t.selectors||[])p.set(n,!0);return p.size>0?(H(),$("watch_start")):J(),o({success:!0,watching:p.size}),!0}if(t.type==="GET_ELEMENT_STATUS"){const n=V();return o({site:s,url:window.location.href,elements:n}),!0}if(t.type==="PING")return o({site:s,url:window.location.href}),!0;if(t.type==="WS_COMMAND")return console.log("[Arbflow] Content received WS_COMMAND:",t),window.postMessage({type:"ARBFLOW_WS_COMMAND",command:t.command,url:t.url,id:t.id,options:t.options,data:t.data},"*"),o({success:!0}),!0;if(t.type==="HTTP_COMMAND")return console.log("[Arbflow] Content received HTTP_COMMAND:",t),window.postMessage({type:"ARBFLOW_HTTP_COMMAND",command:t.command,url:t.url,id:t.id,options:t.options},"*"),o({success:!0}),!0;if(t.type==="EXECUTE_TRADE_STEP")return console.log("[Arbflow] Content received EXECUTE_TRADE_STEP:",t),ot(t.step).then(n=>{o({success:!0,result:n})}).catch(n=>{console.error("[Arbflow] Step execution error:",n),o({success:!1,error:n.message})}),!0;if(t.type==="CHECK_ELEMENT"){const n=document.querySelector(t.selector);return o({exists:!!n,visible:n?n.offsetParent!==null:!1,text:(r=n==null?void 0:n.textContent)==null?void 0:r.trim().slice(0,100)}),!0}if(t.type==="GET_TRADE_STATE"){const n=K(t.platform);return o(n),!0}return t.type==="TRADE"?(console.log("[Arbflow] Content received TRADE:",t),window.postMessage({type:"ARBFLOW_TRADE",exchangeId:t.exchangeId,params:t.params},"*"),o({success:!0}),!0):!1});function K(t){if(t==="LG"){const e=document.querySelector(".relative.flex.h-8.shrink-0.rounded-sm"),o=e==null?void 0:e.querySelector("div.absolute"),n=((o==null?void 0:o.className)||"").split(/\s+/),l=n.some(c=>c==="left-0.5"||c.startsWith("border-green")),u=n.some(c=>c==="left-1/2"||c.startsWith("border-red")),i=document.querySelector('[data-testid="place-order-size-input"]'),a=(i==null?void 0:i.value)||"";return{direction:l?"long":u?"short":null,size:a}}if(t==="OM"){const e=document.querySelector('span[role="switch"]'),o=e==null?void 0:e.querySelector("button:first-child"),r=e==null?void 0:e.querySelector("button:nth-child(2)"),n=o==null?void 0:o.hasAttribute("disabled"),l=r==null?void 0:r.hasAttribute("disabled"),u=document.querySelector('[data-testid="quantity-input"]'),i=(u==null?void 0:u.value)||"";return{direction:n?"long":l?"short":null,size:i}}return{direction:null,size:""}}s&&chrome.runtime.sendMessage({type:"CONTENT_SCRIPT_READY",site:s,url:window.location.href}).catch(()=>{});const f=t=>parseFloat((t==null?void 0:t.replace(/[$,<>]/g,"").trim())||"0")||0,Q={omni:t=>{var C,T,x,M,O,P,_,q,L,D,N,U,F;const e=t.querySelectorAll(":scope > div");if(e.length<8)return null;const o=(C=e[0])==null?void 0:C.querySelector(".link-instrument span"),r=((T=o==null?void 0:o.textContent)==null?void 0:T.trim().replace("-PERP",""))||"",n=((M=(x=e[1])==null?void 0:x.textContent)==null?void 0:M.trim())||"0",l=f(n),u=l>=0?"long":"short",i=f((O=e[2])==null?void 0:O.textContent),a=f((P=e[3])==null?void 0:P.textContent),c=f((_=e[4])==null?void 0:_.textContent),d=(L=(q=e[5])==null?void 0:q.textContent)==null?void 0:L.trim(),g=d==="-"?null:f(d),w=((N=(D=e[6])==null?void 0:D.textContent)==null?void 0:N.trim())||"",m=f(w),h=((F=(U=e[7])==null?void 0:U.textContent)==null?void 0:F.trim())||"",A=h.match(/([+-]?\$?[\d.,]+)\s*\(([^)]+)\)/);let y=0,v=0;return A&&(y=f(A[1]),h.startsWith("-")&&(y=-Math.abs(y)),v=parseFloat(A[2].replace(/[%,]/g,""))||0),{symbol:r,position:Math.abs(l),side:u,avgEntryPrice:c,markPrice:i,positionValue:a,unrealizedPnl:y,unrealizedPnlPercent:v,funding:m,liquidationPrice:g}}};let k=null,I="";function Z(){if(!s)return null;const t=E(s);if(!t||t.positionUpdater.source!=="ui")return null;const{uiParser:e}=t.positionUpdater,o=Q[s];if(!o)return null;const r=document.querySelector(e.tableSelector);if(!r)return null;const n=r.querySelectorAll(e.rowSelector),l=[];return n.forEach(u=>{const i=o(u);i&&i.symbol&&l.push(i)}),l}function W(){if(!s)return;const t=E(s);if(!t||t.positionUpdater.source!=="ui")return;const e=Z();if(!e)return;const o=JSON.stringify(e);o!==I&&(I=o,console.log("[Arbflow] ðŸ“Š DOM Positions:",e),chrome.runtime.sendMessage({type:"POSITIONS",target:"sidepanel",site:s,exchange:t.abbreviation,positions:e,isFullUpdate:!0,timestamp:Date.now()}).catch(()=>{}))}function tt(){if(!s)return;const t=E(s);if(!t||t.positionUpdater.source!=="ui")return;const{uiParser:e}=t.positionUpdater,o=()=>{const r=document.querySelector(e.tableSelector);if(!r){setTimeout(o,1e3);return}console.log("[Arbflow] ðŸ“Š Found positions table, starting observer"),W(),k=new MutationObserver(()=>{W()}),k.observe(r,{childList:!0,subtree:!0,characterData:!0})};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",o):o()}if(s){const t=E(s);(t==null?void 0:t.positionUpdater.source)==="ui"&&tt()}let z=null,S={portfolioValue:null,leverage:null};function j(){var r,n,l;let t=null,e=null;const o=document.querySelector(".account-details");if(o){const u=o.querySelectorAll(".flex.justify-between");for(const i of u){const a=(n=(r=i.querySelector("span"))==null?void 0:r.textContent)==null?void 0:n.trim();if(a==="Portfolio Value"){const c=i.querySelector("span.text-blackwhite, span.text-green, span.text-red");if(c!=null&&c.textContent){const d=c.textContent.match(/\$?([\d,]+\.?\d*)/);d&&(t=parseFloat(d[1].replace(/,/g,"")))}}else if(a==="Portfolio Leverage"){const c=i.querySelector("span.text-blackwhite");if(c!=null&&c.textContent){const d=c.textContent.match(/([\d.]+)x/);d&&(e=parseFloat(d[1]))}}}}if(t===null){const u=document.querySelectorAll("span");for(const i of u)if(((l=i.textContent)==null?void 0:l.trim())==="Portfolio"){const a=i.closest(".flex.flex-col");if(a){const c=a.querySelector(".tabular-nums");if(c!=null&&c.textContent){const d=c.textContent.match(/\$?([\d,]+\.?\d*)/);if(d){t=parseFloat(d[1].replace(/,/g,""));break}}}}}return{portfolioValue:t,leverage:e}}function R(){if(s!=="omni")return;const t=j();t.portfolioValue===S.portfolioValue&&t.leverage===S.leverage||(S=t,console.log("[Arbflow] ðŸ’° Account info:",t),chrome.runtime.sendMessage({type:"ACCOUNT_INFO",target:"sidepanel",site:s,exchange:"OM",portfolioValue:t.portfolioValue,leverage:t.leverage,timestamp:Date.now()}).catch(()=>{}))}function et(){if(s!=="omni")return;const t=()=>{if(j().portfolioValue===null){setTimeout(t,1e3);return}console.log("[Arbflow] ðŸ’° Found account info, starting observer"),R(),z=new MutationObserver(()=>{R()}),z.observe(document.body,{childList:!0,subtree:!0,characterData:!0})};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t):t()}s==="omni"&&et();async function ot(t){const{type:e,selector:o,value:r,waitAfter:n=0}=t,l=(a,c=3e3)=>new Promise((d,g)=>{const w=document.querySelector(a);if(w){d(w);return}const m=new MutationObserver(()=>{const h=document.querySelector(a);h&&(m.disconnect(),d(h))});m.observe(document.body,{childList:!0,subtree:!0}),setTimeout(()=>{m.disconnect(),g(new Error(`Element not found: ${a}`))},c)}),u=a=>new Promise(c=>setTimeout(c,a));console.log(`[Arbflow] Executing step: ${e} on ${o}`);const i=await l(o);switch(e){case"click":i.click();break;case"clear_and_type":i.focus(),i.value="",i.dispatchEvent(new Event("input",{bubbles:!0})),await u(50),i.value=r||"",i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0}));break;case"type":i.focus(),i.value=r||"",i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0}));break;default:throw new Error(`Unknown step type: ${e}`)}return n>0&&await u(n),{success:!0,selector:o,type:e}}
