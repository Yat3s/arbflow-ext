var qe=Object.defineProperty;var Xe=(s,e,n)=>e in s?qe(s,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):s[e]=n;var ce=(s,e,n)=>Xe(s,typeof e!="symbol"?e+"":e,n);import{j as t,r as l,c as Je,R as Qe}from"./chunk-BXVqizMZ.js";import{o as Ze,i as et,g as tt,r as st,l as Oe}from"./chunk-CjHjUKla.js";import{A as nt,S as Pe,D as Re,a as Me,b as $e,E as Se,M as rt,c as ot,d as Ce}from"./chunk-CgcjkoXT.js";const re="https://mainnet.zklighter.elliot.ai",at="wss://mainnet.zklighter.elliot.ai/stream",ue={ORDER_TYPE_LIMIT:0,ORDER_TYPE_MARKET:1,ORDER_TIME_IN_FORCE_IMMEDIATE_OR_CANCEL:0,ORDER_TIME_IN_FORCE_GOOD_TILL_TIME:1,NIL_TRIGGER_PRICE:0,DEFAULT_28_DAY_ORDER_EXPIRY:-1,DEFAULT_IOC_EXPIRY:0},it={ETH:{id:0,sizeDecimals:4,priceDecimals:2},BTC:{id:1,sizeDecimals:5,priceDecimals:1},SOL:{id:2,sizeDecimals:3,priceDecimals:3},DOGE:{id:3,sizeDecimals:0,priceDecimals:6},"1000PEPE":{id:4,sizeDecimals:0,priceDecimals:6},WIF:{id:5,sizeDecimals:1,priceDecimals:5},WLD:{id:6,sizeDecimals:1,priceDecimals:5},XRP:{id:7,sizeDecimals:0,priceDecimals:6},LINK:{id:8,sizeDecimals:1,priceDecimals:5},AVAX:{id:9,sizeDecimals:2,priceDecimals:4},NEAR:{id:10,sizeDecimals:1,priceDecimals:5},DOT:{id:11,sizeDecimals:1,priceDecimals:5},TON:{id:12,sizeDecimals:1,priceDecimals:5},TAO:{id:13,sizeDecimals:3,priceDecimals:3},POL:{id:14,sizeDecimals:0,priceDecimals:6},TRUMP:{id:15,sizeDecimals:2,priceDecimals:4},SUI:{id:16,sizeDecimals:1,priceDecimals:5},"1000SHIB":{id:17,sizeDecimals:0,priceDecimals:6},"1000BONK":{id:18,sizeDecimals:0,priceDecimals:6},"1000FLOKI":{id:19,sizeDecimals:0,priceDecimals:6},BERA:{id:20,sizeDecimals:1,priceDecimals:5},FARTCOIN:{id:21,sizeDecimals:1,priceDecimals:5},AI16Z:{id:22,sizeDecimals:1,priceDecimals:5},POPCAT:{id:23,sizeDecimals:1,priceDecimals:5},HYPE:{id:24,sizeDecimals:2,priceDecimals:4},BNB:{id:25,sizeDecimals:2,priceDecimals:4},JUP:{id:26,sizeDecimals:1,priceDecimals:5},AAVE:{id:27,sizeDecimals:3,priceDecimals:3},MKR:{id:28,sizeDecimals:4,priceDecimals:2},ENA:{id:29,sizeDecimals:1,priceDecimals:5},UNI:{id:30,sizeDecimals:2,priceDecimals:4},APT:{id:31,sizeDecimals:2,priceDecimals:4},SEI:{id:32,sizeDecimals:1,priceDecimals:5},KAITO:{id:33,sizeDecimals:1,priceDecimals:5},IP:{id:34,sizeDecimals:2,priceDecimals:4},LTC:{id:35,sizeDecimals:3,priceDecimals:3},CRV:{id:36,sizeDecimals:1,priceDecimals:5},PENDLE:{id:37,sizeDecimals:2,priceDecimals:4},ONDO:{id:38,sizeDecimals:1,priceDecimals:5},ADA:{id:39,sizeDecimals:1,priceDecimals:5},S:{id:40,sizeDecimals:1,priceDecimals:5},VIRTUAL:{id:41,sizeDecimals:1,priceDecimals:5},SPX:{id:42,sizeDecimals:1,priceDecimals:5},TRX:{id:43,sizeDecimals:1,priceDecimals:5},ARB:{id:50,sizeDecimals:1,priceDecimals:5},OP:{id:55,sizeDecimals:1,priceDecimals:5},BCH:{id:58,sizeDecimals:3,priceDecimals:3},HBAR:{id:59,sizeDecimals:1,priceDecimals:5},TIA:{id:67,sizeDecimals:1,priceDecimals:5},XMR:{id:77,sizeDecimals:3,priceDecimals:3},PYTH:{id:78,sizeDecimals:1,priceDecimals:5},ZEC:{id:90,sizeDecimals:3,priceDecimals:3},XAU:{id:92,sizeDecimals:4,priceDecimals:2},XAG:{id:93,sizeDecimals:2,priceDecimals:4},ICP:{id:102,sizeDecimals:2,priceDecimals:4},FIL:{id:103,sizeDecimals:1,priceDecimals:5},STRK:{id:104,sizeDecimals:1,priceDecimals:5},NVDA:{id:110,sizeDecimals:3,priceDecimals:3},TSLA:{id:112,sizeDecimals:4,priceDecimals:2},AAPL:{id:113,sizeDecimals:3,priceDecimals:3},AMZN:{id:114,sizeDecimals:3,priceDecimals:3},MSFT:{id:115,sizeDecimals:4,priceDecimals:2},GOOGL:{id:116,sizeDecimals:4,priceDecimals:2},META:{id:117,sizeDecimals:4,priceDecimals:2}};let Ue=!1,je=null;function ct(){return new Promise((s,e)=>{if(typeof window.Go<"u"){s();return}const n=document.createElement("script");n.src=chrome.runtime.getURL("wasm_exec.js"),n.onload=()=>s(),n.onerror=()=>e(new Error("Failed to load wasm_exec.js")),document.head.appendChild(n)})}async function Be(){if(!Ue)return je||(je=(async()=>{if(await ct(),typeof window.Go>"u")throw new Error("wasm_exec.js loaded but Go is not defined");const s=new window.Go,e=chrome.runtime.getURL("lighter-signer.wasm"),a=await(await fetch(e)).arrayBuffer(),r=await WebAssembly.instantiate(a,s.importObject);s.run(r.instance),await new Promise(i=>setTimeout(i,200));const o=["CreateClient","SignCreateOrder","SignCancelOrder","SignCancelAllOrders","GenerateAPIKey","CreateAuthToken"].filter(i=>typeof window[i]=="function");if(console.log("[LighterAPI] Available WASM functions:",o),o.length===0)throw new Error("No WASM functions registered after initialization");Ue=!0,console.log("[LighterAPI] WASM signer initialized (global)")})(),je)}class lt{constructor(){ce(this,"clientCreated",!1);ce(this,"config",null)}async initialize(){await Be()}async createClient(e){await this.initialize();const{url:n,privateKey:a,accountIndex:r,apiKeyIndex:o}=e,i=n.includes("mainnet")?304:300;if(typeof window.CreateClient!="function")throw new Error("WASM CreateClient function not available");console.log("[LighterAPI] Creating client with:",{url:n,chainId:i,apiKeyIndex:o,accountIndex:r});const u=window.CreateClient(n,a,i,o,r);if(console.log("[LighterAPI] CreateClient result:",JSON.stringify(u),typeof u),u){if(typeof u=="object"){const b=u.err||u.error||u.Error||u.message;if(b)throw new Error(`Failed to create client: ${b}`)}else if(typeof u=="string"&&u!=="")throw new Error(`Failed to create client: ${u}`)}this.clientCreated=!0,this.config=e,console.log("[LighterAPI] Client created for account:",r)}signCreateOrder(e){if(!this.clientCreated)throw new Error("Client not created. Call createClient first.");if(typeof window.SignCreateOrder!="function")throw new Error("WASM SignCreateOrder function not available");const{marketIndex:n,clientOrderIndex:a,baseAmount:r,price:o,isAsk:i,orderType:u,timeInForce:b,reduceOnly:E=!1,triggerPrice:_=0,orderExpiry:w=-1,nonce:$,apiKeyIndex:y,accountIndex:k}=e,C=[n,a,r,o,i?1:0,u,b,E?1:0,_,w,$,y,k];console.log("[LighterAPI] SignCreateOrder args:",C.map((S,D)=>`${D}: ${S} (${typeof S})`));const f=window.SignCreateOrder(...C);if(console.log("[LighterAPI] SignCreateOrder raw result:",JSON.stringify(f)),f.err||f.error)throw new Error(f.err||f.error);return{txType:f.txType??14,txInfo:f.txInfo??"",txHash:f.txHash??""}}signCancelOrder(e){if(!this.clientCreated)throw new Error("Client not created. Call createClient first.");if(typeof window.SignCancelOrder!="function")throw new Error("WASM SignCancelOrder function not available");const{marketIndex:n,orderIndex:a,nonce:r,apiKeyIndex:o,accountIndex:i}=e,u=window.SignCancelOrder(n,a,r,o,i);if(u.err)throw new Error(u.err);return{txType:u.txType,txInfo:u.txInfo,txHash:u.txHash}}createAuthToken(e,n,a){if(typeof window.CreateAuthToken!="function")throw new Error("WASM CreateAuthToken function not available");const r=window.CreateAuthToken(e,n,a);if(r.err)throw new Error(r.err);return r.str||""}}class dt{constructor(){ce(this,"signer",new lt);ce(this,"config",null);ce(this,"accountIndex",null);ce(this,"marketsCache",null);ce(this,"cachedNonce",null);ce(this,"lastNonceTime",0)}async initialize(e){return this.config=e,e.accountIndex===null||e.accountIndex===void 0?this.accountIndex=await this.getAccountIndexByL1Address(e.l1Address):this.accountIndex=e.accountIndex,await this.signer.initialize(),await this.signer.createClient({url:re,privateKey:e.apiPrivateKey,accountIndex:this.accountIndex,apiKeyIndex:e.apiKeyIndex}),this.accountIndex}async getAccountIndexByL1Address(e){const a=await(await fetch(`${re}/api/v1/accountsByL1Address?l1_address=${e}`)).json();if(a.code!==200)throw new Error(`API error: ${a.message||"Unknown error"}`);const r=a.sub_accounts||a.accounts||[];if(r.length===0)throw new Error(`No account found for wallet: ${e}`);const o=r.find(i=>i.account_type===0)||r[0];return o.index||o.account_index}async getMarkets(){if(this.marketsCache)return this.marketsCache;const n=await(await fetch(`${re}/api/v1/orderBooks`)).json();this.marketsCache={};for(const a of n.order_books||[])this.marketsCache[a.symbol]={id:a.market_id,sizeDecimals:a.supported_size_decimals,priceDecimals:a.supported_price_decimals,minBaseAmount:a.min_base_amount};return this.marketsCache}async getOrderbook(e){const a=(await this.getMarkets())[e.toUpperCase()];if(!a)throw new Error(`Unknown symbol: ${e}`);return(await fetch(`${re}/api/v1/orderBookOrders?market_id=${a.id}&limit=10`)).json()}async getNextNonce(e=!1){var o;const n=Date.now();if(!e&&this.cachedNonce!==null&&n-this.lastNonceTime<3e4)return this.cachedNonce;const r=await(await fetch(`${re}/api/v1/nextNonce?account_index=${this.accountIndex}&api_key_index=${(o=this.config)==null?void 0:o.apiKeyIndex}`)).json();return this.cachedNonce=r.nonce,this.lastNonceTime=n,r.nonce}incrementNonce(){this.cachedNonce!==null&&this.cachedNonce++}async getAccountInfo(){var a;const n=await(await fetch(`${re}/api/v1/account?by=index&value=${this.accountIndex}`)).json();return((a=n.accounts)==null?void 0:a[0])||n}async sendTransaction(e,n){console.log("[LighterAPI] Sending tx:",{txType:e,txInfoLength:n==null?void 0:n.length});const r=await(await fetch(`${re}/api/v1/sendTx`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`tx_type=${e}&tx_info=${encodeURIComponent(n)}`})).json();return console.log("[LighterAPI] SendTx response:",JSON.stringify(r)),r}async waitForTransaction(e,n=1e4,a=200){var o;const r=Date.now();for(;Date.now()-r<n;){try{const u=await(await fetch(`${re}/api/v1/tx?by=hash&value=${e}`)).json();if(u.code===200&&((o=u.txs)==null?void 0:o.length)>0){const b=u.txs[0];if(b.status>=2)return b}}catch(i){console.log("[LighterAPI] Poll error:",i.message)}await new Promise(i=>setTimeout(i,a))}throw new Error("Transaction timeout")}async createMarketOrder(e,n,a,r={}){var S,D,F,L;const o=performance.now(),{fast:i=!0}=r,u=it[e.toUpperCase()];if(!u)throw new Error(`Unknown symbol: ${e}`);const b=n.toLowerCase()==="sell",E=Math.floor(a*Math.pow(10,u.sizeDecimals));let _,w,$;if(i)w=await this.getNextNonce(),$=performance.now(),console.log(`[LighterAPI] getNonce: ${($-o).toFixed(0)}ms`),_=b?1:Math.pow(10,u.priceDecimals+7),console.log(`[LighterAPI] Fast ${n} order: ${a} ${e}`);else{const[h,O]=await Promise.all([this.getOrderbook(e),this.getNextNonce()]);w=O,$=performance.now(),console.log(`[LighterAPI] getOrderbook + getNonce: ${($-o).toFixed(0)}ms`);const G=h,z=b?(D=(S=G.bids)==null?void 0:S[0])==null?void 0:D.price:(L=(F=G.asks)==null?void 0:F[0])==null?void 0:L.price;if(!z)throw new Error(`No ${b?"bids":"asks"} in orderbook`);const V=parseFloat(z);_=Math.floor(V*(b?.995:1.005)*Math.pow(10,u.priceDecimals)),console.log(`[LighterAPI] Creating ${n} order: ${a} ${e} @ ~$${V}`)}const y=this.signer.signCreateOrder({marketIndex:u.id,clientOrderIndex:Date.now(),baseAmount:E,price:_,isAsk:b,orderType:ue.ORDER_TYPE_MARKET,timeInForce:ue.ORDER_TIME_IN_FORCE_IMMEDIATE_OR_CANCEL,reduceOnly:!1,triggerPrice:ue.NIL_TRIGGER_PRICE,orderExpiry:ue.DEFAULT_IOC_EXPIRY,nonce:w,apiKeyIndex:this.config.apiKeyIndex,accountIndex:this.accountIndex}),k=performance.now();console.log(`[LighterAPI] signOrder: ${(k-$).toFixed(0)}ms`);const C=await this.sendTransaction(y.txType,y.txInfo),f=performance.now();if(console.log(`[LighterAPI] sendTransaction: ${(f-k).toFixed(0)}ms`),console.log(`[LighterAPI] Total: ${(f-o).toFixed(0)}ms`),C.code!==200)throw new Error(C.message||"Transaction failed");return this.incrementNonce(),{success:!0,txHash:C.tx_hash||"submitted",status:"submitted",blockHeight:null}}async createLimitOrder(e,n,a,r){const i=(await this.getMarkets())[e.toUpperCase()];if(!i)throw new Error(`Unknown symbol: ${e}`);const u=n.toLowerCase()==="sell",b=Math.floor(r*Math.pow(10,i.priceDecimals)),E=Math.floor(a*Math.pow(10,i.sizeDecimals)),_=await this.getNextNonce();console.log(`[LighterAPI] Creating limit ${n} order: ${a} ${e} @ $${r}`);const w=this.signer.signCreateOrder({marketIndex:i.id,clientOrderIndex:Date.now(),baseAmount:E,price:b,isAsk:u,orderType:ue.ORDER_TYPE_LIMIT,timeInForce:ue.ORDER_TIME_IN_FORCE_GOOD_TILL_TIME,reduceOnly:!1,triggerPrice:ue.NIL_TRIGGER_PRICE,orderExpiry:ue.DEFAULT_28_DAY_ORDER_EXPIRY,nonce:_,apiKeyIndex:this.config.apiKeyIndex,accountIndex:this.accountIndex}),$=await this.sendTransaction(w.txType,w.txInfo);if($.code!==200)throw new Error($.message||"Transaction failed");const y=await this.waitForTransaction($.tx_hash);return{success:!0,txHash:$.tx_hash,status:y.status,blockHeight:y.block_height}}}async function Ge(s,e="main"){const a=await(await fetch(`${re}/api/v1/accountsByL1Address?l1_address=${s}`)).json();if(a.code!==200)throw new Error(a.message||"API error");const r=a.sub_accounts||a.accounts||[];if(r.length===0)throw new Error("No accounts found for wallet");if(console.log("[Lighter] Account list:"),r.forEach((i,u)=>{const b=i.account_type===0?"Main":"Sub",E=i.index??i.account_index;console.log(`  ${u+1}. ${b} - Account Index: ${E}`)}),e==="sub"){const i=r.find(u=>u.account_type!==0);if(!i)throw new Error("No sub-account found");return i.index??i.account_index}const o=r.find(i=>i.account_type===0)||r[0];return o.index??o.account_index}async function ut(s,e,n){if(await Be(),typeof window.CreateClient!="function")throw new Error("WASM CreateClient not available");const r=window.CreateClient(re,s,304,e,n);if(r&&typeof r=="object"&&(r.err||r.error))throw new Error(r.err||r.error||"Failed to create client");if(typeof window.CreateAuthToken!="function")throw new Error("WASM CreateAuthToken not available");const o=Math.floor(Date.now()/1e3)+3600,i=window.CreateAuthToken(o,e,n);if(i.err)throw new Error(i.err);const u=i.authToken||i.str;if(!u)throw new Error("CreateAuthToken returned empty token");return u}function mt({exchange:s,symbolStates:e,onOpen:n,onFocus:a,onRefresh:r}){const o=!!s.currentUrl,i=e.reduce((u,b)=>u+b.positions.filter(E=>E.exchangeId===s.id&&E.position!==0).length,0);return t.jsxs("div",{className:`rounded-lg border p-3 ${o?"border-border bg-card":"border-muted bg-muted/30"}`,children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"rounded px-1.5 py-0.5 text-xs font-medium text-white",style:{backgroundColor:s.color},children:s.id}),t.jsx("span",{className:"font-medium",children:s.name}),s.currentSymbol&&t.jsx("span",{className:"text-xs text-muted-foreground",children:s.currentSymbol}),i>0&&t.jsxs("span",{className:"text-xs text-primary",children:[i," ä»“"]})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[o&&t.jsxs(t.Fragment,{children:[t.jsx("button",{onClick:a,className:"rounded p-1 text-muted-foreground hover:bg-accent hover:text-foreground",title:"Focus",children:"âŽ‹"}),t.jsx("button",{onClick:r,className:"rounded p-1 text-muted-foreground hover:bg-accent hover:text-foreground",title:"Refresh",children:"â†»"})]}),t.jsx("span",{className:`h-2 w-2 rounded-full ${s.wsConnected?"bg-green-500":"bg-muted-foreground"}`,title:`WebSocket: ${s.wsConnected?"Connected":"Disconnected"}`})]})]}),t.jsxs("div",{className:"mt-2 space-y-1",children:[o?t.jsx("div",{className:"truncate text-xs text-muted-foreground",title:s.currentUrl,children:s.currentUrl}):t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-sm text-muted-foreground",children:"Page not open"}),t.jsx("button",{onClick:n,className:"rounded bg-primary px-3 py-1 text-xs text-primary-foreground hover:bg-primary/90",children:"Open"})]}),s.accountInfo&&t.jsxs("div",{className:"flex items-center gap-2 font-mono text-xs text-muted-foreground",children:[s.accountInfo.walletAddress&&t.jsxs("span",{className:"truncate",title:s.accountInfo.walletAddress,children:[s.accountInfo.walletAddress.slice(0,6),"...",s.accountInfo.walletAddress.slice(-4)]}),s.accountInfo.portfolioValue!=null&&t.jsxs("span",{className:"text-green-500",children:["$",s.accountInfo.portfolioValue.toFixed(2),s.accountInfo.leverage!=null&&t.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",s.accountInfo.leverage.toFixed(2),"x)"]})]})]})]})]})}function pt({onLoginStart:s,accountDisabled:e}){const[n,a]=l.useState(!1),r=async()=>{a(!0),s==null||s();try{await Ze()}catch(o){console.error("Failed to open login page:",o),a(!1)}};return t.jsx("div",{className:"flex min-h-screen flex-col items-center justify-center bg-background px-6",children:t.jsxs("div",{className:"flex flex-col items-center gap-8",children:[t.jsxs("div",{className:"flex flex-col items-center gap-3",children:[t.jsx("div",{className:`flex h-16 w-16 items-center justify-center rounded-2xl ${e?"bg-destructive/10":"bg-primary/10"}`,children:e?t.jsx("svg",{className:"h-8 w-8 text-destructive",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})}):t.jsx("svg",{className:"h-8 w-8 text-primary",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 10V3L4 14h7v7l9-11h-7z"})})}),t.jsx("h1",{className:"text-2xl font-bold text-foreground",children:"Arbflow"}),e?t.jsx("p",{className:"text-center text-sm text-destructive",children:"ä½ çš„è´¦å·æ— æ³•ä½¿ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜"}):t.jsx("p",{className:"text-center text-sm text-muted-foreground",children:"ç™»å½•ä»¥ä½¿ç”¨æ’ä»¶åŠŸèƒ½"})]}),t.jsx("button",{onClick:r,disabled:n,className:"flex w-full max-w-xs cursor-pointer items-center justify-center gap-2 rounded-lg bg-primary px-6 py-3 text-sm font-medium text-primary-foreground transition-colors hover:bg-primary/90 disabled:cursor-not-allowed disabled:opacity-50",children:n?t.jsxs(t.Fragment,{children:[t.jsxs("svg",{className:"h-4 w-4 animate-spin",viewBox:"0 0 24 24",children:[t.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4",fill:"none"}),t.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"ç­‰å¾…ç™»å½•..."]}):e?"é‡æ–°ç™»å½•":"ç™»å½•"}),t.jsx("p",{className:"text-center text-xs text-muted-foreground/70",children:"ç‚¹å‡»ç™»å½•å°†è·³è½¬åˆ° arbflow.io å®ŒæˆæŽˆæƒ"})]})})}function ft({open:s,onClose:e,watchedSymbols:n,onSaveSymbols:a,lighterConfig:r,onSaveLighterConfig:o}){const[i,u]=l.useState(new Set),[b,E]=l.useState(""),[_,w]=l.useState(""),[$,y]=l.useState(""),[k,C]=l.useState(4),[f,S]=l.useState("main"),[D,F]=l.useState(!1),[L,h]=l.useState(null),[O,G]=l.useState(!1);l.useEffect(()=>{s&&(u(new Set(n)),w(r.l1Address),y(r.apiPrivateKey),C(r.apiKeyIndex),S(r.accountType),E(""),h(null))},[s,n,r]);const z=nt.filter(T=>T.toLowerCase().includes(b.toLowerCase())),V=T=>{const d=new Set(i);d.has(T)?d.delete(T):d.add(T),u(d)},Y=async()=>{if(a(Array.from(i)),(_!==r.l1Address||$!==r.apiPrivateKey||k!==r.apiKeyIndex||f!==r.accountType)&&_&&$){G(!0),h({message:"Fetching account info...",isError:!1});const d=await o({l1Address:_,apiPrivateKey:$,apiKeyIndex:k,accountType:f});G(!1),d.success?h({message:`âœ“ Saved, ${f==="main"?"Main Account":"Sub Account"}: ${d.accountIndex}`,isError:!1}):h({message:`âœ— Failed: ${d.error}`,isError:!0})}else e()};return s?t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",onClick:e,children:t.jsxs("div",{className:"max-h-[90vh] w-[90vw] max-w-md overflow-hidden rounded-lg bg-background shadow-xl",onClick:T=>T.stopPropagation(),children:[t.jsxs("div",{className:"flex items-center justify-between border-b px-4 py-3",children:[t.jsx("h2",{className:"font-semibold",children:"Settings"}),t.jsx("button",{onClick:e,className:"text-muted-foreground hover:text-foreground",children:"âœ•"})]}),t.jsxs("div",{className:"max-h-[60vh] overflow-y-auto p-4",children:[t.jsxs("div",{className:"mb-4",children:[t.jsxs("h3",{className:"mb-2 font-medium",children:["Watched Symbols (",i.size,")"]}),t.jsx("input",{type:"text",placeholder:"Search...",value:b,onChange:T=>E(T.target.value),className:"mb-2 w-full rounded border bg-background px-3 py-2 text-sm"}),t.jsx("div",{className:"grid max-h-40 grid-cols-4 gap-1 overflow-y-auto",children:z.map(T=>t.jsx("button",{onClick:()=>V(T),className:`rounded px-2 py-1 text-xs ${i.has(T)?"bg-primary text-primary-foreground":"bg-muted hover:bg-muted/80"}`,children:T},T))})]}),t.jsxs("div",{className:"border-t pt-4",children:[t.jsx("h3",{className:"mb-2 font-medium",children:"Lighter API Config"}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"mb-1 block text-xs text-muted-foreground",children:"Wallet Address"}),t.jsx("input",{type:"text",value:_,onChange:T=>w(T.target.value),placeholder:"0x...",className:"w-full rounded border bg-background px-3 py-2 text-sm"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"mb-1 block text-xs text-muted-foreground",children:"API Private Key"}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("input",{type:D?"text":"password",value:$,onChange:T=>y(T.target.value),placeholder:"Private key...",className:"flex-1 rounded border bg-background px-3 py-2 text-sm"}),t.jsx("button",{onClick:()=>F(!D),className:"rounded border px-2 text-sm",children:D?"ðŸ™ˆ":"ðŸ‘"})]})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("label",{className:"mb-1 block text-xs text-muted-foreground",children:"API Key Index"}),t.jsx("input",{type:"number",value:k,onChange:T=>C(parseInt(T.target.value)||4),className:"w-full rounded border bg-background px-3 py-2 text-sm"})]}),t.jsxs("div",{className:"flex-1",children:[t.jsx("label",{className:"mb-1 block text-xs text-muted-foreground",children:"Account Type"}),t.jsxs("select",{value:f,onChange:T=>S(T.target.value),className:"w-full rounded border bg-background px-3 py-2 text-sm",children:[t.jsx("option",{value:"main",children:"Main"}),t.jsx("option",{value:"sub",children:"Sub"})]})]})]}),r.accountIndex!==null&&t.jsxs("div",{className:"text-xs text-muted-foreground",children:["Account Index: ",r.accountIndex]}),L&&t.jsx("div",{className:`text-xs ${L.isError?"text-red-500":"text-green-500"}`,children:L.message})]})]})]}),t.jsxs("div",{className:"flex justify-end gap-2 border-t px-4 py-3",children:[t.jsx("button",{onClick:e,className:"rounded border px-4 py-2 text-sm hover:bg-muted",children:"Cancel"}),t.jsx("button",{onClick:Y,disabled:O,className:"rounded bg-primary px-4 py-2 text-sm text-primary-foreground hover:bg-primary/90 disabled:opacity-50",children:O?"Saving...":"Save"})]})]})}):null}const xt=5e3;function ve(s){if(!s)return{skew:!1,timeStr:"--:--:--"};const e=new Date(s),n=String(e.getHours()).padStart(2,"0"),a=String(e.getMinutes()).padStart(2,"0"),r=String(e.getSeconds()).padStart(2,"0"),o=`${n}:${a}:${r}`;return{skew:Math.abs(Date.now()-s)>xt,timeStr:o}}function Ke(s,e){if(!s||s===0)return"--";const n=e??s;return Math.abs(n)>=1e3?s.toFixed(2):Math.abs(n)>=10?s.toFixed(3):Math.abs(n)>=1?s.toFixed(4):s.toFixed(6)}function He(s,e){const n=s*100;return`${e!=null&&e.showSign&&n>=0?"+":""}${n.toFixed(1)}bp`}function ze({label:s,spread:e,refPrice:n,platform1LastUpdated:a,platform2LastUpdated:r,onExecute:o,monitorUnit:i,monitorThreshold:u,isMonitoring:b,isAnyMonitoring:E,canStartMonitor:_,onMonitorUnitToggle:w,onMonitorThresholdChange:$,onMonitorToggle:y,rebalanceInfo:k,entrySpread:C}){const[f,S]=l.useState(!1),D=e/n*100,F=e>=0?"+":"",L=e>0;return t.jsxs("div",{className:"flex flex-col gap-2 rounded px-3 py-2 bg-muted-foreground/10 text-xs ",children:[t.jsxs("div",{className:"flex items-center gap-2 justify-between",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"font-semibold shrink-0 font-mono text-muted-foreground text-lg",children:s}),t.jsxs("span",{className:"text-2xl font-semibold shrink-0 whitespace-nowrap text-white",children:[F,Ke(e,n),t.jsxs("span",{className:"text-xs font-mono font-normal",children:["(",He(D,{showSign:!0}),C!=null&&(()=>{const h=C+e,O=h>=0?"+":"";return t.jsxs("span",{className:(h>=0,""),children:[", æ‰§è¡Œ",O,h.toFixed(3),"u"]})})(),")"]})]})]}),(()=>{const h=ve(a),O=ve(r);return!h.skew&&!O.skew?null:t.jsxs("span",{className:"shrink-0 text-muted-foreground text-xs",children:[h.skew?`âš ï¸${h.timeStr}`:"",h.skew&&O.skew?"/":"",O.skew?`âš ï¸${O.timeStr}`:""]})})()]}),t.jsxs("div",{className:"flex items-center justify-between gap-2",children:[t.jsxs("div",{className:"flex items-center gap-1",children:["å½“ä»·å·®",t.jsx("button",{onClick:w,disabled:b,className:`rounded bg-muted px-1.5 py-0.5 font-mono ${b?"cursor-not-allowed opacity-50":"hover:bg-muted/80"}`,children:i==="bps"?"bp":"U"}),t.jsx("span",{className:"font-mono",children:">"}),t.jsx("input",{type:"text",value:u,onChange:h=>$(h.target.value),disabled:b,className:`w-12 rounded border border-border bg-background px-1 py-0.5 text-center ${b?"cursor-not-allowed opacity-50":""}`,placeholder:i==="bps"?"bp":"U"}),t.jsx("button",{onClick:y,disabled:!b&&!_,className:`rounded px-1.5 py-0.5 ${b?"cursor-pointer bg-yellow-500 text-black":_?"cursor-pointer bg-muted text-muted-foreground hover:bg-muted/80":"cursor-not-allowed bg-muted/50 text-muted-foreground/50"}`,children:b?"åœæ­¢":"å¼€å¯ç›‘æŽ§äº¤æ˜“"})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[k&&t.jsxs("div",{className:"relative",children:[t.jsxs("button",{onClick:()=>S(!0),className:"cursor-pointer shrink-0 rounded bg-yellow-500/20 px-1.5 py-0.5 text-yellow-500 hover:bg-yellow-500/30",children:[k.action,k.platformId,"è¡¥é½(",k.size.toFixed(4),")"]}),f&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>S(!1)}),t.jsxs("div",{className:"absolute bottom-full right-0 z-50 mb-2 rounded-lg border border-border bg-background p-3 shadow-lg",children:[t.jsxs("p",{className:"mb-2 whitespace-nowrap text-sm",children:["ç¡®è®¤åœ¨ ",k.platformId," ",k.action==="+"?"ä¹°å…¥":"å–å‡º"," ",k.size.toFixed(4),"?"]}),t.jsxs("div",{className:"flex justify-end gap-2",children:[t.jsx("button",{onClick:()=>S(!1),className:"cursor-pointer rounded bg-muted px-2 py-1 text-muted-foreground hover:bg-muted/80",children:"å–æ¶ˆ"}),t.jsx("button",{onClick:()=>{k.onRebalance(),S(!1)},className:"cursor-pointer rounded bg-yellow-500 px-2 py-1 text-black hover:bg-yellow-400",children:"ç¡®è®¤è¡¥é½"})]})]})]})]}),t.jsx("button",{onClick:o,className:"cursor-pointer shrink-0 text-muted-foreground hover:text-white",children:"ç«‹å³æ‰§è¡Œ1æ¬¡"})]})]})]})}function ht({message:s,isSuccess:e,duration:n=3e3}){const[a,r]=l.useState(!1);return l.useEffect(()=>{if(s){r(!0);const o=setTimeout(()=>{r(!1)},n);return()=>clearTimeout(o)}},[s,n]),!a||!s?null:t.jsx("div",{className:`fixed bottom-4 left-1/2 -translate-x-1/2 rounded-lg px-4 py-2 text-sm shadow-lg transition-all ${e?"bg-green-600 text-white":"bg-red-600 text-white"}`,children:s})}const gt="/assets/ding-C-5Q8E1-.mp3",bt="/assets/warn-NHXt42wg.wav";function Te(s,e){var o;if(!s||s.length===0)return null;if(e<=0)return((o=s[0])==null?void 0:o.price)??null;let n=e,a=0,r=0;for(const i of s){const u=Math.min(n,i.quantity);if(a+=u*i.price,r+=u,n-=u,n<=0)break}return r===0?null:a/r}function wt(s,e,n){var w,$,y,k;if(s.length<2)return null;const a=s[0],r=s[1],o=Te(((w=a==null?void 0:a.orderBook)==null?void 0:w.asks)||[],n),i=Te((($=a==null?void 0:a.orderBook)==null?void 0:$.bids)||[],n),u=Te(((y=r==null?void 0:r.orderBook)==null?void 0:y.asks)||[],n),b=Te(((k=r==null?void 0:r.orderBook)==null?void 0:k.bids)||[],n);if(!o||!i||!u||!b)return null;const E=e.find(C=>C.id===a.exchangeId),_=e.find(C=>C.id===r.exchangeId);return{platform1Id:a.exchangeId,platform2Id:r.exchangeId,platform1Name:(E==null?void 0:E.name)||a.exchangeId,platform2Name:(_==null?void 0:_.name)||r.exchangeId,platform1Color:(E==null?void 0:E.color)||"#6366f1",platform2Color:(_==null?void 0:_.color)||"#f59e0b",spread1to2:b-o,spread2to1:i-u,platform1Ask:o,platform2Ask:u,platform1Bid:i,platform2Bid:b,platform1LastUpdated:a.lastUpdated,platform2LastUpdated:r.lastUpdated}}const Ve="arbflow_symbol_";function yt(s){try{const e=localStorage.getItem(`${Ve}${s}`);return e?JSON.parse(e):null}catch{return null}}function It(s,e){try{localStorage.setItem(`${Ve}${s}`,JSON.stringify(e))}catch{}}function Nt({priceDiff:s,tradeSize:e,setTradeSize:n,positionMin:a,setPositionMin:r,positionMax:o,setPositionMax:i,tradeInterval:u,setTradeInterval:b,monitor2to1:E,setMonitor2to1:_,monitor1to2:w,setMonitor1to2:$,tradeLogs:y,setTradeLogs:k,onExecute:C,positionByExchange:f,onRebalance:S,entrySpread:D,shortExchangeId:F}){const L=c=>c.trim()!==""&&!isNaN(Number(c)),h=L(e)&&L(a)&&L(o),O=h&&L(E.threshold),G=h&&L(w.threshold),z=E.isMonitoring||w.isMonitoring,V=f[s.platform1Id]||0,Y=f[s.platform2Id]||0,T=V+Y,d=Math.abs(T)>1e-4,m=parseFloat(a)||0,g=parseFloat(o)||0,p=c=>Math.round(c*1e4)/1e4,x=c=>{if(!d)return;const v=p(Math.abs(T)),A=T<0?"+":"-",W=T<0?"long":"short";if(c===s.platform1Id){const P=W==="long"?v:-v,R=V+P;if(R<m||R>g)return}return{platformId:c,size:v,action:A,onRebalance:()=>S(c,v,W)}};return t.jsxs("div",{className:"mt-6 space-y-3",children:[t.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[t.jsx("span",{className:"flex-1 h-px bg-muted-foreground/40"}),"è‡ªåŠ¨äº¤æ˜“è®¾ç½®",t.jsx("span",{className:"flex-1 h-px bg-muted-foreground/40"})]}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[t.jsx("label",{className:"text-xs text-muted-foreground",children:"Step size:"}),t.jsxs("div",{className:"relative",children:[t.jsx("input",{type:"number",value:e,onChange:c=>n(c.target.value),disabled:z,step:"0.01",min:"0",className:`w-10 border-b border-muted-foreground/40 bg-transparent px-1 py-0.5 text-xs outline-none focus:border-muted-foreground [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none ${z?"cursor-not-allowed opacity-50":""}`}),e&&parseFloat(e)>0&&t.jsxs("span",{className:"absolute -top-4 left-0 whitespace-nowrap rounded bg-muted px-1 py-0.5 text-[10px] text-muted-foreground",children:["â‰ˆ",(parseFloat(e)*s.platform1Ask).toFixed(2),"u"]})]}),t.jsxs("span",{className:"text-xs text-muted-foreground",children:[s.platform1Id," Max"]}),t.jsxs("div",{className:"relative",children:[t.jsx("input",{type:"number",value:a,onChange:c=>r(c.target.value),disabled:z,step:"0.01",className:`w-20 border-b border-muted-foreground/40 bg-transparent px-1 py-0.5 text-xs outline-none focus:border-muted-foreground [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none ${z?"cursor-not-allowed opacity-50":""}`,placeholder:"æœ€å°"}),a&&parseFloat(a)!==0&&t.jsxs("span",{className:"absolute -top-4 left-0 whitespace-nowrap rounded bg-muted px-1 py-0.5 text-[10px] text-muted-foreground",children:["â‰ˆ",(Math.abs(parseFloat(a))*s.platform1Ask).toFixed(2),"u"]})]}),t.jsx("span",{className:"text-xs text-muted-foreground",children:"~"}),t.jsxs("div",{className:"relative",children:[t.jsx("input",{type:"number",value:o,onChange:c=>i(c.target.value),disabled:z,step:"0.01",className:`w-20 border-b border-muted-foreground/40 bg-transparent px-1 py-0.5 text-xs outline-none focus:border-muted-foreground [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none ${z?"cursor-not-allowed opacity-50":""}`,placeholder:"æœ€å¤§"}),o&&parseFloat(o)!==0&&t.jsxs("span",{className:"absolute -top-4 left-0 whitespace-nowrap rounded bg-muted px-1 py-0.5 text-[10px] text-muted-foreground",children:["â‰ˆ",(Math.abs(parseFloat(o))*s.platform1Ask).toFixed(2),"u"]})]}),t.jsx("span",{className:"text-xs text-muted-foreground",children:"é—´éš”"}),t.jsx("input",{type:"number",value:u,onChange:c=>b(c.target.value),disabled:z,step:"100",min:"0",className:`w-10 border-b border-muted-foreground/40 bg-transparent px-1 py-0.5 text-xs outline-none focus:border-muted-foreground [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none ${z?"cursor-not-allowed opacity-50":""}`,placeholder:"ms"}),t.jsx("span",{className:"text-xs text-muted-foreground",children:"ms"})]}),t.jsx(ze,{label:`-${s.platform1Id}+${s.platform2Id}`,spread:s.spread2to1,refPrice:s.platform2Ask,platform1LastUpdated:s.platform1LastUpdated,platform2LastUpdated:s.platform2LastUpdated,onExecute:()=>C("2to1"),monitorUnit:E.unit,monitorThreshold:E.threshold,isMonitoring:E.isMonitoring,isAnyMonitoring:z,canStartMonitor:O,onMonitorUnitToggle:()=>_(c=>({...c,unit:c.unit==="bps"?"usdt":"bps"})),onMonitorThresholdChange:c=>_(v=>({...v,threshold:c})),onMonitorToggle:()=>_(c=>({...c,isMonitoring:!c.isMonitoring})),rebalanceInfo:x(s.platform2Id),entrySpread:F===s.platform2Id?D:void 0}),t.jsx(ze,{label:`-${s.platform2Id}+${s.platform1Id}`,spread:s.spread1to2,refPrice:s.platform1Ask,platform1LastUpdated:s.platform1LastUpdated,platform2LastUpdated:s.platform2LastUpdated,onExecute:()=>C("1to2"),monitorUnit:w.unit,monitorThreshold:w.threshold,isMonitoring:w.isMonitoring,isAnyMonitoring:z,canStartMonitor:G,onMonitorUnitToggle:()=>$(c=>({...c,unit:c.unit==="bps"?"usdt":"bps"})),onMonitorThresholdChange:c=>$(v=>({...v,threshold:c})),onMonitorToggle:()=>$(c=>({...c,isMonitoring:!c.isMonitoring})),rebalanceInfo:x(s.platform1Id),entrySpread:F===s.platform1Id?D:void 0}),y.length>0&&t.jsxs("div",{className:"mt-2 max-h-32 overflow-y-auto rounded border border-border bg-muted/30 p-2",children:[t.jsxs("div",{className:"mb-1 flex items-center justify-between",children:[t.jsx("span",{className:"text-xs font-medium text-muted-foreground",children:"äº¤æ˜“æ—¥å¿—"}),t.jsx("button",{onClick:()=>k([]),className:"text-xs text-muted-foreground hover:text-foreground",children:"æ¸…ç©º"})]}),t.jsx("div",{className:"space-y-0.5",children:y.map(c=>{const v=c.timestamp,A=`${String(v.getHours()).padStart(2,"0")}:${String(v.getMinutes()).padStart(2,"0")}:${String(v.getSeconds()).padStart(2,"0")}.${String(v.getMilliseconds()).padStart(3,"0")}`;return t.jsxs("div",{className:"text-xs text-muted-foreground",children:[t.jsxs("span",{className:"text-foreground/60",children:["[",A,"]"]})," ",c.message]},c.id)})})]})]})}function At({pos:s,exchange:e}){var i;const n=(e==null?void 0:e.color)||"#6366f1",a=s.funding||0;s.unrealizedPnl+a;const r=a>=0?"+":"-",o=s.lastUpdated&&Date.now()-s.lastUpdated>6e4;return t.jsxs("div",{className:"grid grid-cols-[auto_40px_150px_1fr_60px] items-center gap-2 text-[10px]",children:[t.jsx("span",{className:"w-10 text-center px-1.5 py-0.5 text-black font-bold",style:{backgroundColor:n},children:s.exchangeId}),t.jsx("span",{className:`text-muted-foreground ${o?"opacity-50":""}`,children:`${ve(s.lastUpdated).timeStr}`}),t.jsxs("span",{className:"text-right",children:[s.side==="long"?"":"-",s.position,"(",(i=s.positionValue)==null?void 0:i.toFixed(2),"u)"]}),t.jsxs("span",{className:"text-muted-foreground",children:["å…¥ ",Ke(s.avgEntryPrice)," / fnd ",r,Math.abs(a).toFixed(2)]})]})}const kt=()=>new Audio(gt).play().catch(()=>{}),St=()=>new Audio(bt).play().catch(()=>{}),vt="1000",Et=5*60*1e3,jt=3e3,Tt=4e3,Fe=5*60*1e3;function _t({symbol:s,symbolState:e,exchanges:n,onDoTrades:a,globalTradeInterval:r,globalLastTradeTimeRef:o,globalLastRefreshTimeRef:i,consecutiveTriggerCount:u,onRefreshAllExchanges:b,autoRebalanceEnabled:E,soundEnabled:_}){var me,Ne,Ae,he,Le;const w=yt(s),[$,y]=l.useState((w==null?void 0:w.tradeSize)??""),[k,C]=l.useState((w==null?void 0:w.positionMin)??""),[f,S]=l.useState((w==null?void 0:w.positionMax)??""),[D,F]=l.useState((w==null?void 0:w.tradeInterval)??vt),[L,h]=l.useState({unit:((me=w==null?void 0:w.monitor2to1)==null?void 0:me.unit)??"usdt",threshold:((Ne=w==null?void 0:w.monitor2to1)==null?void 0:Ne.threshold)??"",isMonitoring:!1}),[O,G]=l.useState({unit:((Ae=w==null?void 0:w.monitor1to2)==null?void 0:Ae.unit)??"usdt",threshold:((he=w==null?void 0:w.monitor1to2)==null?void 0:he.threshold)??"",isMonitoring:!1}),[z,V]=l.useState([]),[Y,T]=l.useState(!1),d=l.useRef({"2to1":0,"1to2":0}),m=l.useRef({"2to1":0,"1to2":0}),g=l.useRef(null),p=l.useRef(!1),x=l.useRef(!1),c=l.useRef(0),v=l.useRef(0),A=((Le=e==null?void 0:e.positions)==null?void 0:Le.filter(j=>j.position!==0))||[],W=(e==null?void 0:e.exchangeMarketStats)||[],P=A.length>0,R=[...W].sort((j,N)=>j.exchangeId.localeCompare(N.exchangeId)),U=parseFloat($)||0,I=wt(R,n,U),Z=A.reduce((j,N)=>{const B=N.position||0;return j+(N.side==="long"?B:-B)},0),ne=Math.abs(Z)>1e-4,fe=A.reduce((j,N)=>{if(!N.exchangeId)return j;const B=N.position||0,H=N.side==="long"?B:-B;return j[N.exchangeId]=(j[N.exchangeId]||0)+H,j},{}),ye=L.isMonitoring||O.isMonitoring,X=(()=>{if(A.length<2)return null;const j=A.find(te=>te.side==="short"),N=A.find(te=>te.side==="long");if(!j||!N)return null;const B=j.avgEntryPrice-N.avgEntryPrice,H=(j.avgEntryPrice+N.avgEntryPrice)/2,q=B/H*100;return{value:B,percent:q,shortExchangeId:j.exchangeId}})(),J=j=>{c.current+=1,V(N=>[{id:c.current,timestamp:new Date,message:j},...N.slice(0,49)])},xe=l.useCallback(j=>{const N=Date.now(),B=N-i.current;p.current||B<Et||(p.current=!0,i.current=N,J(`[åˆ·æ–°] ${j}ï¼Œæ­£åœ¨åˆ·æ–°äº¤æ˜“æ‰€è¿žæŽ¥...`),b().then(()=>J("[åˆ·æ–°] äº¤æ˜“æ‰€è¿žæŽ¥å·²åˆ·æ–°")).catch(H=>J(`[é”™è¯¯] åˆ·æ–°å¤±è´¥: ${H.message}`)).finally(()=>{p.current=!1}))},[b]),Ie=l.useCallback(j=>I?j.reduce((N,B)=>{const H=B.direction==="long"?1:-1;return B.platform===I.platform1Id?N+H*B.size:N},0):0,[I]),oe=l.useCallback((j,N)=>{if(!I||j.length===0)return!1;const B=Date.now(),H=parseInt(D)||500,q=parseFloat(k)||0,te=parseFloat(f)||0,le=fe[I.platform1Id]||0,de=N==null?void 0:N.direction,pe=(N==null?void 0:N.skipPositionCheck)??!1,ge=(N==null?void 0:N.skipCooldown)??!1,be=(N==null?void 0:N.logPrefix)??"[äº¤æ˜“]",ke=Ie(j);if(!pe&&ke!==0){const se=le+ke,we=se>=q&&se<=te,Ye=le>te&&ke<0||le<q&&ke>0;if(!(we||Ye))return!1}if(!ge&&de){const se=B-d.current[de],we=B-o.current;if(se<H||we<r)return!1;d.current[de]=B,o.current=B}const Ee=j.map(se=>`${se.direction==="long"?"+":"-"}${se.platform}`).join("");return J(`${be} æ‰§è¡Œä¸­: ${Ee} ${j[0].size} ${s}`),a(j).then(()=>{J(`${be} å®Œæˆ: ${Ee}`),_&&kt()}).catch(se=>{var we;J(`[é”™è¯¯] ${Ee} äº¤æ˜“å¤±è´¥: ${se.message}`),_&&St(),(we=N==null?void 0:N.onError)==null||we.call(N,se.message,j)}),!0},[I,D,k,f,fe,r,s,a,_,Ie]),M=(j,N,B)=>{oe([{symbol:s,direction:B,size:N,platform:j}],{skipCooldown:!0,logPrefix:"[è¡¥é½]"})},K=l.useCallback(()=>{var de;if(!E||!I)return;const j=Date.now();if(j-v.current<Fe){J(`[è‡ªåŠ¨è¡¥é½] è·³è¿‡: å†·å´æ—¶é—´å†… (${Math.ceil((Fe-(j-v.current))/1e3)}s)`);return}const B=(((de=e==null?void 0:e.positions)==null?void 0:de.filter(pe=>pe.position!==0))||[]).reduce((pe,ge)=>{const be=ge.position||0;return pe+(ge.side==="long"?be:-be)},0);if(Math.abs(B)<=1e-4){J("[è‡ªåŠ¨è¡¥é½] è·³è¿‡: ä»“ä½å·²å¹³è¡¡");return}const H=Math.round(Math.abs(B)*1e4)/1e4,q=B<0?"long":"short",te={symbol:s,direction:q,size:H,platform:I.platform1Id};J(`[è‡ªåŠ¨è¡¥é½] å‡€ä»“ä½ ${B.toFixed(4)}ï¼Œåœ¨ ${I.platform1Id} ${q} ${H}`),oe([te],{skipCooldown:!0,logPrefix:"[è‡ªåŠ¨è¡¥é½]"})?v.current=Date.now():J("[è‡ªåŠ¨è¡¥é½] è·³è¿‡: ä»“ä½é™åˆ¶")},[E,I,s,e,oe]),ee=j=>{const N=parseFloat($)||0;if(N<=0||!I){alert("è¯·è¾“å…¥æœ‰æ•ˆçš„äº¤æ˜“æ•°é‡");return}const{platform1Id:B,platform2Id:H}=I;oe(j==="2to1"?[{symbol:s,direction:"short",size:N,platform:B},{symbol:s,direction:"long",size:N,platform:H}]:[{symbol:s,direction:"long",size:N,platform:B},{symbol:s,direction:"short",size:N,platform:H}],{skipCooldown:!0,skipPositionCheck:!0})},ae=l.useCallback(()=>{const j={tradeSize:$,positionMin:k,positionMax:f,tradeInterval:D,monitor2to1:{unit:L.unit,threshold:L.threshold},monitor1to2:{unit:O.unit,threshold:O.threshold}};It(s,j)},[s,$,k,f,D,L,O]);l.useEffect(()=>{ae()},[ae]),l.useEffect(()=>{if(!I)return;const j=Date.now();if(L.isMonitoring||O.isMonitoring){if(ne){g.current===null?g.current=j:j-g.current>=jt&&!x.current&&(x.current=!0,xe(`ä»“ä½ä¸å¯¹é½ (å‡€ä»“ä½: ${Z.toFixed(4)})`),setTimeout(()=>{E&&K(),x.current=!1,g.current=null},Tt));return}else g.current=null,x.current=!1;const H=ve(I.platform1LastUpdated),q=ve(I.platform2LastUpdated);if(H.skew||q.skew){const le=`${H.skew?I.platform1Id:""}${H.skew&&q.skew?"/":""}${q.skew?I.platform2Id:""}`;xe(`ä»·æ ¼æ•°æ®å»¶è¿Ÿ (${le})`);return}}const N=parseFloat($)||0,B=(H,q,te,le,de,pe)=>{if(!q.isMonitoring||N<=0){m.current[H]=0;return}const ge=parseFloat(q.threshold)||0;(q.unit==="bps"?te/le*1e4:te)>ge?m.current[H]+=1:m.current[H]=0,m.current[H]>=u&&oe([{symbol:s,direction:"short",size:N,platform:de},{symbol:s,direction:"long",size:N,platform:pe}],{direction:H})&&(m.current[H]=0)};B("2to1",L,I.spread2to1,I.platform2Ask,I.platform1Id,I.platform2Id),B("1to2",O,I.spread1to2,I.platform1Ask,I.platform2Id,I.platform1Id)},[I,L,O,$,s,ne,Z,u,xe,E,oe,K]);const ie=()=>{if(!ye||!I)return null;const j=[];return L.isMonitoring&&j.push(`-${I.platform1Id}+${I.platform2Id} > ${L.threshold}${L.unit==="bps"?"bp":"u"}`),O.isMonitoring&&j.push(`-${I.platform2Id}+${I.platform1Id} > ${O.threshold}${O.unit==="bps"?"bp":"u"}`),j.join(" | ")};return t.jsxs("div",{className:`rounded-md border p-3 border-dashed ${P?"border-muted-foreground/70":"border-muted-foreground/30"}`,children:[t.jsxs("div",{onClick:()=>T(!Y),className:"flex items-center justify-between cursor-pointer",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[Pe[s]&&t.jsx("img",{src:Pe[s],alt:s,className:"w-5 h-5 rounded-full"}),t.jsx("span",{className:"text-xl font-medium",children:s}),ne&&t.jsx("span",{className:"text-xs text-yellow-600",title:`å‡€ä»“ä½: ${Z.toFixed(4)}`,children:"âš  ä»“ä½æœªå¯¹é½"}),Y&&ye&&t.jsxs("span",{className:"text-xs text-yellow-500 bg-yellow-500/10 px-1.5 py-0.5 rounded",children:["[ç›‘æŽ§ä¸­] ",ie()]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[X&&t.jsxs("span",{className:"text-xs text-muted-foreground",children:["å…¥åœºä»·å·®"," ",t.jsxs("span",{className:X.value>=0?"text-green-500":"text-red-400",children:[X.value>=0?"+":"",X.value.toFixed(3),"u(",He(X.percent,{showSign:!0}),")"]})]}),t.jsx("button",{onClick:j=>{j.stopPropagation(),T(!Y)},className:"text-muted-foreground hover:text-foreground transition-colors",children:Y?"â–¶":"â–¼"})]})]}),!Y&&t.jsxs(t.Fragment,{children:[P&&t.jsx("div",{className:"mt-2 space-y-1",children:A.sort((j,N)=>(j.exchangeId||"").localeCompare(N.exchangeId||"")).map((j,N)=>t.jsx(At,{pos:j,exchange:n.find(B=>B.id===j.exchangeId)},N))}),I&&t.jsx(Nt,{priceDiff:I,tradeSize:$,setTradeSize:y,positionMin:k,setPositionMin:C,positionMax:f,setPositionMax:S,tradeInterval:D,setTradeInterval:F,monitor2to1:L,setMonitor2to1:h,monitor1to2:O,setMonitor1to2:G,tradeLogs:z,setTradeLogs:V,onExecute:ee,positionByExchange:fe,onRebalance:M,entrySpread:X==null?void 0:X.value,shortExchangeId:X==null?void 0:X.shortExchangeId})]})]})}const Q={WATCHED_SYMBOLS:"arbflow_watched_symbols",EXCHANGE_CONFIGS:"arbflow_exchange_configs",GLOBAL_TRADE_INTERVAL:"arbflow_global_trade_interval",CONSECUTIVE_TRIGGER_COUNT:"arbflow_consecutive_trigger_count",AUTO_REBALANCE_ON_ERROR:"arbflow_auto_rebalance_on_error",SOUND_ENABLED:"arbflow_sound_enabled"},Dt=1e3,Ct=2;function Lt(){const[s,e]=l.useState(Re),[n,a]=l.useState(Me),[r,o]=l.useState($e),[i,u]=l.useState(Dt),[b,E]=l.useState(Ct),[_,w]=l.useState(!1),[$,y]=l.useState(!0);l.useEffect(()=>{const h=localStorage.getItem(Q.WATCHED_SYMBOLS);if(h)try{e(JSON.parse(h))}catch{e(Re)}const O=localStorage.getItem(Q.EXCHANGE_CONFIGS);if(O)try{const T=JSON.parse(O);T.lighter&&a({...Me,...T.lighter}),T.omni&&o({...$e,...T.omni})}catch(T){console.error("[Settings] Failed to load configs:",T)}const G=localStorage.getItem(Q.GLOBAL_TRADE_INTERVAL);if(G){const T=parseInt(G,10);!isNaN(T)&&T>0&&u(T)}const z=localStorage.getItem(Q.CONSECUTIVE_TRIGGER_COUNT);if(z){const T=parseInt(z,10);!isNaN(T)&&T>0&&E(T)}const V=localStorage.getItem(Q.AUTO_REBALANCE_ON_ERROR);V&&w(V==="true");const Y=localStorage.getItem(Q.SOUND_ENABLED);Y&&y(Y==="true")},[]);const k=l.useCallback(h=>{e(h),localStorage.setItem(Q.WATCHED_SYMBOLS,JSON.stringify(h))},[]),C=l.useCallback(h=>{a(O=>{const G={...O,...h},z={lighter:G,omni:r};return localStorage.setItem(Q.EXCHANGE_CONFIGS,JSON.stringify(z)),G})},[r]),f=l.useCallback(h=>{o(O=>{const G={...O,...h},z={lighter:n,omni:G};return localStorage.setItem(Q.EXCHANGE_CONFIGS,JSON.stringify(z)),G})},[n]),S=l.useCallback(h=>{u(h),localStorage.setItem(Q.GLOBAL_TRADE_INTERVAL,String(h))},[]),D=l.useCallback(h=>{E(h),localStorage.setItem(Q.CONSECUTIVE_TRIGGER_COUNT,String(h))},[]),F=l.useCallback(h=>{w(h),localStorage.setItem(Q.AUTO_REBALANCE_ON_ERROR,String(h))},[]),L=l.useCallback(h=>{y(h),localStorage.setItem(Q.SOUND_ENABLED,String(h))},[]);return{watchedSymbols:s,saveWatchedSymbols:k,lighterConfig:n,saveLighterConfig:C,omniConfig:r,saveOmniConfig:f,globalTradeInterval:i,saveGlobalTradeInterval:S,consecutiveTriggerCount:b,saveConsecutiveTriggerCount:D,autoRebalanceEnabled:_,saveAutoRebalanceEnabled:F,soundEnabled:$,saveSoundEnabled:L}}function Ot(s){const e=new DataView(s);let n=0;function a(){const r=e.getUint8(n++);if(r<=127)return r;if(r>=128&&r<=143){const o=r&15,i={};for(let u=0;u<o;u++){const b=a();i[String(b)]=a()}return i}if(r>=144&&r<=159){const o=r&15,i=[];for(let u=0;u<o;u++)i.push(a());return i}if(r>=160&&r<=191){const o=r&31,i=new TextDecoder().decode(new Uint8Array(s,n,o));return n+=o,i}if(r===192)return null;if(r===194)return!1;if(r===195)return!0;if(r===196){const o=e.getUint8(n++),i=new Uint8Array(s,n,o);return n+=o,i}if(r===197){const o=e.getUint16(n);n+=2;const i=new Uint8Array(s,n,o);return n+=o,i}if(r===202){const o=e.getFloat32(n);return n+=4,o}if(r===203){const o=e.getFloat64(n);return n+=8,o}if(r===204)return e.getUint8(n++);if(r===205){const o=e.getUint16(n);return n+=2,o}if(r===206){const o=e.getUint32(n);return n+=4,o}if(r===207){const o=e.getUint32(n),i=e.getUint32(n+4);return n+=8,o*4294967296+i}if(r===208)return e.getInt8(n++);if(r===209){const o=e.getInt16(n);return n+=2,o}if(r===210){const o=e.getInt32(n);return n+=4,o}if(r===211){const o=e.getInt32(n),i=e.getUint32(n+4);return n+=8,o*4294967296+i}if(r===217){const o=e.getUint8(n++),i=new TextDecoder().decode(new Uint8Array(s,n,o));return n+=o,i}if(r===218){const o=e.getUint16(n);n+=2;const i=new TextDecoder().decode(new Uint8Array(s,n,o));return n+=o,i}if(r===219){const o=e.getUint32(n);n+=4;const i=new TextDecoder().decode(new Uint8Array(s,n,o));return n+=o,i}if(r===220){const o=e.getUint16(n);n+=2;const i=[];for(let u=0;u<o;u++)i.push(a());return i}if(r===221){const o=e.getUint32(n);n+=4;const i=[];for(let u=0;u<o;u++)i.push(a());return i}if(r===222){const o=e.getUint16(n);n+=2;const i={};for(let u=0;u<o;u++){const b=a();i[String(b)]=a()}return i}if(r===223){const o=e.getUint32(n);n+=4;const i={};for(let u=0;u<o;u++){const b=a();i[String(b)]=a()}return i}return r>=224?r-256:{_unknown:r,_offset:n-1}}try{return a()}catch(r){return{_error:r.message,_partial:!0}}}function We(s){return Array.isArray(s)?s.map(e=>{if(Array.isArray(e))return{price:Number(e[0])||0,quantity:Number(e[1])||0};if(e&&typeof e=="object"){const n=e;return{price:Number(n.price??n.p)||0,quantity:Number(n.size??n.quantity??n.q)||0}}return{price:0,quantity:0}}):[]}function Pt(s){if(!s)return null;const e=s.match(/[\/:](\d+)$/);return e?parseInt(e[1],10):null}const Rt={parse(s){if(!s||typeof s!="object")return null;if(s.order_book){const e=s.order_book,n=We(e.bids),a=We(e.asks);return{type:"orderBook",orderBook:{bids:n,asks:a},channel:s.channel}}if(s.market_stats){const e=s.market_stats;return{type:"marketStats",marketStats:{indexPrice:Number(e.index_price)||0,markPrice:Number(e.mark_price)||0,fundingRate:Number(e.current_funding_rate)||0},channel:s.channel}}return null},extractMarketIdFromChannel:Pt},Mt={parse(s){if(!s||typeof s!="object")return null;if(s.type==="quote"&&s.data){const e=s.data,n=Number(e.bid)||0,a=Number(e.ask)||0,r=e.instrument;return{type:"orderBook",orderBook:{bids:[{price:n,quantity:1}],asks:[{price:a,quantity:1}]},marketStats:{markPrice:Number(e.mark_price)||0,indexPrice:Number(e.index_price)||0},symbol:s.symbol||(r==null?void 0:r.underlying)}}if(s.bid!==void 0&&s.ask!==void 0){const e=Number(s.bid)||0,n=Number(s.ask)||0,a=s.instrument;return{type:"orderBook",orderBook:{bids:[{price:e,quantity:1e9}],asks:[{price:n,quantity:1e9}]},marketStats:{markPrice:Number(s.mark_price)||0,indexPrice:Number(s.index_price)||0},symbol:a==null?void 0:a.underlying}}return null}};function $t(s,e){return!e||typeof e!="object"?null:((s==null?void 0:s.toLowerCase())==="omni"?Mt:Rt).parse(e)}const De=[{id:"LG",name:"Lighter",color:"#6366f1",baseUrl:"https://app.lighter.xyz",enforceOpenTab:!1,tabId:null,currentUrl:null,currentSymbol:null,wsConnected:!1,accountInfo:null},{id:"OM",name:"Omni",color:"#f59e0b",baseUrl:"https://omni.variational.io",enforceOpenTab:!0,tabId:null,currentUrl:null,currentSymbol:null,wsConnected:!1,accountInfo:null}];function Ut(s){try{const n=new URL(s).pathname.split("/").filter(Boolean);if(n.length>0)return n[n.length-1].toUpperCase()}catch{}return null}function _e(s,e,n){if(!e||e.length===0)return s||[];if(!s||s.length===0||e.length>10){const o=e.filter(i=>i.quantity>0);return o.sort((i,u)=>n?u.price-i.price:i.price-u.price),o.slice(0,20)}const a=new Map;for(const o of s)a.set(o.price.toString(),o);for(const o of e)o.quantity===0?a.delete(o.price.toString()):a.set(o.price.toString(),o);const r=Array.from(a.values()).filter(o=>o.quantity>0);return r.sort((o,i)=>n?i.price-o.price:o.price-i.price),r.slice(0,20)}const zt={LG:!0,OM:!1};function Ft(s,e){const[n,a]=l.useState(De),[r,o]=l.useState([]),[i,u]=l.useState([]),b=l.useRef(new Map),E=l.useRef(null),_=l.useRef(null),w=l.useCallback(d=>n.find(m=>m.id===d),[n]),$=l.useCallback(d=>{const m=r.find(g=>g.symbol===d);return m||{symbol:d,positions:[],exchangeMarketStats:[]}},[r]),y=l.useCallback((d,m,g)=>{o(p=>{const x=p.findIndex(I=>I.symbol===d),c=x>=0?{...p[x]}:{symbol:d,positions:[],exchangeMarketStats:[]},v=zt[m]??!0,A=c.exchangeMarketStats.findIndex(I=>I.exchangeId===m);let W;if(v&&A>=0){const I=c.exchangeMarketStats[A].orderBook;W={bids:_e(I==null?void 0:I.bids,g.bids,!0),asks:_e(I==null?void 0:I.asks,g.asks,!1)}}else v?W={bids:_e(void 0,g.bids,!0),asks:_e(void 0,g.asks,!1)}:W=g;const P={exchangeId:m,orderBook:W,lastUpdated:Date.now()},R=[...c.exchangeMarketStats];A>=0?R[A]=P:R.push(P);const U={...c,exchangeMarketStats:R};if(x>=0){const I=[...p];return I[x]=U,I}return[...p,U]})},[]),k=l.useCallback((d,m,g,p="ui",x)=>{const c=Se.find(v=>v.abbreviation===d);c!=null&&c.positionUpdater&&c.positionUpdater.source!==p||o(v=>{let A=[...v];g&&(A=A.map(P=>({...P,positions:P.positions.filter(R=>R.exchangeId!==d)}))),x&&x.length>0&&(A=A.map(P=>x.includes(P.symbol)?{...P,positions:P.positions.filter(R=>R.exchangeId!==d)}:P));const W=Date.now();for(const P of m){const R=A.findIndex(U=>U.symbol===P.symbol);if(R>=0){const U={...A[R]},I=U.positions.findIndex(ne=>ne.exchangeId===d),Z={...P,exchangeId:d,lastUpdated:W};I>=0?(U.positions=[...U.positions],U.positions[I]=Z):U.positions=[...U.positions,Z],A[R]=U}else A.push({symbol:P.symbol,positions:[{...P,exchangeId:d,lastUpdated:W}],exchangeMarketStats:[]})}return A})},[]),C=l.useCallback((d,m)=>{const g=[],p=[];for(const x of d){const c=parseFloat(x.position),v=parseFloat(x.avg_entry_price);if(c===0&&v===0){g.push(x.symbol);continue}const A=parseFloat(x.position_value),W=parseFloat(x.unrealized_pnl),P=c!==0?A/c:0,R=c*v,U=R!==0?W/R*100:0;p.push({symbol:x.symbol,position:Math.abs(c),side:x.sign>0?"long":"short",leverage:x.initial_margin_fraction?(100/parseFloat(x.initial_margin_fraction)).toFixed(1)+"x":void 0,avgEntryPrice:v,markPrice:P,positionValue:Math.abs(A),unrealizedPnl:W,unrealizedPnlPercent:U,funding:parseFloat(x.total_funding_paid_out||"0"),liquidationPrice:x.liquidation_price?parseFloat(x.liquidation_price):null})}k("LG",p,m,"websocket",g)},[k]),f=l.useCallback(async d=>{var m;console.log("[Arbflow] Fetching OM account info, tabId:",d);try{const g=await chrome.scripting.executeScript({target:{tabId:d},func:()=>fetch("https://omni.variational.io/api/settlement_pools/existing").then(x=>x.ok?x.json():null).then(x=>(console.log("[Arbflow] OM account info:",x),(x==null?void 0:x.address_other)||null)).catch(()=>null)});console.log("[Arbflow] OM script result:",g);const p=(m=g==null?void 0:g[0])==null?void 0:m.result;p&&a(x=>{var v;const c=x.find(A=>A.id==="OM");return((v=c==null?void 0:c.accountInfo)==null?void 0:v.walletAddress)===p?x:x.map(A=>A.id==="OM"?{...A,accountInfo:{...A.accountInfo,walletAddress:p}}:A)})}catch(g){console.error("[Arbflow] Failed to fetch OM account info:",g)}},[]),S=l.useCallback(async()=>{var g;const d={};for(const p of De){const x=await chrome.tabs.query({url:`${p.baseUrl}/*`});if(x.length>0){const c=x[0];d[p.id]={tabId:c.id??null,currentUrl:c.url??null,currentSymbol:c.url?Ut(c.url):null}}else d[p.id]={tabId:null,currentUrl:null,currentSymbol:null}}a(p=>p.map(x=>({...x,...d[x.id]})));const m=(g=d.OM)==null?void 0:g.tabId;m&&f(m)},[f]),D=l.useCallback((d,m,g,p,x)=>{const{orderBookConfig:c}=d,v=d.abbreviation;console.log(`[Arbflow] Connecting ${d.name} WebSocket${p?` for ${p}`:""}`);try{const A=new WebSocket(c.url);v==="LG"&&(A.binaryType="arraybuffer");const W={ws:A,exchangeId:v,symbol:p,symbols:m.map(P=>P.symbol),marketId:x};b.current.set(g,W),A.onopen=()=>{if(console.log(`[Arbflow] ${d.name} WebSocket connected${p?` for ${p}`:""}`),a(P=>P.map(R=>R.id===v?{...R,wsConnected:!0}:R)),c.getSubscribeMessages){const P=c.getSubscribeMessages(c.sendRequestPerSymbol?m[0]:m);for(const R of P)A.send(typeof R=="string"?R:JSON.stringify(R))}c.pingInterval&&(W.pingInterval=setInterval(()=>{A.readyState===WebSocket.OPEN&&A.send(JSON.stringify({type:"ping"}))},c.pingInterval))},A.onmessage=P=>{try{let R;if(v==="LG"?R=Ot(P.data):R=JSON.parse(P.data),R.type==="ping"){A.send(JSON.stringify({type:"pong"}));return}const U=$t(d.id,R);if((U==null?void 0:U.type)==="orderBook"&&U.orderBook){let I=U.symbol;!I&&x!==void 0&&(I=rt[x]),I&&y(I,v,U.orderBook)}}catch(R){console.error(`[Arbflow] Failed to parse ${d.name} message:`,R)}},A.onclose=()=>{console.log(`[Arbflow] ${d.name} WebSocket closed${p?` for ${p}`:""}`),W.pingInterval&&clearInterval(W.pingInterval),b.current.delete(g),Array.from(b.current.values()).some(R=>R.exchangeId===v)||a(R=>R.map(U=>U.id===v?{...U,wsConnected:!1}:U))},A.onerror=P=>{console.error(`[Arbflow] ${d.name} WebSocket error${p?` for ${p}`:""}:`,P),W.pingInterval&&clearInterval(W.pingInterval),b.current.delete(g)}}catch(A){console.error(`[Arbflow] Failed to connect ${d.name} WebSocket:`,A)}},[y]),F=l.useCallback(d=>{const m=d.map(g=>ot.find(p=>p.symbol===g)).filter(g=>g!==void 0);if(m.length!==0)for(const g of Se){const{orderBookConfig:p,abbreviation:x}=g;if(p.sendRequestPerSymbol)for(const c of m){const v=Ce[c.symbol];if(v===void 0)continue;const A=`${x}-${c.symbol}`,W=b.current.get(A);W&&W.ws.readyState!==WebSocket.CLOSED||D(g,[c],A,c.symbol,v)}else{const c=`${x}-all`,v=b.current.get(c);if(v&&v.ws.readyState!==WebSocket.CLOSED)return;D(g,m,c)}}},[D]),L=l.useCallback(async()=>{console.log("[Arbflow] Fetching exchange account info"),console.log("[Arbflow] Lighter config:",e),e!=null&&e.l1Address&&(console.log("[Arbflow] Lighter l1Address:",e.l1Address),a(d=>{var g;const m=d.find(p=>p.id==="LG");return((g=m==null?void 0:m.accountInfo)==null?void 0:g.walletAddress)===e.l1Address?d:d.map(p=>p.id==="LG"?{...p,accountInfo:{walletAddress:e.l1Address}}:p)})),a(d=>{var g;const m=d.find(p=>p.id==="OM");return console.log("[Arbflow] OM exchange check:",m==null?void 0:m.tabId,m==null?void 0:m.accountInfo),m!=null&&m.tabId&&!((g=m.accountInfo)!=null&&g.walletAddress)&&f(m.tabId),d})},[e==null?void 0:e.l1Address,f]),h=l.useCallback(async()=>{if(!(e!=null&&e.accountIndex)||!(e!=null&&e.apiPrivateKey)){console.log("[Arbflow] Lighter config incomplete, skipping ws connection");return}if(E.current&&E.current.readyState!==WebSocket.CLOSED){console.log("[Arbflow] Lighter ws already connected");return}const d=e.accountIndex,m=e.apiKeyIndex;console.log(`[Arbflow] Connecting Lighter WebSocket for account ${d}`);let g;try{g=await ut(e.apiPrivateKey,m,d),console.log("[Arbflow] Auth token created:",g?`${g.slice(0,20)}...`:"EMPTY")}catch(p){console.error("[Arbflow] Failed to create auth token:",p);return}try{const p=new WebSocket(at);E.current=p,p.onopen=()=>{console.log("[Arbflow] Lighter WebSocket connected");const x=[{type:"subscribe",channel:`account_all_positions/${d}`},{type:"subscribe",channel:`user_stats/${d}`,auth:g}];for(const c of x)p.send(JSON.stringify(c));console.log("[Arbflow] Subscribed to:",x.map(c=>c.channel).join(", ")),_.current=setInterval(()=>{p.readyState===WebSocket.OPEN&&p.send(JSON.stringify({type:"ping"}))},5e3)},p.onmessage=x=>{try{const c=JSON.parse(x.data);if(c.type==="ping"){p.send(JSON.stringify({type:"pong"}));return}const A=`[${new Date().toLocaleTimeString()}] ${c.type||"unknown"}`;if(u(W=>[A,...W].slice(0,50)),c.type==="subscribed/account_all_positions"&&c.positions){const W=[];for(const[,P]of Object.entries(c.positions))W.push(P);C(W,!0)}else if(c.type==="update/account_all_positions"&&c.positions){const W=[];for(const[,P]of Object.entries(c.positions))W.push(P);C(W,!1)}else if((c.type==="subscribed/user_stats"||c.type==="update/user_stats")&&c.stats){const W=parseFloat(c.stats.portfolio_value),P=parseFloat(c.stats.leverage);a(R=>R.map(U=>{var I,Z,ne;return U.id==="LG"?{...U,accountInfo:{...U.accountInfo,walletAddress:((I=U.accountInfo)==null?void 0:I.walletAddress)||"",portfolioValue:isNaN(W)?(Z=U.accountInfo)==null?void 0:Z.portfolioValue:W,leverage:isNaN(P)?(ne=U.accountInfo)==null?void 0:ne.leverage:P}}:U}))}}catch(c){console.error("[Arbflow] Failed to parse Lighter ws message:",c)}},p.onclose=()=>{console.log("[Arbflow] Lighter WebSocket closed"),E.current=null,_.current&&(clearInterval(_.current),_.current=null)},p.onerror=x=>{console.error("[Arbflow] Lighter WebSocket error:",x),E.current=null,_.current&&(clearInterval(_.current),_.current=null)}}catch(p){console.error("[Arbflow] Failed to connect Lighter WebSocket:",p)}},[e==null?void 0:e.accountIndex,e==null?void 0:e.apiPrivateKey,e==null?void 0:e.apiKeyIndex,C]),O=l.useCallback(()=>{_.current&&(clearInterval(_.current),_.current=null),E.current&&(E.current.close(),E.current=null,u([]))},[]);l.useEffect(()=>{const d=m=>{if(m.target==="sidepanel")switch(m.type){case"TAB_UPDATED":case"TAB_CREATED":case"TAB_REMOVED":case"CONTENT_SCRIPT_READY":S();break;case"POSITIONS":k(m.exchange,m.positions,m.isFullUpdate,"ui");break;case"ACCOUNT_INFO":a(g=>g.map(p=>{var x;return p.id===m.exchange?{...p,accountInfo:{...p.accountInfo,walletAddress:((x=p.accountInfo)==null?void 0:x.walletAddress)||"",portfolioValue:m.portfolioValue,leverage:m.leverage}}:p}));break}};return chrome.runtime.onMessage.addListener(d),S(),()=>{chrome.runtime.onMessage.removeListener(d)}},[S,k]),l.useEffect(()=>{s.length>0&&(F(s),h(),L())},[s,F,h,L]),l.useEffect(()=>{e!=null&&e.l1Address&&a(d=>{var g;const m=d.find(p=>p.id==="LG");return((g=m==null?void 0:m.accountInfo)==null?void 0:g.walletAddress)===e.l1Address?d:d.map(p=>p.id==="LG"?{...p,accountInfo:{walletAddress:e.l1Address}}:p)})},[e==null?void 0:e.l1Address]);const G=l.useCallback(async d=>{const m=De.find(g=>g.id===d);m&&await chrome.tabs.create({url:m.baseUrl,active:!0})},[]),z=l.useCallback(async d=>{await chrome.tabs.update(d,{active:!0});const m=await chrome.tabs.get(d);await chrome.windows.update(m.windowId,{focused:!0})},[]),V=l.useCallback(async d=>{await chrome.tabs.reload(d)},[]),Y=l.useCallback(()=>{b.current.forEach(d=>{d.pingInterval&&clearInterval(d.pingInterval),d.ws.readyState===WebSocket.OPEN&&d.ws.close()}),b.current.clear(),a(d=>d.map(m=>({...m,wsConnected:!1})))},[]),T=l.useCallback(async()=>{for(const d of n)if(d.enforceOpenTab)try{d.tabId?await chrome.tabs.reload(d.tabId):await chrome.tabs.create({url:d.baseUrl,active:!1})}catch(m){console.error(`[Arbflow] Failed to reload ${d.name}:`,m)}await new Promise(d=>setTimeout(d,2e3)),await S(),Y(),O(),await new Promise(d=>setTimeout(d,500)),s.length>0&&(F(s),h())},[n,S,s,F,Y,h,O]);return{exchanges:n,symbolStates:r,lighterWsMessages:i,getExchangeById:w,getOrCreateSymbolState:$,openExchange:G,focusTab:z,refreshTab:V,refreshAllExchanges:T,scanOpenExchanges:S,connectLighterWs:h,disconnectLighterWs:O}}function Wt({exchanges:s,symbolStates:e,lighterConfig:n,saveLighterConfig:a}){const r=l.useRef(null),o=l.useCallback(y=>s.find(k=>k.id===y),[s]),i=l.useCallback(async()=>{if(!n.l1Address||!n.apiPrivateKey)return!1;try{r.current=new dt;const y=await r.current.initialize({l1Address:n.l1Address,apiPrivateKey:n.apiPrivateKey,apiKeyIndex:n.apiKeyIndex,accountIndex:n.accountIndex});return a({accountIndex:y}),console.log("[LighterAPI] Initialized with account index:",y),!0}catch(y){return console.error("[LighterAPI] Init failed:",y),r.current=null,!1}},[n,a]),u=l.useCallback(async(y,k)=>new Promise(C=>{chrome.tabs.sendMessage(y,{type:"EXECUTE_TRADE_STEP",step:k},f=>{chrome.runtime.lastError?C({success:!1,error:chrome.runtime.lastError.message}):f!=null&&f.success?C({success:!0}):C({success:!1,error:(f==null?void 0:f.error)||"Unknown error"})})}),[]),b=l.useCallback(async(y,k)=>new Promise(C=>{chrome.tabs.sendMessage(y,{type:"GET_TRADE_STATE",platform:k},f=>{chrome.runtime.lastError?C({direction:null,size:""}):C(f||{direction:null,size:""})})}),[]),E=l.useCallback(async(y,k,C,f)=>{var z;const S=o(y);if(!(S!=null&&S.tabId))throw new Error(`${y} page not open`);const D=Se.find(V=>V.abbreviation===y);if(!((z=D==null?void 0:D.tradeSimulator)!=null&&z.getSteps))throw new Error(`${y} tradeSimulator not configured`);const F=S.currentSymbol,L=(F==null?void 0:F.toUpperCase())===k.toUpperCase(),h=await b(S.tabId,y),O=L&&h.direction===C&&h.size===String(f),G=D.tradeSimulator.getSteps(k,C,f,{skipSymbolSelection:L,skipDirectionAndSize:O});return{exchange:S,steps:G}},[o,b]),_=l.useCallback(async(y,k,C,f)=>{const S=C==="long"?"buy":"sell";if(y==="LG"){if(!r.current){if(!n.l1Address||!n.apiPrivateKey||!n.accountIndex)throw new Error("Please configure Lighter API first");if(!await i())throw new Error("Lighter API initialization failed")}return r.current.createMarketOrder(k,S,f)}if(y==="OM"){const D=o(y);if(!(D!=null&&D.tabId))throw new Error(`${y} page not open`);return new Promise((F,L)=>{var G;const h=setTimeout(()=>{L(new Error("API trade timeout"))},3e4),O=z=>{z.target==="sidepanel"&&(z.type==="TRADE_ORDER"?(clearTimeout(h),chrome.runtime.onMessage.removeListener(O),F(z.orderData)):z.type==="TRADE_ERROR"&&(clearTimeout(h),chrome.runtime.onMessage.removeListener(O),L(new Error(z.error))))};chrome.runtime.onMessage.addListener(O),chrome.tabs.sendMessage(D.tabId,{type:"TRADE",exchangeId:y,params:{underlying:k,size:f,side:S,maxSlippage:.005,walletAddress:(G=D.accountInfo)==null?void 0:G.walletAddress}}).catch(z=>{clearTimeout(h),chrome.runtime.onMessage.removeListener(O),L(z)})})}throw new Error(`Unsupported exchange: ${y}`)},[n,i,o]),w=l.useCallback(async(y,k,C,f)=>{const{exchange:S,steps:D}=await E(y,k,C,f);for(let F=0;F<D.length;F++){const L=D[F];console.log(`[Arbflow] ${y} step ${F+1}/${D.length}: ${L.description}`);const h=await u(S.tabId,L);if(!h.success)throw new Error(h.error)}},[E,u]);return{doTrades:l.useCallback(async y=>{if(y.length===0)return;console.log("[Arbflow] Executing trades:",y);const k=y.find(f=>{const S=Se.find(D=>D.abbreviation===f.platform);return(S==null?void 0:S.tradeExecutor)!=="api"});if(k){const f=o(k.platform);f!=null&&f.tabId&&(await chrome.tabs.update(f.tabId,{active:!0}),await new Promise(S=>setTimeout(S,200)))}const C=async f=>{const S=Se.find(F=>F.abbreviation===f.platform),D=(S==null?void 0:S.tradeExecutor)||"simulate";try{return D==="api"?await _(f.platform,f.symbol,f.direction,f.size):await w(f.platform,f.symbol,f.direction,f.size)}catch(F){const L=F instanceof Error?F.message:String(F);throw new Error(`[${f.platform}] ${L}`)}};await Promise.all(y.map(C)),console.log("[Arbflow] Trades completed")},[o,_,w]),initializeLighterApi:i,fetchLighterAccountIndex:Ge}}const Bt=460;function Gt(){const[s,e]=l.useState(window.innerWidth);return l.useEffect(()=>{const n=()=>e(window.innerWidth);return window.addEventListener("resize",n),()=>window.removeEventListener("resize",n)},[]),s}function Kt(){return t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-background/95 backdrop-blur-sm",children:t.jsxs("div",{className:"flex items-center gap-4 text-muted-foreground",children:[t.jsx("div",{className:"flex h-12 w-12 animate-pulse items-center justify-center rounded-full bg-muted",children:t.jsx("svg",{className:"h-6 w-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),t.jsx("span",{className:"text-lg font-medium",children:"å‘å·¦æ‹–åŠ¨æ‰©å±•è§†å›¾"})]})})}function Ht(){var ye,X,J,xe,Ie,oe;const e=Gt()<Bt,[n,a]=l.useState(null),[r,o]=l.useState(!0),[i,u]=l.useState(!1);l.useEffect(()=>{const M=async()=>{if(await et()){const ae=await tt();a(ae),st().then(async ie=>{ie&&(ie.isActive===!1?(await Oe(),a(null),u(!0)):a(me=>me?{...me,user:ie}:null))})}else a(null);o(!1)};M();const K=ee=>{ee.type==="AUTH_SUCCESS"&&(u(!1),M())};return chrome.runtime.onMessage.addListener(K),()=>chrome.runtime.onMessage.removeListener(K)},[]);const b=async()=>{await Oe(),a(null)},{watchedSymbols:E,saveWatchedSymbols:_,lighterConfig:w,saveLighterConfig:$,globalTradeInterval:y,saveGlobalTradeInterval:k,consecutiveTriggerCount:C,saveConsecutiveTriggerCount:f,autoRebalanceEnabled:S,saveAutoRebalanceEnabled:D,soundEnabled:F,saveSoundEnabled:L}=Lt(),h=l.useRef(0),O=l.useRef(0),{exchanges:G,symbolStates:z,openExchange:V,focusTab:Y,refreshTab:T,refreshAllExchanges:d}=Ft(E,w),{doTrades:m}=Wt({exchanges:G,symbolStates:z,lighterConfig:w,saveLighterConfig:$}),[g,p]=l.useState(!1),[x,c]=l.useState(!1),[v,A]=l.useState(null),[W,P]=l.useState(!1),R=l.useRef(null);l.useEffect(()=>{const M=K=>{R.current&&!R.current.contains(K.target)&&c(!1)};return x&&document.addEventListener("mousedown",M),()=>document.removeEventListener("mousedown",M)},[x]);const U=l.useCallback((M,K)=>{A({message:M,isSuccess:K})},[]),I=async()=>{P(!0),U("Refreshing exchanges...",!0);try{await d(),U("âœ“ Exchanges refreshed",!0)}catch(M){U(`Refresh failed: ${M.message}`,!1)}finally{P(!1)}},Z=async M=>{try{const K=M.length===1?`${M[0].platform} ${M[0].direction}`:M.map(ee=>`${ee.direction==="long"?"+":"-"}${ee.platform}`).join("");U(`Executing ${K}...`,!0),await m(M),U("âœ“ Trade completed",!0)}catch(K){throw U(`Trade failed: ${K.message}`,!1),K}},ne=async M=>{try{const K=await Ge(M.l1Address||w.l1Address,M.accountType||w.accountType);return $({...M,accountIndex:K}),{success:!0,accountIndex:K}}catch(K){return $(M),{success:!1,error:K.message}}},fe=[...E].sort((M,K)=>(Ce[M]??999)-(Ce[K]??999));return r?t.jsx("div",{className:"flex min-h-screen items-center justify-center bg-background",children:t.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-2 border-primary border-t-transparent"})}):n?t.jsxs("div",{className:"flex min-h-screen flex-col bg-background text-foreground",children:[t.jsxs("header",{className:"flex items-center justify-between px-4 py-3",children:[t.jsx("div",{className:"flex items-center gap-3",children:t.jsx("h1",{className:"text-lg font-semibold",children:"Arbflow"})}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:I,disabled:W,className:"cursor-pointer rounded  px-3 py-1.5 text-sm hover:bg-muted disabled:opacity-50",children:W?"â†»...":"â†»"}),t.jsx("button",{onClick:()=>p(!0),className:"cursor-pointer rounded  px-3 py-1.5 text-sm hover:bg-muted",children:"âš™"}),t.jsxs("div",{className:"relative flex items-center gap-2",ref:R,children:[((ye=n.user)==null?void 0:ye.level)!=null&&t.jsxs("span",{className:"rounded bg-primary/20 px-1.5 py-0.5 text-xs text-primary",children:["Lv.",n.user.level]}),t.jsx("button",{onClick:()=>c(!x),className:"flex h-8 w-8 cursor-pointer items-center justify-center overflow-hidden rounded-full bg-primary/20 text-sm font-medium text-primary transition-colors hover:bg-primary/30",children:(X=n.user)!=null&&X.image?t.jsx("img",{src:n.user.image,alt:"",className:"h-full w-full object-cover"}):((xe=(J=n.user)==null?void 0:J.email)==null?void 0:xe.charAt(0).toUpperCase())||"?"}),x&&t.jsxs("div",{className:"absolute right-0 top-10 z-50 min-w-48 rounded-lg border border-border bg-background p-3 shadow-lg",children:[t.jsxs("div",{className:"mb-3 space-y-1",children:[t.jsx("p",{className:"text-sm font-medium",children:(Ie=n.user)==null?void 0:Ie.email}),((oe=n.user)==null?void 0:oe.level)!=null&&t.jsxs("p",{className:"text-xs text-muted-foreground",children:["ç­‰çº§:"," ",t.jsxs("span",{className:"rounded bg-primary/20 px-1.5 py-0.5 text-primary",children:["Lv.",n.user.level]})]})]}),t.jsx("button",{onClick:()=>{b(),c(!1)},className:"w-full cursor-pointer rounded-md bg-muted px-3 py-1.5 text-sm text-muted-foreground transition-colors hover:bg-muted/80 hover:text-foreground",children:"ç™»å‡º"})]})]})]})]}),t.jsxs("div",{className:"flex flex-col gap-2 px-4 pb-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-xs text-muted-foreground",children:"å…¨å±€äº¤æ˜“é—´éš”:"}),t.jsx("input",{type:"number",value:y,onChange:M=>k(Math.max(100,parseInt(M.target.value,10)||1e3)),className:"w-12 border-b border-muted-foreground/40 bg-transparent px-1 py-0.5 text-xs outline-none focus:border-muted-foreground [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none",min:100,step:100}),t.jsx("span",{className:"text-xs text-muted-foreground",children:"ms"}),t.jsx("span",{className:"ml-4 text-xs text-muted-foreground",children:"è¿žç»­è§¦å‘æ¬¡æ•°é˜ˆå€¼:"}),t.jsx("input",{type:"number",value:C,onChange:M=>{const K=parseInt(M.target.value,10);f(isNaN(K)?1:Math.max(1,K))},className:"w-12 border-b border-muted-foreground/40 bg-transparent px-1 py-0.5 text-xs outline-none focus:border-muted-foreground [appearance:textfield] ",min:1,step:1})]}),t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsxs("label",{className:"flex cursor-pointer items-center gap-2",children:[t.jsx("span",{className:"text-xs text-muted-foreground",children:"æç¤ºéŸ³"}),t.jsx("button",{onClick:()=>L(!F),className:`relative h-5 w-9 rounded-full transition-colors ${F?"bg-primary":"bg-muted-foreground/30"}`,children:t.jsx("span",{className:`absolute left-0.5 top-0.5 h-4 w-4 rounded-full bg-white transition-transform ${F?"translate-x-4":"translate-x-0"}`})})]}),t.jsxs("label",{className:"flex cursor-pointer items-center gap-2",children:[t.jsx("span",{className:"text-xs text-muted-foreground",children:"è‡ªåŠ¨è¡¥é½"}),t.jsx("button",{onClick:()=>D(!S),className:`relative h-5 w-9 rounded-full transition-colors ${S?"bg-primary":"bg-muted-foreground/30"}`,children:t.jsx("span",{className:`absolute left-0.5 top-0.5 h-4 w-4 rounded-full bg-white transition-transform ${S?"translate-x-4":"translate-x-0"}`})})]})]})]}),t.jsxs("main",{className:"flex-1 overflow-y-auto p-4",children:[t.jsx("section",{children:fe.length===0?t.jsx("div",{className:"rounded-lg border border-dashed p-8 text-center text-muted-foreground",children:"No symbols selected. Click Settings to add symbols."}):t.jsx("div",{className:"space-y-4",children:fe.map(M=>t.jsx(_t,{symbol:M,symbolState:z.find(K=>K.symbol===M),exchanges:G,onDoTrades:Z,globalTradeInterval:y,globalLastTradeTimeRef:h,globalLastRefreshTimeRef:O,consecutiveTriggerCount:C,onRefreshAllExchanges:d,autoRebalanceEnabled:S,soundEnabled:F},M))})}),t.jsxs("section",{className:"mt-6",children:[t.jsx("h2",{className:"mb-3 text-sm font-medium text-muted-foreground",children:"Exchanges"}),t.jsx("span",{className:"text-xs text-muted-foreground",children:(()=>{var Ne,Ae;const M=(Ne=G.find(he=>he.id==="LG"))==null?void 0:Ne.accountInfo,K=(Ae=G.find(he=>he.id==="OM"))==null?void 0:Ae.accountInfo,ee=M==null?void 0:M.portfolioValue,ae=K==null?void 0:K.portfolioValue;if(ee==null&&ae==null)return null;const ie=[];ee!=null&&ie.push(`LG(${ee.toFixed(1)})`),ae!=null&&ie.push(`OM(${ae.toFixed(1)})`);const me=(ee??0)+(ae??0);return t.jsxs(t.Fragment,{children:[ie.join(" + ")," = ",t.jsx("span",{className:"font-semibold",children:me.toFixed(1)})]})})()}),t.jsx("div",{className:"space-y-2 mt-2",children:G.map(M=>t.jsx(mt,{exchange:M,symbolStates:z,onOpen:()=>V(M.id),onFocus:()=>M.tabId&&Y(M.tabId),onRefresh:()=>M.tabId&&T(M.tabId)},M.id))})]})]}),t.jsx(ft,{open:g,onClose:()=>p(!1),watchedSymbols:E,onSaveSymbols:_,lighterConfig:w,onSaveLighterConfig:ne}),t.jsx(ht,{message:(v==null?void 0:v.message)||null,isSuccess:(v==null?void 0:v.isSuccess)??!0}),e&&t.jsx(Kt,{})]}):t.jsx(pt,{accountDisabled:i})}Je.createRoot(document.getElementById("app")).render(t.jsx(Qe.StrictMode,{children:t.jsx(Ht,{})}));
