import{E as B}from"./chunk-CgcjkoXT.js";const l=window.location.hostname.includes("lighter.xyz")?"lighter":window.location.hostname.includes("variational.io")?"omni":window.location.hostname.includes("arbflow.io")?"arbflow":null;function y(t){return t&&B.find(e=>e.id===t)||null}console.log("[Arbflow] Content script loaded, SITE_TYPE:",l);l==="arbflow"&&(console.log("[Arbflow] Arbflow.io detected, setting up bridge listener..."),G());function G(){let t=!1;const e=()=>{if(t)return!0;if(!window.location.pathname.includes("/extension/bridge"))return!1;const s=document.querySelector('meta[name="ext-one-time-code"]'),u=s==null?void 0:s.getAttribute("content");return u?(console.log("[Arbflow] Found auth code, sending to background"),t=!0,chrome.runtime.sendMessage({type:"AUTH_CODE_RECEIVED",code:u}).catch(()=>{}),!0):!1},o=()=>{if(e())return;const s=new MutationObserver(()=>{e()&&s.disconnect()});s.observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["content"]}),setTimeout(()=>{t||s.disconnect()},6e4)};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",o):o();let r=window.location.href;const n=setInterval(()=>{if(t){clearInterval(n);return}window.location.href!==r&&(r=window.location.href,console.log("[Arbflow] URL changed to:",r),setTimeout(e,500))},500);setTimeout(()=>clearInterval(n),12e4)}l||console.log("[Arbflow] Unknown site, content script disabled");function X(t){return new Promise((e,o)=>{const r=document.createElement("script");r.src=chrome.runtime.getURL(t),r.onload=()=>{r.remove(),e()},r.onerror=o,(document.head||document.documentElement).appendChild(r)})}async function Y(){console.log("[Arbflow] Injecting interceptor scripts...");try{await X("injected/index.js"),console.log("[Arbflow] âœ… Interceptor scripts loaded")}catch(t){console.log("[Arbflow] âŒ Failed to load interceptor:",t)}}(l==="omni"||l==="lighter")&&Y();window.addEventListener("message",t=>{var n,s;if(t.source!==window||!((s=(n=t.data)==null?void 0:n.type)!=null&&s.startsWith("ARBFLOW_")))return;const{type:e,...o}=t.data,r=e.replace("ARBFLOW_","");chrome.runtime.sendMessage({type:r,target:"sidepanel",site:l,...o}).catch(()=>{})});const p=new Map;let b=null;function J(t){var o;const e=document.querySelector(t);return e?{exists:!0,selector:t,tagName:e.tagName.toLowerCase(),text:(o=e.textContent)==null?void 0:o.trim().slice(0,100),disabled:e.disabled||e.getAttribute("aria-disabled")==="true",visible:e.offsetParent!==null,className:e.className}:{exists:!1,selector:t}}function z(){const t={};for(const[e]of p)t[e]=J(e);return t}function H(t="update"){const e={type:"ELEMENT_UPDATE",site:l,url:window.location.href,reason:t,elements:z(),timestamp:Date.now()};chrome.runtime.sendMessage(e).catch(()=>{})}function $(){if(!b){if(!document.body){document.addEventListener("DOMContentLoaded",$);return}b=new MutationObserver(t=>{let e=!1;for(const o of t){if(o.type==="childList"||o.type==="attributes")for(const[r]of p){const n=document.querySelector(r);if(n&&(o.target===n||o.target.contains(n)||n.contains(o.target))){e=!0;break}}if(e)break}e&&H("mutation")}),b.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["disabled","aria-disabled","class","style"]})}}function K(){b&&(b.disconnect(),b=null)}chrome.runtime.onMessage.addListener((t,e,o)=>{var r;if(t.type==="WATCH_ELEMENTS"){p.clear();for(const n of t.selectors||[])p.set(n,!0);return p.size>0?($(),H("watch_start")):K(),o({success:!0,watching:p.size}),!0}if(t.type==="GET_ELEMENT_STATUS"){const n=z();return o({site:l,url:window.location.href,elements:n}),!0}if(t.type==="PING")return o({site:l,url:window.location.href}),!0;if(t.type==="WS_COMMAND")return console.log("[Arbflow] Content received WS_COMMAND:",t),window.postMessage({type:"ARBFLOW_WS_COMMAND",command:t.command,url:t.url,id:t.id,options:t.options,data:t.data},"*"),o({success:!0}),!0;if(t.type==="HTTP_COMMAND")return console.log("[Arbflow] Content received HTTP_COMMAND:",t),window.postMessage({type:"ARBFLOW_HTTP_COMMAND",command:t.command,url:t.url,id:t.id,options:t.options},"*"),o({success:!0}),!0;if(t.type==="EXECUTE_TRADE_STEP")return console.log("[Arbflow] Content received EXECUTE_TRADE_STEP:",t),nt(t.step).then(n=>{o({success:!0,result:n})}).catch(n=>{console.error("[Arbflow] Step execution error:",n),o({success:!1,error:n.message})}),!0;if(t.type==="CHECK_ELEMENT"){const n=document.querySelector(t.selector);return o({exists:!!n,visible:n?n.offsetParent!==null:!1,text:(r=n==null?void 0:n.textContent)==null?void 0:r.trim().slice(0,100)}),!0}if(t.type==="GET_TRADE_STATE"){const n=Q(t.platform);return o(n),!0}return t.type==="TRADE"?(console.log("[Arbflow] Content received TRADE:",t),window.postMessage({type:"ARBFLOW_TRADE",exchangeId:t.exchangeId,params:t.params},"*"),o({success:!0}),!0):!1});function Q(t){if(t==="LG"){const e=document.querySelector(".relative.flex.h-8.shrink-0.rounded-sm"),o=e==null?void 0:e.querySelector("div.absolute"),n=((o==null?void 0:o.className)||"").split(/\s+/),s=n.some(c=>c==="left-0.5"||c.startsWith("border-green")),u=n.some(c=>c==="left-1/2"||c.startsWith("border-red")),i=document.querySelector('[data-testid="place-order-size-input"]'),a=(i==null?void 0:i.value)||"";return{direction:s?"long":u?"short":null,size:a}}if(t==="OM"){const e=document.querySelector('span[role="switch"]'),o=e==null?void 0:e.querySelector("button:first-child"),r=e==null?void 0:e.querySelector("button:nth-child(2)"),n=o==null?void 0:o.hasAttribute("disabled"),s=r==null?void 0:r.hasAttribute("disabled"),u=document.querySelector('[data-testid="quantity-input"]'),i=(u==null?void 0:u.value)||"";return{direction:n?"long":s?"short":null,size:i}}return{direction:null,size:""}}l&&chrome.runtime.sendMessage({type:"CONTENT_SCRIPT_READY",site:l,url:window.location.href}).catch(()=>{});const f=t=>parseFloat((t==null?void 0:t.replace(/[$,<>]/g,"").trim())||"0")||0,Z={omni:t=>{var C,T,x,M,O,P,_,L,D,q,N,U,F;const e=t.querySelectorAll(":scope > div");if(e.length<8)return null;const o=(C=e[0])==null?void 0:C.querySelector(".link-instrument span"),r=((T=o==null?void 0:o.textContent)==null?void 0:T.trim().replace("-PERP",""))||"",n=((M=(x=e[1])==null?void 0:x.textContent)==null?void 0:M.trim())||"0",s=f(n),u=s>=0?"long":"short",i=f((O=e[2])==null?void 0:O.textContent),a=f((P=e[3])==null?void 0:P.textContent),c=f((_=e[4])==null?void 0:_.textContent),d=(D=(L=e[5])==null?void 0:L.textContent)==null?void 0:D.trim(),E=d==="-"?null:f(d),w=((N=(q=e[6])==null?void 0:q.textContent)==null?void 0:N.trim())||"",m=f(w),h=((F=(U=e[7])==null?void 0:U.textContent)==null?void 0:F.trim())||"",A=h.match(/([+-]?\$?[\d.,]+)\s*\(([^)]+)\)/);let g=0,S=0;return A&&(g=f(A[1]),h.startsWith("-")&&(g=-Math.abs(g)),S=parseFloat(A[2].replace(/[%,]/g,""))||0),{symbol:r,position:Math.abs(s),side:u,avgEntryPrice:c,markPrice:i,positionValue:a,unrealizedPnl:g,unrealizedPnlPercent:S,funding:m,liquidationPrice:E}}};let I=null,k="";function tt(){if(!l)return null;const t=y(l);if(!t||t.positionUpdater.source!=="ui")return null;const{uiParser:e}=t.positionUpdater,o=Z[l];if(!o)return null;const r=document.querySelector(e.tableSelector);if(!r)return null;const n=r.querySelectorAll(e.rowSelector),s=[];return n.forEach(u=>{const i=o(u);i&&i.symbol&&s.push(i)}),s}function W(){if(!l)return;const t=y(l);if(!t||t.positionUpdater.source!=="ui")return;const e=tt();if(!e)return;const o=JSON.stringify(e);o!==k&&(k=o,console.log("[Arbflow] ðŸ“Š DOM Positions:",e),chrome.runtime.sendMessage({type:"POSITIONS",target:"sidepanel",site:l,exchange:t.abbreviation,positions:e,isFullUpdate:!0,timestamp:Date.now()}).catch(()=>{}))}function et(){if(!l)return;const t=y(l);if(!t||t.positionUpdater.source!=="ui")return;const{uiParser:e}=t.positionUpdater,o=()=>{const r=document.querySelector(e.tableSelector);if(!r){setTimeout(o,1e3);return}console.log("[Arbflow] ðŸ“Š Found positions table, starting observer"),W(),I=new MutationObserver(()=>{W()}),I.observe(r,{childList:!0,subtree:!0,characterData:!0})};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",o):o()}if(l){const t=y(l);(t==null?void 0:t.positionUpdater.source)==="ui"&&et()}let R=null,v={portfolioValue:null,leverage:null};function j(){var r,n,s;let t=null,e=null;const o=document.querySelector(".account-details");if(o){const u=o.querySelectorAll(".flex.justify-between");for(const i of u){const a=(n=(r=i.querySelector("span"))==null?void 0:r.textContent)==null?void 0:n.trim();if(a==="Portfolio Value"){const c=i.querySelector("span.text-blackwhite, span.text-green, span.text-red");if(c!=null&&c.textContent){const d=c.textContent.match(/\$?([\d,]+\.?\d*)/);d&&(t=parseFloat(d[1].replace(/,/g,"")))}}else if(a==="Portfolio Leverage"){const c=i.querySelector("span.text-blackwhite");if(c!=null&&c.textContent){const d=c.textContent.match(/([\d.]+)x/);d&&(e=parseFloat(d[1]))}}}}if(t===null){const u=document.querySelectorAll("span");for(const i of u)if(((s=i.textContent)==null?void 0:s.trim())==="Portfolio"){const a=i.closest(".flex.flex-col");if(a){const c=a.querySelector(".tabular-nums");if(c!=null&&c.textContent){const d=c.textContent.match(/\$?([\d,]+\.?\d*)/);if(d){t=parseFloat(d[1].replace(/,/g,""));break}}}}}return{portfolioValue:t,leverage:e}}function V(){if(l!=="omni")return;const t=j();t.portfolioValue===v.portfolioValue&&t.leverage===v.leverage||(v=t,console.log("[Arbflow] ðŸ’° Account info:",t),chrome.runtime.sendMessage({type:"ACCOUNT_INFO",target:"sidepanel",site:l,exchange:"OM",portfolioValue:t.portfolioValue,leverage:t.leverage,timestamp:Date.now()}).catch(()=>{}))}function ot(){if(l!=="omni")return;const t=()=>{if(j().portfolioValue===null){setTimeout(t,1e3);return}console.log("[Arbflow] ðŸ’° Found account info, starting observer"),V(),R=new MutationObserver(()=>{V()}),R.observe(document.body,{childList:!0,subtree:!0,characterData:!0})};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t):t()}l==="omni"&&ot();async function nt(t){const{type:e,selector:o,value:r,waitAfter:n=0}=t,s=(a,c=3e3)=>new Promise((d,E)=>{const w=document.querySelector(a);if(w){d(w);return}const m=new MutationObserver(()=>{const h=document.querySelector(a);h&&(m.disconnect(),d(h))});m.observe(document.body,{childList:!0,subtree:!0}),setTimeout(()=>{m.disconnect(),E(new Error(`Element not found: ${a}`))},c)}),u=a=>new Promise(c=>setTimeout(c,a));console.log(`[Arbflow] Executing step: ${e} on ${o}`);const i=await s(o);switch(e){case"click":i.click();break;case"clear_and_type":i.focus(),i.value="",i.dispatchEvent(new Event("input",{bubbles:!0})),await u(50),i.value=r||"",i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0}));break;case"type":i.focus(),i.value=r||"",i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0}));break;default:throw new Error(`Unknown step type: ${e}`)}return n>0&&await u(n),{success:!0,selector:o,type:e}}
